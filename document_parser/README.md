# Document Parser Service

Сервис для обработки и анализа документов с модульной архитектурой.

## Структура проекта

```
document_parser/
├── core/                    # Основная конфигурация
│   └── config.py           # Настройки приложения
├── models/                  # Модели данных
│   └── data_models.py      # Dataclass модели
├── database/               # Работа с базой данных
│   ├── __init__.py
│   └── connection.py       # Подключения к БД
├── services/               # Бизнес-логика
│   ├── __init__.py
│   ├── norm_control_service.py  # Сервис проверки нормоконтроля
│   └── hierarchical_check_service.py  # Сервис иерархической проверки
├── utils/                  # Утилиты
│   ├── __init__.py
│   ├── memory_utils.py     # Работа с памятью
│   └── file_utils.py       # Работа с файлами
├── app.py                  # Основное приложение
├── Dockerfile              # Docker конфигурация
└── requirements.txt        # Зависимости
```

## Модули

### Core
- **config.py** - Централизованная конфигурация приложения
  - Настройки базы данных (PostgreSQL, Qdrant, Redis)
  - Параметры сервисов
  - Лимиты и таймауты
  - Настройки логирования и памяти

### Models
- **data_models.py** - Модели данных с использованием dataclass
  - Enum для статусов и типов
  - Модели для документов, результатов проверки, нарушений
  - Типизированные структуры данных

### Database
- **connection.py** - Управление подключениями к базам данных
  - Класс DatabaseConnection для PostgreSQL и Qdrant
  - Контекстные менеджеры для транзакций
  - Автоматическое переподключение и обработка ошибок

### Services
- **norm_control_service.py** - Бизнес-логика проверки нормоконтроля
  - Асинхронная обработка документов
  - Разбиение на страницы
  - Сохранение результатов в БД
- **hierarchical_check_service.py** - Сервис иерархической проверки документов
  - Трехэтапная проверка: первая страница → нормы → разделы
  - Извлечение информации о проекте
  - Анализ соответствия нормам по стадии проектирования
  - Организация проверки по разделам документа

### Utils
- **memory_utils.py** - Утилиты для работы с памятью
  - Мониторинг использования памяти
  - Очистка памяти
  - Проверка давления на память

- **file_utils.py** - Утилиты для работы с файлами
  - Вычисление хешей
  - Создание временных файлов
  - Валидация файлов

## Основные возможности

### Иерархическая проверка документов
- **Этап 1**: Быстрая проверка первой страницы и получение общей информации о проекте
- **Этап 2**: Проверка всего документа на соответствие нормам согласно стадии проектирования
- **Этап 3**: Выявление разделов документации и организация проверки по разделам

### Асинхронная обработка
- Неблокирующая обработка документов
- Автоматическое обновление статусов
- Graceful shutdown

### Мониторинг и логирование
- Детальное логирование всех операций
- Метрики использования ресурсов
- Health check endpoints

### Надежность
- Автоматическое переподключение к БД
- Обработка ошибок на всех уровнях
- Транзакционная безопасность

## API Endpoints

### Health Check
```
GET /health
```

### Metrics
```
GET /metrics
```

### Norm Control Check
```
POST /checkable-documents/{document_id}/check
```

### Hierarchical Document Check
```
POST /checkable-documents/{document_id}/hierarchical-check
```

## Запуск

### Docker
```bash
docker-compose up document-parser
```

### Локально
```bash
cd document_parser
pip install -r requirements.txt
python -m uvicorn app:app --host 0.0.0.0 --port 8001
```

## Конфигурация

Все настройки находятся в `core/config.py` и могут быть переопределены через переменные окружения:

- `POSTGRES_HOST` - хост PostgreSQL
- `POSTGRES_DB` - база данных
- `POSTGRES_USER` - пользователь
- `POSTGRES_PASSWORD` - пароль
- `QDRANT_HOST` - хост Qdrant
- `LOG_LEVEL` - уровень логирования

## Преимущества новой архитектуры

1. **Модульность** - четкое разделение ответственности
2. **Тестируемость** - изолированные компоненты
3. **Масштабируемость** - легко добавлять новые модули
4. **Читаемость** - понятная структура кода
5. **Поддерживаемость** - простое внесение изменений
