# ะััะตั ะฟะพ ะธะฝัะตะณัะฐัะธะธ Keycloak ั PostgreSQL

## ๐ฏ ะฆะตะปั
ะะตะฐะปะธะทะพะฒะฐัั ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัั ะฐััะตะฝัะธัะธะบะฐัะธั ะธ ะฐะฒัะพัะธะทะฐัะธั ะดะปั ัะธััะตะผั AI-NK ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Keycloak ะธ JWT ัะพะบะตะฝะพะฒ ะดะปั ะดะพัััะฟะฐ ะบ PostgreSQL.

## โ ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. **Keycloak Middleware ะดะปั Gateway**
- **ะคะฐะนะป**: `gateway/keycloak_middleware.py`
- **ะคัะฝะบัะธะธ**:
  - ะะฐะณััะทะบะฐ ะฟัะฑะปะธัะฝะพะณะพ ะบะปััะฐ ะธะท Keycloak
  - ะัะพะฒะตัะบะฐ JWT ัะพะบะตะฝะพะฒ
  - ะะทะฒะปะตัะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต
  - ะัะพะฒะตัะบะฐ ัะพะปะตะน ะฟะพะปัะทะพะฒะฐัะตะปั

### 2. **PostgreSQL JWT ััะฝะบัะธะธ**
- **ะคะฐะนะป**: `sql/configure_keycloak_auth.sql`
- **ะคัะฝะบัะธะธ**:
  - `verify_jwt_token(token)` - ะฟัะพะฒะตัะบะฐ JWT ัะพะบะตะฝะพะฒ
  - `get_user_from_jwt()` - ะฟะพะปััะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะธะท ัะพะบะตะฝะฐ
  - `check_user_role(role)` - ะฟัะพะฒะตัะบะฐ ัะพะปะตะน ะฟะพะปัะทะพะฒะฐัะตะปั
  - `current_user_from_jwt()` - ะฟะพะปััะตะฝะธะต ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั

### 3. **ะะฑะฝะพะฒะปะตะฝะฝัะน Gateway**
- **ะคะฐะนะป**: `gateway/app.py`
- **ะะทะผะตะฝะตะฝะธั**:
  - ะะฝัะตะณัะฐัะธั ั Keycloak middleware
  - ะะพะดะดะตัะถะบะฐ JWT ัะพะบะตะฝะพะฒ ะพั Keycloak
  - Fallback ะฝะฐ ะฟัะพัััะต ัะพะบะตะฝั ะดะปั ัะพะฒะผะตััะธะผะพััะธ

### 4. **ะะพะฝัะธะณััะฐัะธั PgBouncer**
- **ะคะฐะนะปั**: 
  - `configs/pgbouncer/pgbouncer.ini`
  - `configs/pgbouncer/userlist.txt`
- **ะะฐัััะพะนะบะธ**: Connection pooling ะดะปั PostgreSQL

## ๐ง ะขะตัะฝะธัะตัะบะฐั ะฐััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ    JWT Token    โโโโโโโโโโโโโโโ    SQL Queries    โโโโโโโโโโโโโโโ
โ   Frontend  โ โโโโโโโโโโโโโโโบ โ   Gateway   โ โโโโโโโโโโโโโโโบ โ PostgreSQL  โ
โ             โ                 โ             โ                 โ             โ
โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ
                                       โ                               โ
                                       โ JWT Verification              โ JWT Functions
                                       โผ                               โผ
                               โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ
                               โ  Keycloak   โ                 โ   JWT Auth  โ
                               โ Middleware  โ                 โ  Functions  โ
                               โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ
                                       โ
                                       โ Public Key
                                       โผ
                               โโโโโโโโโโโโโโโ
                               โ  Keycloak   โ
                               โ   Server    โ
                               โโโโโโโโโโโโโโโ
```

## ๐งช ะะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั

### โ ะฃัะฟะตัะฝัะต ัะตััั:
1. **ะะพะปััะตะฝะธะต JWT ัะพะบะตะฝะฐ ะพั Keycloak** โ
2. **ะะตะบะพะดะธัะพะฒะฐะฝะธะต JWT ัะพะบะตะฝะฐ** โ
3. **ะะพัััะฟ ะบ API ัะตัะตะท Gateway ั JWT** โ
4. **ะะพะดะบะปััะตะฝะธะต ะบ PostgreSQL ัะตัะตะท JWT** โ
5. **ะขะตััะธัะพะฒะฐะฝะธะต ัะฐะทะปะธัะฝัั ัะพะปะตะน ะฟะพะปัะทะพะฒะฐัะตะปะตะน** โ

### ๐ ะกัะฐัะธััะธะบะฐ ัะตััะธัะพะฒะฐะฝะธั:
- **ะะพะปัะทะพะฒะฐัะตะปั admin**: ัะพะปั `admin`, ะฟะพะปะฝัะน ะดะพัััะฟ โ
- **ะะพะปัะทะพะฒะฐัะตะปั user**: ัะพะปั `user`, ะฑะฐะทะพะฒัะน ะดะพัััะฟ โ
- **JWT ัะพะบะตะฝ**: ะฒัะตะผั ะถะธะทะฝะธ 300 ัะตะบัะฝะด โ
- **API ะดะพัััะฟ**: ะฒัะต ัะฝะดะฟะพะธะฝัั ัะฐะฑะพัะฐัั โ

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะผะตัั:
1. **JWT ัะพะบะตะฝั** ั ะฟะพะดะฟะธััั RSA
2. **ะัะพะฒะตัะบะฐ issuer** (Keycloak realm)
3. **ะัะพะฒะตัะบะฐ audience** (ะบะปะธะตะฝั)
4. **ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะถะธะทะฝะธ** ัะพะบะตะฝะฐ
5. **Row Level Security** ะฒ PostgreSQL
6. **ะะพะปะธ ะธ ะฟะพะปะธัะธะบะธ** ะดะพัััะฟะฐ

### ะะพะปะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน:
- **admin**: ะฟะพะปะฝัะน ะดะพัััะฟ ะบะพ ะฒัะตะผ ะดะฐะฝะฝัะผ
- **user**: ะฑะฐะทะพะฒัะน ะดะพัััะฟ ะดะปั ััะตะฝะธั

## ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### Connection Pooling:
- **PgBouncer**: 20 ัะพะตะดะธะฝะตะฝะธะน ะฟะพ ัะผะพะปัะฐะฝะธั
- **ะะฐะบัะธะผัะผ**: 1000 ะบะปะธะตะฝััะบะธั ัะพะตะดะธะฝะตะฝะธะน
- **ะะตะทะตัะฒ**: 5 ัะพะตะดะธะฝะตะฝะธะน ะดะปั ะฟะธะบะพะฒัั ะฝะฐะณััะทะพะบ

### ะะพะณะธัะพะฒะฐะฝะธะต:
- **PostgreSQL**: ะดะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ั IP-ะฐะดัะตัะฐะผะธ ะบะปะธะตะฝัะพะฒ
- **Gateway**: ะปะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั JWT ะพะฟะตัะฐัะธะน
- **Keycloak**: ััะฐะฝะดะฐััะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะฐััะตะฝัะธัะธะบะฐัะธะธ

## ๐ ะะพัะพะฒะฝะพััั ะบ ะฟัะพะดะฐะบัะตะฝั

### โ ะะพัะพะฒะพ:
- ะะฐะทะพะฒะฐั ะฐััะตะฝัะธัะธะบะฐัะธั ัะตัะตะท Keycloak
- JWT ัะพะบะตะฝั ั ะฟัะพะฒะตัะบะพะน ะฟะพะดะฟะธัะธ
- Connection pooling
- ะะพะปะธ ะธ ะฐะฒัะพัะธะทะฐัะธั
- ะะพะณะธัะพะฒะฐะฝะธะต ะธ ะผะพะฝะธัะพัะธะฝะณ

### โ๏ธ ะขัะตะฑัะตั ะดะพัะฐะฑะพัะบะธ:
- ะะพะปะฝะฐั ะฟัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะธ JWT ะฒ PostgreSQL
- ะะพะปะตะต ะดะตัะฐะปัะฝัะต ะฟะพะปะธัะธะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ
- ะะฝัะตะณัะฐัะธั ั ััะพะฝัะตะฝะดะพะผ
- ะฃะฟัะฐะฒะปะตะฝะธะต ัะตััะธัะผะธ

## ๐ ะะฝััััะบัะธะธ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะพะปััะตะฝะธะต ัะพะบะตะฝะฐ:
```bash
curl -k -X POST "https://localhost:8081/realms/ai-nk/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password&client_id=ai-nk-frontend&username=admin&password=admin"
```

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ:
```bash
curl -k -H "Authorization: Bearer <JWT_TOKEN>" "https://localhost/api/documents"
```

### ะขะตััะธัะพะฒะฐะฝะธะต:
```bash
python3 test_keycloak_auth.py
```

## ๐ ะะฐะบะปััะตะฝะธะต

ะะฝัะตะณัะฐัะธั Keycloak ั PostgreSQL ััะฟะตัะฝะพ ัะตะฐะปะธะทะพะฒะฐะฝะฐ! ะกะธััะตะผะฐ ัะตะฟะตัั ะฟะพะดะดะตัะถะธะฒะฐะตั:

1. **ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัั ะฐััะตะฝัะธัะธะบะฐัะธั** ัะตัะตะท Keycloak
2. **JWT ัะพะบะตะฝั** ะดะปั ะฑะตะทะพะฟะฐัะฝะพะณะพ ะดะพัััะฟะฐ
3. **Connection pooling** ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
4. **ะะพะปะธ ะธ ะฐะฒัะพัะธะทะฐัะธั** ะฝะฐ ััะพะฒะฝะต ะฑะฐะทั ะดะฐะฝะฝัั
5. **ะะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต** ะฒัะตั ะพะฟะตัะฐัะธะน

ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะดะปั ะดะฐะปัะฝะตะนัะตะณะพ ัะฐะทะฒะธัะธั ะธ ะธะฝัะตะณัะฐัะธะธ ั ััะพะฝัะตะฝะดะพะผ!
