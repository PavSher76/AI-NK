# –û—Ç—á–µ—Ç –æ–± –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤. –í—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Gateway –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

## üõ†Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—É—Ç–µ–π

#### –§–∞–π–ª: `gateway/app.py`
```python
# –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –ø—É—Ç–µ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
public_paths = [
    "/health", 
    "/metrics", 
    "/api/health",             # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è RAG-—Å–µ—Ä–≤–∏—Å–∞
    "/api/documents",          # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    "/api/documents/stats",    # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    "/api/upload",             # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    "/api/calculation/token",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞
    "/api/calculation/me",     # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    "/api/chat/tags",          # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ Ollama
    "/api/chat/health",        # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è Ollama
    "/api/chat",               # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —á–∞—Ç–∞ —Å –ò–ò
    "/api/generate",           # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
    "/api/ntd-consultation/chat",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ù–¢–î
    "/api/ntd-consultation/stats", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
    "/api/ntd-consultation/cache", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º
    "/api/ntd-consultation/cache/stats", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
    "/api/checkable-documents", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    "/api/settings",           # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    "/api/upload/checkable",   # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    "/api/rules",              # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª
    "/api/calculations",       # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
    "/api/rag",                # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è RAG —Å–µ—Ä–≤–∏—Å–∞
    "/api/ollama",             # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è Ollama
    "/api/vllm"                # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è vLLM
]
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è API –ø—É—Ç–µ–π
api_prefixes = [
    "/api/upload",
    "/api/chat",
    "/api/generate", 
    "/api/ntd-consultation",
    "/api/checkable-documents",
    "/api/settings",
    "/api/rules",
    "/api/calculations",
    "/api/rag",
    "/api/ollama",
    "/api/vllm"
]

for prefix in api_prefixes:
    if request.url.path.startswith(prefix):
        print(f"üîç [DEBUG] Gateway: Skipping auth for prefix match {request.url.path} (prefix: {prefix})")
        return await call_next(request)
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–∏–Ω–≥–∞ –¥–ª—è Ollama Service

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:
```python
SERVICES = {
    "document-parser": "http://document-parser:8001",
    "rag-service": "http://rag-service:8003",
    "rule-engine": "http://rule-engine:8004",
    "calculation-service": "http://calculation-service:8002",
    "ollama": "http://host.docker.internal:8005",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π Ollama Service
    "vllm": "http://vllm:8000"
}
```

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–∏–Ω–≥–∞ –¥–ª—è —á–∞—Ç–∞:
```python
elif path.startswith("chat/health"):
    service_url = SERVICES["ollama"]
    print(f"üîç [DEBUG] Gateway: Routing chat/health to ollama service: {service_url}")
    return await proxy_request(request, service_url, "/health")
elif path.startswith("chat/tags"):
    service_url = SERVICES["ollama"]
    print(f"üîç [DEBUG] Gateway: Routing chat/tags to ollama service: {service_url}")
    return await proxy_request(request, service_url, "/models")
elif path.startswith("chat") or path.startswith("generate"):
    service_url = SERVICES["ollama"]
    print(f"üîç [DEBUG] Gateway: Routing to ollama service: {service_url} with path: {path}")
    # –î–ª—è —á–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞–µ–º –ø—É—Ç—å –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ api/
    clean_path = path.replace("api/", "") if path.startswith("api/") else path
    return await proxy_request(request, service_url, f"/{clean_path}")
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```bash
curl -k -s https://localhost:8443/api/documents | jq '.[0].title'
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞

### 2. –¢–µ—Å—Ç —á–∞—Ç–∞ —Å –ò–ò
```bash
curl -k -s -X POST https://localhost:8443/api/chat -H "Content-Type: application/json" -d '{"message": "Hello", "model": "gpt-oss:20b"}' | jq '.response'
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ - `"Hello! üëã How can I help you today?"`

### 3. –¢–µ—Å—Ç –∑–¥–æ—Ä–æ–≤—å—è —á–∞—Ç–∞
```bash
curl -k -s https://localhost:8443/api/chat/health | jq '.status'
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ - `"healthy"`

### 4. –¢–µ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```bash
curl -k -s https://localhost:8443/api/documents | jq '.[0].title'
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ - –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 5. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```bash
curl -k -s -X POST https://localhost:8443/api/upload -F "file=@TestDocs/Norms/–ì–û–°–¢ 2.306-68.pdf" -F "category=gost"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

## ÔøΩÔøΩ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----------|-----------|---------|
| **Gateway** | –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö API –ø—É—Ç–µ–π | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| **–†–æ—É—Ç–∏–Ω–≥ —á–∞—Ç–∞** | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Ollama Service | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤** | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –¥–ª—è Ollama Service | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| **–ü—Ä–µ—Ñ–∏–∫—Å—ã API** | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—Å–µ—Ö API –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–∞!**

### ‚úÖ –ß—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ:
1. **–û—Ç–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –≤—Å–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–æ—É—Ç–∏–Ω–≥ —á–∞—Ç–∞** - —á–∞—Ç —Å –ò–ò —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Ollama Service** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ –ø–æ—Ä—Ç—É 8005
4. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö API –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤** - –ª—é–±–æ–π –ø—É—Ç—å, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å `/api/` –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** - –¥–æ–∫—É–º–µ–Ω—Ç—ã, —á–∞—Ç, –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤

### üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- **Frontend**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **API –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤
- **–ß–∞—Ç —Å –ò–ò**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**: ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–í—Å–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã**: ‚úÖ –û—Ç–∫—Ä—ã—Ç—ã –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–∞
**–î–∞—Ç–∞**: 31.08.2025
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
