# –û—Ç—á–µ—Ç –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Ollama

## üéØ **–¶–µ–ª—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã LLM –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

## ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

### üîß **1. –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏**

**–§–∞–π–ª:** `Modelfile.optimized`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```modelfile
FROM llama3.1:8b

# –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
PARAMETER num_ctx 16384

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞
PARAMETER num_batch 1024

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è (–Ω–∏–∑–∫–∞—è –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
PARAMETER temperature 0.1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ top_p –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
PARAMETER top_p 0.9

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ top_k –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
PARAMETER top_k 40

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è
SYSTEM """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.
–û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.
"""
```

### üîß **2. –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**

**–§–∞–π–ª:** `docker-compose.yaml`

**Ollama (—É–≤–µ–ª–∏—á–µ–Ω—ã —Ä–µ—Å—É—Ä—Å—ã):**
```yaml
ollama:
  deploy:
    resources:
      limits:
        memory: 8G  # +2G
        cpus: '4.0' # +4 CPU
      reservations:
        memory: 6G  # +2G
        cpus: '2.0' # +2 CPU
  environment:
    - OLLAMA_NUM_CTX=16384
    - OLLAMA_FLASH_ATTN=1
    - OLLAMA_NUM_BATCH=1024
    - OLLAMA_NUM_THREAD=8
    - OLLAMA_TEMPERATURE=0.1
```

**VLLM (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ä–µ—Å—É—Ä—Å—ã):**
```yaml
vllm:
  deploy:
    resources:
      limits:
        memory: 1G   # -0.5G
        cpus: '1.0'  # +1 CPU
      reservations:
        memory: 512M # -0.5G
        cpus: '0.5'  # +0.5 CPU
  environment:
    - OLLAMA_CPU_THREADS=2  # -2 threads
```

**Document-parser (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ä–µ—Å—É—Ä—Å—ã):**
```yaml
document-parser:
  deploy:
    resources:
      limits:
        memory: 2G   # -1G
        cpus: '2.0'  # +2 CPU
      reservations:
        memory: 1.5G # -0.5G
        cpus: '1.0'  # +1 CPU
```

### üîß **3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ document-parser**

**–§–∞–π–ª:** `document_parser/main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ `llama3.1-optimized:latest`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ fallback –º–æ–¥–µ–ª–∏ –≤ API endpoints

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

### ‚úÖ **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
llama_context: n_ctx_per_seq = 4096
llama_context: n_batch = 512
llama_context: CPU compute buffer size = 296.01 MiB
llama_context: n_ctx_per_seq (4096) < n_ctx_train (131072)
```

### ‚úÖ **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
llama_context: n_ctx_per_seq = 16384
llama_context: n_batch = 1024
llama_context: CPU compute buffer size = 1088.01 MiB
llama_context: n_ctx_per_seq (16384) < n_ctx_train (131072)
```

### üìà **–£–ª—É—á—à–µ–Ω–∏—è:**

1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** 4x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (4,096 ‚Üí 16,384 —Ç–æ–∫–µ–Ω–æ–≤)
2. **–ë–∞—Ç—á:** 2x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (512 ‚Üí 1,024)
3. **Compute buffer:** 3.7x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (296 ‚Üí 1,088 MiB)
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞:** 12.5% ‚Üí 50% –æ—Ç –æ–±—É—á–∞—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## üéØ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏**

### ‚úÖ **–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
```bash
curl -X POST "http://localhost:11434/api/generate" \
  -H "Content-Type: application/json" \
  -d '{"model": "llama3.1-optimized:latest", "prompt": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?", "stream": false}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "response": "–ü—Ä–∏–≤–µ—Ç! –£ –º–µ–Ω—è –≤—Å–µ —Ö–æ—Ä–æ—à–æ. –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ –ø–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. –ö–∞–∫–∞—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å —É –≤–∞—Å –µ—Å—Ç—å?"
}
```

### ‚úÖ **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å–µ–±—è –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é
- ‚úÖ –ì–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
- ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω –æ—Ç–≤–µ—Ç–æ–≤

## üìä **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**

### ‚úÖ **–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CPU:**
- **Ollama:** 4 CPU (50%)
- **Document-parser:** 2 CPU (25%)
- **VLLM:** 1 CPU (12.5%)
- **–û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:** 1 CPU (12.5%)

### ‚úÖ **–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏:**
- **Ollama:** 8GB (50%)
- **RAG-service:** 6GB (37.5%)
- **Document-parser:** 2GB (12.5%)

## üéØ **–û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è**

### ‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞:**
1. **–õ—É—á—à–µ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ** –¥–ª–∏–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (4x –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
2. **–ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ** –æ—Ç–≤–µ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º

### ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. **–ë—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞** –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤
3. **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

### ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
1. **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫** —É–≤–µ–ª–∏—á–µ–Ω–∏—é –Ω–∞–≥—Ä—É–∑–∫–∏
2. **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤
3. **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–π** –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üîß **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞**

### ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ CPU
- –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ **–õ–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
```bash
# –õ–æ–≥–∏ Ollama
docker-compose logs ollama

# –õ–æ–≥–∏ document-parser
docker-compose logs document-parser

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats
```

## üìà **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

### ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:**

1. **‚úÖ –°–æ–∑–¥–∞–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å** —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
2. **‚úÖ –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ä–µ—Å—É—Ä—Å—ã** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
3. **‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–∏—Å—ã** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
4. **‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞** —Å–∏—Å—Ç–µ–º—ã

### üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ **4x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ** –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏
- ‚úÖ **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç** –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è
- ‚úÖ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫** –≤—ã—Å–æ–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º

### üìä **–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:**
**‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê - –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–û–ô –†–ê–ë–û–¢–ï**

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —É–ª—É—á—à–µ–Ω–∏–π.
