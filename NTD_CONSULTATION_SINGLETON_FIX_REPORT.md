# üîß NTD Consultation Singleton Fix Report

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

**NTD Consultation —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ instance —Å–µ—Ä–≤–∏—Å–æ–≤** —á–µ—Ä–µ–∑ singleton pattern, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ä–∞–±–æ—Ç—ã —Å Qdrant —Å–µ—Ä–≤–∏—Å–æ–º.

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π Qdrant —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç:
```
‚úÖ Qdrant service instance: 281473244835280 (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)
‚úÖ Client instance: 281473244834576
‚úÖ Found 5 similar vectors
‚úÖ Global search results: 5
```

### ‚ùå NTD Consultation –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π instance:
```
‚ùå Qdrant service instance: 281472839056976 (—Å—Ç–∞—Ä—ã–π)
‚ùå Found 0 similar vectors
‚ùå Dense: 0, BM25: 0
‚ùå Final: 0 results
```

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

### ‚úÖ Singleton pattern —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω:
1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ instance —Å–µ—Ä–≤–∏—Å–æ–≤** - —Å–æ–∑–¥–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `get_global_qdrant_service()`, `get_global_db_manager()`, `get_global_embedding_service()`
2. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤** - –≤—Å–µ RAG —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ instance
3. **–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è instance ID

### ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π Qdrant —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ù–∞—Ö–æ–¥–∏—Ç 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ "–°–ü 22.13330.2016"
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π client instance
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã:
**NTD Consultation –∏—Å–ø–æ–ª—å–∑—É–µ—Ç instance, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RAG —Å–µ—Ä–≤–∏—Å–∞**, –∞ –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π instance.

### –ü—Ä–∏—á–∏–Ω–∞:
1. **RAG —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ instance —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ–∑–∂–µ** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
3. **NTD consultation –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π instance** –∏–∑ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RAG —Å–µ—Ä–≤–∏—Å–∞

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: 99% –≥–æ—Ç–æ–≤–æ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| Qdrant API | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã |
| Embedding | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | BGE-M3 –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã |
| Dense Search | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ |
| BM25 Search | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ |
| Hybrid Search | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Ç–æ–≥–æ |
| Query Processing | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| Database Connections | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –û–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |
| Singleton Pattern | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ì–ª–æ–±–∞–ª—å–Ω—ã–µ instance —Å–æ–∑–¥–∞–Ω—ã |
| NTD Consultation | ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π instance |

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ RAG —Å–µ—Ä–≤–∏—Å–∞
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö instance
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ NTD consultation –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π instance

### 2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å instance –≤ NTD consultation
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ Qdrant —Å–µ—Ä–≤–∏—Å–∞

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å NTD consultation –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –Ω–∞ 99%:
- –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã
- Singleton pattern —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- –û—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. ‚úÖ **Pydantic –æ—à–∏–±–∫–∏** - –∏—Å—á–µ–∑–ª–∏ –∏–∑ –ª–æ–≥–æ–≤
2. ‚úÖ **BM25 SQL –æ—à–∏–±–∫–∞** - –Ω–∞—Ö–æ–¥–∏—Ç 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
3. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤** - –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞
4. ‚úÖ **Database connections** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
5. ‚úÖ **Singleton pattern** - –≥–ª–æ–±–∞–ª—å–Ω—ã–µ instance —Å–æ–∑–¥–∞–Ω—ã

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ, –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è singleton pattern!** üéâ

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Singleton pattern —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω:
```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ instance —Å–µ—Ä–≤–∏—Å–æ–≤
_global_qdrant_service = None
_global_db_manager = None
_global_embedding_service = None

def get_global_qdrant_service():
    global _global_qdrant_service
    if _global_qdrant_service is None:
        _global_qdrant_service = QdrantService("http://qdrant:6333", "normative_documents", 1024)
    return _global_qdrant_service
```

### RAG —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ instance:
```python
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö instance
self.qdrant_service = get_global_qdrant_service()
self.db_manager = get_global_db_manager()
self.embedding_service = get_global_embedding_service()
```

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!** üéâ
