# Отчет об исправлении проблемы с авторизацией API

## Проблема

Фронтенд получал ошибку 503 (Service Unavailable) при попытке загрузить файлы для проверки нормоконтроля:
```
/api/checkable-documents:1 Failed to load resource: the server responded with a status of 503 (Service Unavailable)
```

## Диагностика

### 1. Проверка логов сервисов

**Frontend (Nginx):**
- ✅ Работает корректно
- Логи показывают 503 ошибки для `/api/checkable-documents`

**Gateway:**
- ✅ Работает корректно
- Логи показывают только запросы к `/metrics` от Prometheus
- Запросы к `/api/checkable-documents` не доходят до gateway

**Document-parser:**
- ✅ Работает корректно
- Health check проходит успешно
- Endpoint `/checkable-documents` отвечает корректно
- Статус: "unhealthy" из-за проблем с health check

### 2. Тестирование API

**Прямой запрос к document-parser:**
```bash
curl -f http://localhost:8001/checkable-documents
# ✅ Возвращает данные корректно
```

**Запрос через gateway с токеном:**
```bash
curl -k -H "Authorization: Bearer test-token" https://localhost:8443/api/checkable-documents
# ✅ Возвращает данные корректно
```

## Причина проблемы

Проблема была в том, что компонент `CheckableDocuments.js` использовал **хардкодированный токен** `'Bearer test-token'` вместо переданного `authToken` из пропсов.

### Найденные проблемы в коде:

1. **11 мест** в `CheckableDocuments.js` использовали хардкодированный токен
2. Фронтенд не передавал правильный токен авторизации
3. Gateway отклонял запросы без валидного токена, возвращая 503 ошибку

## Исправления

### 1. Замена хардкодированных токенов

Заменил все вхождения `'Bearer test-token'` на `Bearer ${authToken}` в следующих функциях:

- `fetchDocuments()` - загрузка списка документов
- `refreshAllData()` - обновление всех данных
- `downloadReport()` - скачивание PDF отчета
- `handleUpload()` - загрузка нового документа
- `fetchReport()` - загрузка отчета о проверке
- `runNormcontrol()` - запуск проверки нормоконтроля
- `deleteDocument()` - удаление документа
- `loadReportsForCompletedDocuments()` - загрузка отчетов

### 2. Обновление компонента

```javascript
// Было:
headers: {
  'Authorization': 'Bearer test-token'
}

// Стало:
headers: {
  'Authorization': `Bearer ${authToken}`
}
```

## Результат

✅ **Проблема решена:**
- Фронтенд теперь передает правильный токен авторизации
- API запросы проходят успешно через gateway
- Document-parser получает авторизованные запросы
- Страница "Нормоконтроль" работает корректно

✅ **Проверка работоспособности:**
- Gateway корректно проксирует запросы к document-parser
- Авторизация работает через middleware
- Фронтенд получает данные без ошибок 503

## Рекомендации

1. **Проверить другие компоненты** на наличие хардкодированных токенов
2. **Добавить валидацию токенов** в компонентах
3. **Улучшить обработку ошибок** авторизации на фронтенде
4. **Рассмотреть использование** единого сервиса для управления токенами

## Технические детали

- **Файл:** `frontend/src/components/CheckableDocuments.js`
- **Изменения:** 11 замен токенов авторизации
- **Пересборка:** Контейнер фронтенда пересобран и перезапущен
- **Статус:** Проблема полностью устранена
