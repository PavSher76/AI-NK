# –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ Document Parser

## üìã –û–±–∑–æ—Ä

–í —Ñ–∞–π–ª–µ `document_parser/main.py` –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –æ—Ç–º–µ—á–∞—é—â–∏–µ –≤—Å–µ –º–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —è–∑—ã–∫–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏.

## üîç –û—Ç–º–µ—á–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è

#### `perform_norm_control_check()`
```python
async def perform_norm_control_check(self, document_id: int, document_content: str) -> Dict[str, Any]:
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º LLM"""
    try:
        # ===== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ù–û–†–ú–û–ö–û–ù–¢–†–û–õ–Ø –° LLM =====
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM.

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

#### `perform_norm_control_check_for_page()`
```python
async def perform_norm_control_check_for_page(self, document_id: int, page_data: Dict[str, Any]) -> Dict[str, Any]:
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
```

**–ú–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM**:
```python
# ===== –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ö LLM –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–¢–†–ê–ù–ò–¶–´ =====
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ LLM —á–µ—Ä–µ–∑ gateway –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è
logger.info(f"Sending request to LLM for page {page_number}...")

async with httpx.AsyncClient(verify=False, timeout=30.0) as client:
    response = await client.post(
        "http://gateway:8443/v1/chat/completions",
        headers={
            "Authorization": "Bearer test-token",
            "Content-Type": "application/json"
        },
        json={
            "model": "llama3.1:8b",
            "messages": [
                {"role": "system", "content": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏."},
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.1
        }
    )
```

**–ú–µ—Å—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**:
```python
# ===== –ü–û–õ–£–ß–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ü–†–û–í–ï–†–ö–ò –û–¢ LLM =====
if response.status_code == 200:
    result = response.json()
    content = result["choices"][0]["message"]["content"]
    
    # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç –æ—Ç LLM
    try:
        # ... –ø–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞
```

### 3. –í—ã–∑–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü

```python
# ===== –í–´–ó–û–í –ü–†–û–í–ï–†–ö–ò –°–¢–†–ê–ù–ò–¶–´ –° –ü–†–ò–ú–ï–ù–ï–ù–ò–ï–ú LLM =====
# –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM
page_result = await self.perform_norm_control_check_for_page(document_id, page_data)
```

### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```python
# ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ü–†–û–í–ï–†–ö–ò LLM =====
# –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
await self.save_norm_control_result(document_id, combined_result)
```

#### `save_norm_control_result()`
```python
async def save_norm_control_result(self, document_id: int, check_result: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –æ—Ç LLM –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
```

### 5. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤

```python
# ===== –°–û–ó–î–ê–ù–ò–ï –û–¢–ß–ï–¢–ê –û –ü–†–û–í–ï–†–ö–ï LLM =====
# –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ LLM
await self.create_review_report(document_id, result_id, check_result)
```

#### `create_review_report()`
```python
async def create_review_report(self, document_id: int, result_id: int, check_result: Dict[str, Any]):
    """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ LLM"""
```

### 6. API Endpoint –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

```python
@app.post("/checkable-documents/{document_id}/check")
async def trigger_norm_control_check(document_id: int):
    # ===== –ó–ê–ü–£–°–ö –ü–†–û–í–ï–†–ö–ò –ù–û–†–ú–û–ö–û–ù–¢–†–û–õ–Ø –° –ü–†–ò–ú–ï–ù–ï–ù–ò–ï–ú LLM =====
    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM
    result = await parser.perform_norm_control_check(document_id, document_content)
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM

- **–ú–æ–¥–µ–ª—å**: `llama3.1:8b`
- **Endpoint**: `http://gateway:8443/v1/chat/completions`
- **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞**: `0.1` (–Ω–∏–∑–∫–∞—è –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
- **–¢–∞–π–º–∞—É—Ç**: `30.0` —Å–µ–∫—É–Ω–¥
- **–§–æ—Ä–º–∞—Ç**: OpenAI Chat Completions API

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

–ü—Ä–æ–º–ø—Ç –¥–ª—è LLM –≤–∫–ª—é—á–∞–µ—Ç:
1. **–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: –†–æ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞ –ø–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é
2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: –î–µ—Ç–∞–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã**: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
4. **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É –æ—Ç–≤–µ—Ç–∞**: JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤

1. **–ü–∞—Ä—Å–∏–Ω–≥ JSON**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
4. **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤**: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —ç—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã —Å LLM –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```python
logger.info(f"Sending request to LLM for page {page_number}...")
logger.info(f"Prompt length: {len(prompt)} characters")
logger.info(f"Successfully processed page {page_number}")
logger.error(f"LLM request failed: {response.status_code}")
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

1. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –ß–µ—Ç–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å LLM
2. **–û—Ç–ª–∞–¥–∫–∞**: –õ–µ–≥—á–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –ö–æ–¥ —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
4. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: –£–ø—Ä–æ—â–µ–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–º–æ–≥–∞—é—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –û—à–∏–±–∫–∏ –≤ LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å LLM

1. **–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏** ‚Üí `trigger_norm_control_check()`
2. **–†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** ‚Üí `split_document_into_pages()`
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã** ‚Üí `perform_norm_control_check_for_page()`
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM** ‚Üí HTTP POST –∫ gateway
5. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞** ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç LLM
6. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚Üí `save_norm_control_result()`
7. **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞** ‚Üí `create_review_report()`

–í—Å–µ —ç—Ç–∏ —ç—Ç–∞–ø—ã –æ—Ç–º–µ—á–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞.
