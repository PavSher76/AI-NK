# Диаграмма архитектуры модуля "Нормоконтроль - 2"

## 🏗️ Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    НОРМОКОНТРОЛЬ - 2 МОДУЛЬ                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   API Layer     │    │  Service Layer  │    │ Config Layer │ │
│  │                 │    │                 │    │              │ │
│  │ • FastAPI       │    │ • Main Service  │    │ • Settings   │ │
│  │ • REST Endpoints│    │ • Integration   │    │ • Rules      │ │
│  │ • Validation    │    │ • Processing    │    │ • Standards  │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                       │     │
│           └───────────────────────┼───────────────────────┘     │
│                                   │                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                VALIDATORS LAYER                            │ │
│  │                                                             │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │ │
│  │ │   ESKD      │ │    SPDS     │ │ Title Block │ │ Units   │ │ │
│  │ │ Validator   │ │ Validator   │ │ Validator   │ │Validator│ │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │ │
│  │                                                             │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │ │
│  │ │   Fonts     │ │   Scales    │ │ Notations   │            │ │
│  │ │ Validator   │ │ Validator   │ │ Validator   │            │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                   │                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                MODELS LAYER                                │ │
│  │                                                             │ │
│  │ • ValidationResult  • ValidationIssue  • ComplianceStatus │ │
│  │ • DocumentFormat    • IssueSeverity    • TitleBlockInfo   │ │
│  │ • FontInfo         • ScaleInfo        • UnitsInfo        │ │
│  │ • NotationInfo     • DocumentMetadata • ESKDRequirements │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток обработки документа

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Document  │───▶│   Format    │───▶│  Processing │───▶│ Validation  │
│   Upload    │    │ Detection   │    │   Pipeline  │    │   Results   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   File      │    │   PDF/DWG   │    │  Extract    │    │   Issues    │
│   Storage   │    │   /DXF/     │    │  Metadata   │    │  Analysis   │
│             │    │   DOCX/     │    │             │    │             │
│             │    │   XLSX      │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 🔍 Детальная схема валидаторов

```
┌─────────────────────────────────────────────────────────────────┐
│                    ВАЛИДАТОРЫ                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    ESKD VALIDATOR                          │ │
│  │                                                             │ │
│  │ • ГОСТ 21.501-2018 (Чертежи)                               │ │
│  │ • ГОСТ Р 21.101-2020 (Документация)                        │ │
│  │ • ГОСТ 21.1101-2013 (Спецификации)                         │ │
│  │ • ГОСТ 21.201-2011 (Обозначения)                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    SPDS VALIDATOR                          │ │
│  │                                                             │ │
│  │ • СП 48.13330.2019 (Организация строительства)            │ │
│  │ • СП 70.13330.2012 (Конструкции)                          │ │
│  │ • СП 16.13330.2017 (Металлоконструкции)                   │ │
│  │ • СП 20.13330.2016 (Нагрузки)                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                TITLE BLOCK VALIDATOR                       │ │
│  │                                                             │ │
│  │ • Наличие основной надписи                                 │ │
│  │ • Заполнение обязательных полей                            │ │
│  │ • Позиция и размеры                                        │ │
│  │ • Форматы данных                                           │ │
│  │ • Согласованность между листами                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 UNITS VALIDATOR                            │ │
│  │                                                             │ │
│  │ • Метрическая система                                      │ │
│  │ • Стандартные единицы                                      │ │
│  │ • Согласованность единиц                                   │ │
│  │ • Форматы записи                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 FONTS VALIDATOR                            │ │
│  │                                                             │ │
│  │ • Стандартные шрифты                                       │ │
│  │ • Размеры шрифтов                                          │ │
│  │ • Стили и веса                                             │ │
│  │ • Согласованность                                          │ │
│  │ • Контекстная валидация                                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                SCALES VALIDATOR                            │ │
│  │                                                             │ │
│  │ • Стандартные масштабы                                     │ │
│  │ • Форматы записи                                           │ │
│  │ • Позиция масштаба                                         │ │
│  │ • Точность значений                                        │ │
│  │ • Соответствие типу чертежа                                │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │               NOTATIONS VALIDATOR                          │ │
│  │                                                             │ │
│  │ • Стандартные символы                                      │ │
│  │ • Сокращения единиц                                        │ │
│  │ • Ссылки на НТД                                            │ │
│  │ • Полнота обозначений                                      │ │
│  │ • Согласованность                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔌 API Endpoints

```
┌─────────────────────────────────────────────────────────────────┐
│                      API ENDPOINTS                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  POST /normcontrol2/validate                                   │
│  ├─ Валидация документа                                        │
│  ├─ Параметры: file_path, document_id, options                 │
│  └─ Ответ: ValidationResult                                    │
│                                                                 │
│  GET /normcontrol2/validate/{id}/issues                        │
│  ├─ Получение списка проблем                                   │
│  └─ Ответ: List[ValidationIssue]                               │
│                                                                 │
│  GET /normcontrol2/validate/{id}/status                        │
│  ├─ Статус валидации                                           │
│  └─ Ответ: ValidationStatus                                    │
│                                                                 │
│  GET /normcontrol2/validate/{id}/report                        │
│  ├─ Отчет о валидации                                          │
│  └─ Ответ: ValidationReport                                    │
│                                                                 │
│  POST /normcontrol2/batch_validate                             │
│  ├─ Пакетная валидация                                         │
│  └─ Ответ: BatchValidationResult                               │
│                                                                 │
│  GET /normcontrol2/health                                      │
│  ├─ Проверка состояния                                         │
│  └─ Ответ: HealthStatus                                        │
│                                                                 │
│  GET /normcontrol2/rules                                       │
│  ├─ Правила валидации                                          │
│  └─ Ответ: ValidationRules                                     │
│                                                                 │
│  GET /normcontrol2/statistics                                  │
│  ├─ Статистика валидации                                       │
│  └─ Ответ: ValidationStatistics                                │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 Модели данных

```
┌─────────────────────────────────────────────────────────────────┐
│                      DATA MODELS                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ValidationResult                                              │
│  ├─ document_id: str                                           │
│  ├─ document_name: str                                         │
│  ├─ document_format: DocumentFormat                            │
│  ├─ validation_time: datetime                                  │
│  ├─ overall_status: ComplianceStatus                           │
│  ├─ compliance_score: float                                    │
│  ├─ total_issues: int                                          │
│  ├─ issues_by_severity: Dict[str, int]                         │
│  ├─ issues: List[ValidationIssue]                              │
│  ├─ categories: Dict[str, Dict]                                │
│  ├─ recommendations: List[str]                                 │
│  └─ metadata: Dict[str, Any]                                   │
│                                                                 │
│  ValidationIssue                                               │
│  ├─ id: str                                                    │
│  ├─ category: str                                              │
│  ├─ severity: IssueSeverity                                    │
│  ├─ title: str                                                 │
│  ├─ description: str                                           │
│  ├─ recommendation: str                                        │
│  ├─ page_number: Optional[int]                                 │
│  ├─ coordinates: Optional[Dict[str, float]]                    │
│  ├─ rule_reference: Optional[str]                              │
│  └─ metadata: Optional[Dict[str, Any]]                         │
│                                                                 │
│  ComplianceStatus (Enum)                                       │
│  ├─ COMPLIANT                                                  │
│  ├─ COMPLIANT_WITH_WARNINGS                                    │
│  ├─ NON_COMPLIANT                                              │
│  ├─ CRITICAL_ISSUES                                            │
│  └─ NEEDS_REVIEW                                               │
│                                                                 │
│  IssueSeverity (Enum)                                          │
│  ├─ CRITICAL                                                   │
│  ├─ HIGH                                                       │
│  ├─ MEDIUM                                                     │
│  ├─ LOW                                                        │
│  └─ INFO                                                       │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 Конфигурация

```
┌─────────────────────────────────────────────────────────────────┐
│                    CONFIGURATION                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Environment Variables                                         │
│  ├─ NORM2_CRITICAL_THRESHOLD=1                                │
│  ├─ NORM2_HIGH_THRESHOLD=5                                    │
│  ├─ NORM2_MEDIUM_THRESHOLD=10                                 │
│  ├─ NORM2_MAX_FILE_SIZE_MB=100                                │
│  ├─ NORM2_TIMEOUT_SECONDS=300                                 │
│  ├─ NORM2_ESKD_21_501_ENABLED=true                            │
│  ├─ NORM2_SPDS_48_13330_ENABLED=true                          │
│  ├─ NORM2_MIN_FONT_SIZE=2.5                                   │
│  ├─ NORM2_MAX_FONT_SIZE=14.0                                  │
│  ├─ NORM2_ALLOW_CUSTOM_SCALES=false                           │
│  └─ NORM2_METRIC_SYSTEM_REQUIRED=true                         │
│                                                                 │
│  JSON Configuration File                                       │
│  ├─ validation: ValidationConfig                               │
│  ├─ document_processor: DocumentProcessorConfig                │
│  ├─ eskd: ESKDConfig                                           │
│  ├─ spds: SPDSConfig                                           │
│  ├─ fonts: FontConfig                                          │
│  ├─ scales: ScaleConfig                                        │
│  ├─ units: UnitsConfig                                         │
│  └─ notations: NotationsConfig                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Интеграция с основной системой

```
┌─────────────────────────────────────────────────────────────────┐
│                AI-NK MAIN SYSTEM                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  Gateway    │    │ Document    │    │  Frontend   │         │
│  │  Service    │    │ Parser      │    │  Interface  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│           │                   │                   │             │
│           └───────────────────┼───────────────────┘             │
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              NORMCONTROL2 INTEGRATION                      │ │
│  │                                                             │ │
│  │ • validate_document_with_normcontrol2()                    │ │
│  │ • get_normcontrol2_statistics()                            │ │
│  │ • cleanup_normcontrol2_results()                           │ │
│  │ • Auto-save results                                        │ │
│  │ • Notifications                                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                NORMCONTROL2 SERVICE                        │ │
│  │                                                             │ │
│  │ • Main Service                                             │ │
│  │ • Validators                                               │ │
│  │ • API Endpoints                                            │ │
│  │ • Configuration                                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 📈 Поток данных

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Document  │───▶│  Processing │───▶│ Validation  │───▶│   Results   │
│   Input     │    │   Pipeline  │    │   Pipeline  │    │   Output    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   File      │    │   Extract   │    │   Check     │    │   Issues    │
│   Storage   │    │  Metadata   │    │ Standards   │    │  Analysis   │
│             │    │             │    │             │    │             │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Format    │    │  Title      │    │   ESKD      │    │ Compliance  │
│ Detection   │    │ Block       │    │ Validation  │    │   Score     │
│             │    │ Extraction  │    │             │    │             │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   PDF/DWG   │    │  Fonts      │    │   SPDS      │    │  Report     │
│  /DXF/      │    │ Extraction  │    │ Validation  │    │ Generation  │
│  DOCX/XLSX  │    │             │    │             │    │             │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 🎯 Ключевые особенности архитектуры

### 1. Модульность
- Независимые валидаторы
- Легко расширяемая архитектура
- Изолированная обработка ошибок

### 2. Конфигурируемость
- Настройка через переменные окружения
- JSON конфигурационные файлы
- Гибкие правила валидации

### 3. Производительность
- Асинхронная обработка
- Кэширование результатов
- Оптимизированные алгоритмы

### 4. Интеграция
- Готовые API endpoints
- Простая интеграция с основной системой
- Автоматическое сохранение результатов

### 5. Мониторинг
- Подробное логирование
- Статистика валидации
- Отслеживание производительности

---

**Дата создания:** 12 января 2025  
**Версия диаграммы:** 1.0  
**Статус:** ✅ Завершена
