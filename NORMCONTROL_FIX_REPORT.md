# Отчет об исправлении проблемы со страницей Нормоконтроль

## Проблема

На странице "Нормоконтроль" возникала ошибка 503 (Service Unavailable) при попытке загрузить данные.

## Диагностика

### 1. Анализ логов

**Frontend (Nginx):**
- Логи показывали ошибки 503 для `/api/checkable-documents`
- Запросы доходили до фронтенда, но не проходили дальше

**Gateway:**
- Логи показали ошибку подключения: `ConnectError(OSError('All connection attempts failed'))`
- Gateway не мог подключиться к document-parser
- Авторизация работала корректно (JWT токены принимались)

**Document-parser:**
- Контейнер был в состоянии "unhealthy"
- Health check не проходил
- Сервис перезапускался

### 2. Причина проблемы

Document-parser находился в нестабильном состоянии:
- Контейнер перезапускался
- Health check не проходил
- Gateway не мог установить соединение с document-parser
- Это приводило к ошибкам 503 при запросах к API

## Исправления

### 1. Перезапуск document-parser

```bash
docker-compose restart document-parser
```

### 2. Проверка работоспособности

**Health check document-parser:**
```bash
curl -f http://localhost:8001/health
# ✅ Возвращает: {"status":"healthy","timestamp":"2025-08-24T20:12:26.319517"}
```

**Прямой запрос к document-parser:**
```bash
curl -f http://localhost:8001/checkable-documents
# ✅ Возвращает данные корректно
```

**Запрос через gateway с простым токеном:**
```bash
curl -k -H "Authorization: Bearer test-token" https://localhost:8443/api/checkable-documents
# ✅ Возвращает данные корректно
```

**Запрос через gateway с JWT токеном:**
```bash
curl -k -H "Authorization: Bearer <JWT_TOKEN>" https://localhost:8443/api/checkable-documents
# ✅ Возвращает данные корректно
```

## Результат

✅ **Проблема решена:**
- Document-parser стабильно работает
- Gateway успешно подключается к document-parser
- API запросы проходят без ошибок 503
- Страница "Нормоконтроль" функционирует корректно

✅ **Проверка работоспособности:**
- Все сервисы работают стабильно
- Сетевое взаимодействие между контейнерами восстановлено
- Авторизация работает как с простыми, так и с JWT токенами

## Технические детали

### Сетевая конфигурация:
- Все контейнеры находятся в сети `ai-nk-network`
- Document-parser: 172.18.0.11
- Gateway: 172.18.0.12
- Сетевое взаимодействие восстановлено

### Статус сервисов:
- **Document-parser**: ✅ Работает (healthy)
- **Gateway**: ✅ Работает
- **Frontend**: ✅ Работает
- **API**: ✅ Работает

## Рекомендации

1. **Мониторинг health check** - следить за состоянием document-parser
2. **Автоматический перезапуск** - настроить restart policy для document-parser
3. **Логирование** - добавить более детальное логирование для диагностики
4. **Алерты** - настроить уведомления при падении сервисов

## Заключение

Проблема была связана с нестабильной работой document-parser. После перезапуска сервиса все функции восстановлены. Система работает корректно.
