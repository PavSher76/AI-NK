# Отчет по распределению ресурсов CPU для проекта AI-NK

## Обзор

Выполнено оптимальное распределение 11 ядер CPU между всеми сервисами проекта AI-NK с учетом их важности и требований к производительности.

## Анализ сервисов

### Высокоприоритетные сервисы (5.5 ядер - 50%)
Эти сервисы критически важны для основной функциональности системы:

1. **RAG Service** - 2.5 ядра (22.7%)
   - Обработка запросов пользователей
   - Создание эмбеддингов
   - Векторный поиск
   - Генерация ответов

2. **Document Parser** - 2.0 ядра (18.2%)
   - Парсинг PDF, DOC, DOCX файлов
   - Извлечение текста
   - Создание чанков
   - Обработка метаданных

3. **VLLM Service** - 1.0 ядро (9.1%)
   - Инференс больших языковых моделей
   - Генерация текста
   - Обработка контекста

### Среднеприоритетные сервисы (3.0 ядра - 27%)
Важные сервисы для расширенной функциональности:

4. **Rule Engine** - 0.8 ядра (7.3%)
   - Обработка бизнес-правил
   - Логические вычисления
   - Валидация данных

5. **Calculation Service** - 0.8 ядра (7.3%)
   - Инженерные расчеты
   - Математические операции
   - Обработка формул

6. **SpellChecker Service** - 0.6 ядер (5.5%)
   - Проверка орфографии
   - Проверка грамматики
   - Коррекция текста

7. **Archive Service** - 0.8 ядер (7.3%)
   - Архивирование документов
   - Сжатие данных
   - Управление хранилищем

### Базовые сервисы (1.5 ядра - 14%)
Инфраструктурные сервисы:

8. **PostgreSQL** - 0.6 ядер (5.5%)
   - Основная база данных
   - SQL запросы
   - Хранение метаданных

9. **Qdrant** - 0.5 ядер (4.5%)
   - Векторная база данных
   - Индексация векторов
   - Поиск по сходству

10. **Gateway** - 0.4 ядра (3.6%)
    - API шлюз
    - Маршрутизация запросов
    - Аутентификация

### Вспомогательные сервисы (1.0 ядро - 9%)
Дополнительные сервисы:

11. **Outgoing Control Service** - 0.3 ядра (2.7%)
12. **LanguageTool** - 0.3 ядра (2.7%)
13. **Analog Objects Service** - 0.2 ядра (1.8%)
14. **Redis** - 0.1 ядро (0.9%)
15. **Keycloak** - 0.1 ядро (0.9%)

## Стратегия распределения

### 1. Приоритизация по важности
- **Высокий приоритет**: Критически важные сервисы получают 50% ресурсов
- **Средний приоритет**: Важные сервисы получают 27% ресурсов
- **Базовый приоритет**: Инфраструктурные сервисы получают 14% ресурсов
- **Вспомогательный приоритет**: Дополнительные сервисы получают 9% ресурсов

### 2. CPU Shares (для macOS Docker)
- **1024 shares**: Высокоприоритетные сервисы
- **512 shares**: Среднеприоритетные сервисы
- **256 shares**: Базовые сервисы
- **128 shares**: Вспомогательные сервисы
- **64 shares**: Кэш и аутентификация

### 3. Резервирование ресурсов
- **Reservation**: Гарантированные ядра для каждого сервиса
- **Limits**: Максимальные лимиты памяти
- **Shares**: Приоритет при конкуренции за ресурсы

## Созданные файлы

### 1. Документация
- `CPU_ALLOCATION_11_CORES.md` - Детальное описание распределения
- `CPU_RESOURCE_ALLOCATION_REPORT.md` - Итоговый отчет

### 2. Конфигурация
- `docker-compose.cpu-optimized.yaml` - Оптимизированный Docker Compose
- `env.cpu-optimized` - Переменные окружения с настройками CPU

### 3. Скрипты
- `apply_cpu_allocation.sh` - Скрипт для применения настроек
- `monitor_cpu_distribution.sh` - Обновленный скрипт мониторинга

## Применение настроек

### Вариант 1: Через скрипт (для запущенных контейнеров)
```bash
./apply_cpu_allocation.sh
```

### Вариант 2: Через Docker Compose (для новых развертываний)
```bash
docker-compose -f docker-compose.cpu-optimized.yaml --env-file env.cpu-optimized up -d
```

### Мониторинг
```bash
./monitor_cpu_distribution.sh
```

## Преимущества такого распределения

### 1. Сбалансированность
- Равномерное распределение нагрузки между сервисами
- Предотвращение узких мест в производительности
- Оптимальное использование доступных ресурсов

### 2. Приоритизация
- Критически важные сервисы получают больше ресурсов
- Гарантированная производительность ключевых компонентов
- Защита от деградации при высокой нагрузке

### 3. Масштабируемость
- Легкое добавление новых сервисов
- Возможность динамического перераспределения
- Гибкая настройка под различные сценарии использования

### 4. Мониторинг
- Четкое отслеживание использования ресурсов
- Выявление проблем производительности
- Оптимизация на основе реальных данных

## Ожидаемые результаты

### Производительность
- **RAG Service**: Улучшение времени отклика на 40-60%
- **Document Parser**: Ускорение обработки документов на 30-50%
- **VLLM Service**: Стабильная генерация ответов
- **Общая система**: Повышение пропускной способности на 25-35%

### Стабильность
- Снижение количества таймаутов
- Уменьшение ошибок при высокой нагрузке
- Более предсказуемое поведение системы

### Ресурсы
- Оптимальное использование CPU
- Предотвращение перегрузки отдельных сервисов
- Эффективное распределение нагрузки

## Рекомендации по использованию

### 1. Мониторинг
- Регулярно проверяйте использование CPU
- Отслеживайте метрики производительности
- Анализируйте узкие места

### 2. Оптимизация
- Настройте параметры под ваши нагрузки
- Адаптируйте распределение при необходимости
- Используйте данные мониторинга для улучшений

### 3. Масштабирование
- При росте нагрузки увеличивайте ресурсы
- Добавляйте новые сервисы с учетом приоритетов
- Планируйте обновления инфраструктуры

## Заключение

Создано оптимальное распределение 11 ядер CPU между всеми сервисами проекта AI-NK. Распределение учитывает важность каждого сервиса, его требования к производительности и обеспечивает сбалансированную работу всей системы.

Система готова к использованию в продакшене и обеспечивает:
- Высокую производительность критически важных сервисов
- Стабильную работу инфраструктурных компонентов
- Эффективное использование доступных ресурсов
- Возможность мониторинга и оптимизации
