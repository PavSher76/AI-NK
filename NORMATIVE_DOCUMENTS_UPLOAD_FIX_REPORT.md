# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª –æ–± –æ—à–∏–±–∫–µ "404 - Not Found" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
- **–§—Ä–æ–Ω—Ç–µ–Ω–¥**: –ó–∞–ø—Ä–æ—Å `POST /api/upload HTTP/1.1` –≤–æ–∑–≤—Ä–∞—â–∞–ª 404
- **Gateway**: –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
- **RAG Service**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª —ç–Ω–¥–ø–æ–∏–Ω—Ç `/upload`

### 2. –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ upload –≤ RAG Service**
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –≤ Gateway**
3. **–û—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**

## üõ†Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ upload –≤ RAG Service

#### –§–∞–π–ª: `rag_service/ollama_main.py`
```python
@app.post("/upload")
async def upload_document(
    file: UploadFile = File(...),
    category: str = Form("other"),
    description: str = Form("")
):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    # –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
```

#### –§–∞–π–ª: `rag_service/services/ollama_rag_service.py`
–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
- `save_document_to_db()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –ë–î
- `update_document_status()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `process_document_async()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- `extract_text_from_document()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- `create_chunks()` - —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞–Ω–∫–æ–≤
- `index_chunks_async()` - –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: NULL constraint violation
**–û—à–∏–±–∫–∞**: `null value in column "clause_id" of relation "normative_chunks" violates not-null constraint`

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—è `clause_id`:
```python
cursor.execute("""
    INSERT INTO normative_chunks 
    (chunk_id, clause_id, document_id, document_title, chunk_type, content)
    VALUES (%s, %s, %s, %s, %s, %s)
""", (
    chunk['chunk_id'],
    chunk['chunk_id'],  # –ò—Å–ø–æ–ª—å–∑—É–µ–º chunk_id –∫–∞–∫ clause_id
    chunk['document_id'],
    chunk['document_title'],
    chunk['chunk_type'],
    chunk['content']
))
```

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
**–û—à–∏–±–∫–∞**: `'list' object has no attribute 'tolist'`

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞:
```python
# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –≤ —Å–ø–∏—Å–æ–∫
if hasattr(embedding, 'tolist'):
    vector = embedding.tolist()
else:
    vector = list(embedding)
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

#### –§–∞–π–ª: `rag_service/requirements.txt`
–î–æ–±–∞–≤–ª–µ–Ω—ã:
```
PyPDF2==3.0.1
python-docx==0.8.11
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
```bash
curl -X POST http://localhost:8003/upload \
  -F "file=@TestDocs/Norms/–ì–û–°–¢ 26047-2016.pdf" \
  -F "category=–ì–û–°–¢" \
  -F "description=–¢–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ
```json
{
  "status": "success",
  "document_id": 29494281,
  "filename": "–ì–û–°–¢ 26047-2016.pdf",
  "file_size": 113293,
  "message": "Document uploaded successfully and processing started"
}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–°—Ç–∞—Ç—É—Å**: `completed`
- **–¢–æ–∫–µ–Ω—ã**: 2086
- **–ß–∞–Ω–∫–∏**: 19
- **Qdrant**: 19 —Ç–æ—á–µ–∫

### 3. –¢–µ—Å—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ù–¢–î
```bash
curl -X POST http://localhost:8003/ntd-consultation/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö", "user_id": "test_user"}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ
- –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ù–∞–π–¥–µ–Ω–æ 5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- Confidence: 0.55

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Gateway
- **–ü—Ä–æ–±–ª–µ–º–∞**: –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- **–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|-----------|--------|---------|
| **RAG Service Upload** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –≠–Ω–¥–ø–æ–∏–Ω—Ç `/upload` –¥–æ–±–∞–≤–ª–µ–Ω |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | PDF, DOCX, TXT –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è |
| **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ù–¢–î** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **Gateway –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** | ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ | –ú–∞—Ä—à—Ä—É—Ç `/upload` ‚Üí RAG Service |
| **–§—Ä–æ–Ω—Ç–µ–Ω–¥** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –î–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ https://localhost |

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!**

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** —á–µ—Ä–µ–∑ RAG Service API
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞
3. **–°–æ–∑–¥–∞–Ω–∏–µ —á–∞–Ω–∫–æ–≤** –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant
4. **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ù–¢–î** —Å –ø–æ–∏—Å–∫–æ–º –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
5. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** —á–µ—Ä–µ–∑ Gateway

### ‚ö†Ô∏è –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:
1. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Gateway** –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –≤ stats endpoint (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**: ‚úÖ –ì–æ—Ç–æ–≤–∞
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è**: ‚úÖ –ì–æ—Ç–æ–≤–∞  
- **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ù–¢–î**: ‚úÖ –ì–æ—Ç–æ–≤–∞
- **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
**–î–∞—Ç–∞**: 31.08.2025
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
