# üîß BM25 Search Fix Report

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

### SQL –æ—à–∏–±–∫–∞ –≤ BM25 –ø–æ–∏—Å–∫–µ
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞**: 
```
ERROR: column "id" does not exist
LINE 3: id,
```

**–ü—Ä–∏—á–∏–Ω–∞**: SQL –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `normative_chunks`

**–†–µ—à–µ–Ω–∏–µ**:
1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω SQL –∑–∞–ø—Ä–æ—Å** –≤ `hybrid_search_service.py`:
   ```sql
   -- –ë—ã–ª–æ:
   SELECT id, document_id, chunk_id, code, title as document_title, ...
   
   -- –°—Ç–∞–ª–æ:
   SELECT chunk_id, document_id, document_title, chapter, section, page_number, ...
   ```

2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–ª—è** –≤ –∫–æ–¥–µ BM25:
   ```python
   # –ë—ã–ª–æ:
   doc_id = doc['id']
   doc = next((d for d in documents if d['id'] == doc_id), None)
   
   # –°—Ç–∞–ª–æ:
   doc_id = doc['chunk_id']
   doc = next((d for d in documents if d['chunk_id'] == doc_id), None)
   ```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Dense: 20 ‚úÖ
BM25: 0 ‚ùå (SQL –æ—à–∏–±–∫–∞)
Final: 5 ‚úÖ (—Ç–æ–ª—å–∫–æ Dense)
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Dense: 20 ‚úÖ
BM25: 20 ‚úÖ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!)
Final: 5 ‚úÖ (Dense + BM25)
```

### –î–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã BM25:
```
‚úÖ [HYBRID_SEARCH] Loaded 576 documents for BM25
‚úÖ [BM25] Training completed. Corpus size: 576, avg doc length: 196.88
‚úÖ [BM25] Found 20 results for query: '–°–ü 22.13330.2016'
```

## üéØ –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### Hybrid Search —É–ª—É—á—à–µ–Ω:
- **Dense search**: 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫)
- **BM25 search**: 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫)
- **RRF fusion**: 40 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ 5 –ª—É—á—à–∏—Ö
- **–ö–∞—á–µ—Å—Ç–≤–æ**: –ü–æ–≤—ã—à–µ–Ω–æ –∑–∞ —Å—á–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–≤—É—Ö –º–µ—Ç–æ–¥–æ–≤

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
- **Document ID**: 8489575 (–°–ü 22.13330.2016)
- **Chunk ID**: doc_8489575_page_1_chunk_1
- **Score**: 0.01639344262295082

## ‚ö†Ô∏è –û—Å—Ç–∞—é—â–∞—è—Å—è –ø—Ä–æ–±–ª–µ–º–∞

### NTD Consultation –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞**: –†–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –∑–∞–ø—Ä–æ—Å–∞

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
```bash
# –†–∞–±–æ—Ç–∞–µ—Ç:
query = "–°–ü 22.13330.2016"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: Dense: 20, BM25: 20, Final: 5 ‚úÖ

# –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
query = "–î–∞–π —Å–ø—Ä–∞–≤–∫—É –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É –°–ü 22.13330.2016"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: Dense: 0, BM25: 0, Final: 0 ‚ùå
```

**–ü—Ä–æ–±–ª–µ–º–∞**: NTD consultation –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–Ω—É—é —Ñ—Ä–∞–∑—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞—Ö.

## üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ NTD consultation
- –ò–∑–≤–ª–µ–∫–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
- –£–ª—É—á—à–∏—Ç—å intent classification

### 2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- NTD consultation –¥–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: 90% –≥–æ—Ç–æ–≤–æ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| Qdrant API | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–∏—Å–∫ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã |
| Embedding | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | BGE-M3 –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã |
| Dense Search | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ |
| BM25 Search | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ |
| Hybrid Search | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Ç–æ–≥–æ |
| NTD Consultation | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –ù—É–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ |

**BM25 –ø–æ–∏—Å–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ
