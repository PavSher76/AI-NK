# Многоэтапная сборка для AI-NK проекта
# Этап 1: Сборка Frontend
FROM node:20-alpine AS frontend-builder

# Устанавливаем зависимости для сборки
RUN apk add --no-cache python3 make g++

# Обновляем npm до последней версии
RUN npm install -g npm@latest

# Копируем frontend
WORKDIR /app/frontend
COPY frontend/package.json ./
COPY frontend/package-lock.json ./
RUN npm ci --omit=dev

# Копируем исходный код frontend
COPY frontend/src ./src
COPY frontend/public ./public
COPY frontend/tailwind.config.js ./
COPY frontend/postcss.config.js ./

# Собираем frontend
RUN npm run build

# Этап 2: Сборка Python зависимостей
FROM python:3.11-slim AS python-builder

# Устанавливаем системные зависимости
RUN apt-get update && apt-get install -y \
    libmagic1 \
    postgresql-client \
    tesseract-ocr \
    tesseract-ocr-rus \
    tesseract-ocr-eng \
    poppler-utils \
    libglib2.0-0 \
    libgomp1 \
    gcc \
    g++ \
    python3-dev \
    fonts-dejavu \
    fonts-liberation \
    libhunspell-dev \
    libhunspell-1.7-0 \
    && rm -rf /var/lib/apt/lists/*

# Создаем виртуальное окружение
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Копируем requirements для всех сервисов
WORKDIR /app
COPY document_parser/requirements.txt ./document_parser/
COPY rag_service/requirements.txt ./rag_service/
COPY rule_engine/requirements.txt ./rule_engine/
COPY gateway/requirements.txt ./gateway/
COPY calculation_service/requirements.txt ./calculation_service/
COPY outgoing_control_service/requirements.txt ./outgoing_control_service/
COPY spellchecker_service/requirements.txt ./spellchecker_service/
COPY vllm_service/requirements.txt ./vllm_service/

# Устанавливаем Python зависимости по отдельности для избежания конфликтов
RUN pip install --no-cache-dir --upgrade pip

# Устанавливаем общие зависимости
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    uvicorn==0.24.0 \
    python-multipart==0.0.6 \
    psycopg2-binary==2.9.9 \
    qdrant-client==1.7.0 \
    pydantic==2.5.0 \
    httpx==0.25.2 \
    requests==2.31.0 \
    python-jose[cryptography]==3.3.0 \
    redis==5.0.1 \
    prometheus-client==0.19.0 \
    PyJWT==2.8.0 \
    cryptography==41.0.7 \
    aiofiles==23.2.1 \
    python-docx==1.1.0 \
    PyPDF2==3.0.1 \
    pdfminer.six==20221105 \
    openpyxl==3.1.2 \
    pandas==2.1.4 \
    psutil==5.9.6 \
    python-dateutil==2.8.2 \
    requests-toolbelt==1.0.0 \
    numpy==1.24.3

# Устанавливаем специфичные зависимости
RUN pip install --no-cache-dir \
    pypdf2==3.0.1 \
    PyMuPDF==1.23.8 \
    python-magic==0.4.27 \
    tiktoken==0.5.2 \
    pytesseract==0.3.10 \
    Pillow==10.1.0 \
    opencv-python-headless==4.8.1.78 \
    pdf2image==1.16.3 \
    reportlab==4.0.7 \
    huggingface-hub==0.16.4 \
    sentence-transformers==2.2.2 \
    rank-bm25==0.2.2 \
    scikit-learn==1.3.0 \
    openai==1.3.0 \
    language-tool-python==2.7.1 \
    hunspell==0.5.5 \
    nltk==3.8.1 \
    regex==2025.9.1

# Этап 3: Финальный образ
FROM python:3.11-slim AS ai-nk-production

# Устанавливаем системные зависимости
RUN apt-get update && apt-get install -y \
    libmagic1 \
    postgresql-client \
    tesseract-ocr \
    tesseract-ocr-rus \
    tesseract-ocr-eng \
    poppler-utils \
    libglib2.0-0 \
    libgomp1 \
    nginx \
    curl \
    wget \
    fonts-dejavu \
    fonts-liberation \
    libhunspell-1.7-0 \
    && rm -rf /var/lib/apt/lists/*

# Создаем пользователя для безопасности
RUN useradd -m -u 1000 ai-nk && \
    mkdir -p /app /var/log/ai-nk /var/run/ai-nk /app/uploads /app/temp /app/logs /app/data /app/reports && \
    chown -R ai-nk:ai-nk /app /var/log/ai-nk /var/run/ai-nk

# Копируем виртуальное окружение из builder
COPY --from=python-builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Копируем собранный frontend
COPY --from=frontend-builder /app/frontend/build /app/frontend/build

# Копируем исходный код всех сервисов
WORKDIR /app
COPY document_parser/ ./document_parser/
COPY rag_service/ ./rag_service/
COPY rule_engine/ ./rule_engine/
COPY gateway/ ./gateway/
COPY calculation_service/ ./calculation_service/
COPY outgoing_control_service/ ./outgoing_control_service/
COPY spellchecker_service/ ./spellchecker_service/
COPY vllm_service/ ./vllm_service/
COPY config.py ./

# Копируем конфигурационные файлы
COPY nginx.conf /etc/nginx/nginx.conf
COPY sql/ ./sql/
COPY report_format/ ./report_format/
COPY keycloak/ ./keycloak/
COPY ssl/ ./ssl/
COPY configs/ ./configs/

# Создаем необходимые директории и устанавливаем права
RUN mkdir -p /app/uploads /app/temp /app/logs /app/data /app/reports /app/models && \
    chown -R ai-nk:ai-nk /app && \
    chmod -R 755 /app

# Копируем скрипты запуска
COPY scripts/start.sh /app/start.sh
COPY scripts/init.sh /app/init.sh
RUN chmod +x /app/start.sh /app/init.sh

# Устанавливаем переменные окружения
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV TZ=Europe/Moscow
ENV LANG=ru_RU.UTF-8
ENV LC_ALL=ru_RU.UTF-8

# Переключаемся на пользователя ai-nk
USER ai-nk

# Открываем порты
EXPOSE 80 443 8001 8002 8003 8004 8005 8006 8007 8443 5432 6379 6333 9090 3000 8081

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost/health || exit 1

# Точка входа
ENTRYPOINT ["/app/start.sh"]