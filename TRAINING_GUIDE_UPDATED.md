# 🎓 Обновленная инструкция обучения системы AI-NK для автоматизированного нормоконтроля

## 📋 Обзор системы

Система AI-NK представляет собой интеллектуальную платформу для автоматизированной проверки нормативной документации, использующую современные технологии искусственного интеллекта:

- **RAG (Retrieval-Augmented Generation)** - семантический поиск по нормативным документам
- **Гибридный поиск** - комбинация Dense, BM25 и RRF (Reciprocal Rank Fusion)
- **LLM-анализ** - использование больших языковых моделей для анализа документов
- **Контекстное обучение** - адаптация под специфику различных типов документов

## 🎯 Цели обучения системы

### Основные задачи:
1. **Повышение точности проверки** - минимизация ложных срабатываний и пропусков
2. **Адаптация под специфику** - настройка под конкретные типы документов (СП, ГОСТ, СНиП, корпоративные стандарты)
3. **Улучшение качества отчетов** - более структурированные и полезные выводы
4. **Оптимизация производительности** - быстрая и эффективная обработка больших документов

### Ключевые метрики качества:
- **Точность (Precision)** - процент правильных находок от общего числа
- **Полнота (Recall)** - процент найденных нарушений от общего числа
- **F1-мера** - гармоническое среднее точности и полноты
- **Время обработки** - скорость анализа документов

## 🏗️ Архитектура системы обучения

### 1. Компоненты системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Нормативные   │    │   Проверяемые   │    │   Обратная      │
│   документы     │    │   документы     │    │   связь         │
│   (RAG Base)    │    │   (Input)       │    │   (Feedback)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   RAG Service   │    │  Document       │    │   Feedback      │
│   (Индексация)  │    │  Parser         │    │   Loop          │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Qdrant        │    │   LLM           │    │   Промпт        │
│   (Векторы)     │    │   (Анализ)      │    │   Fine-tuning   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2. Поток обучения

1. **Загрузка нормативных документов** → Индексация в RAG
2. **Проверка тестовых документов** → Получение результатов
3. **Анализ качества** → Выявление проблем
4. **Корректировка промптов** → Улучшение инструкций
5. **Повторная проверка** → Валидация улучшений

## 📚 Этап 1: Подготовка нормативной базы

### 1.1 Структура нормативных документов

Система поддерживает следующие типы нормативных документов:

| Тип документа | Описание | Примеры |
|---------------|----------|---------|
| **ГОСТ** | Государственные стандарты | ГОСТ 2.306-68, ГОСТ 21.101-97 |
| **СП** | Своды правил | СП 22.13330.2016, СП 16.13330.2017 |
| **СНиП** | Строительные нормы и правила | СНиП 2.01.07-85, СНиП 3.03.01-87 |
| **ФНП** | Федеральные нормы и правила | ФНП 1.1.1.1-1, ФНП 1.1.1.1-2 |
| **ПБ** | Правила безопасности | ПБ 03-576-03, ПБ 03-598-03 |
| **А** | Альбомы (корпоративные стандарты) | А9.2.МТН.03, А1.1.МТН.01 |

### 1.2 Загрузка нормативных документов

#### Через веб-интерфейс:
1. Откройте раздел "Нормативные документы"
2. Нажмите "Загрузить документ"
3. Выберите файл (PDF, DOCX, TXT)
4. Укажите категорию и тип документа
5. Нажмите "Загрузить"

#### Через API:
```bash
curl -k -X POST "https://localhost:8443/api/upload" \
  -H "Authorization: Bearer disabled-auth" \
  -F "file=@document.pdf" \
  -F "category=normative" \
  -F "document_type=СП"
```

### 1.3 Индексация документов

После загрузки документы автоматически индексируются:

1. **Парсинг текста** - извлечение текста из PDF/DOCX
2. **Разбиение на чанки** - создание семантических блоков
3. **Создание эмбеддингов** - векторное представление с помощью BGE-M3
4. **Сохранение в Qdrant** - индексация для быстрого поиска

#### Проверка статуса индексации:
```bash
curl -k -X GET "https://localhost:8443/api/documents/stats" \
  -H "Authorization: Bearer disabled-auth"
```

## 🔍 Этап 2: Настройка системы проверки

### 2.1 Конфигурация промптов

Система использует настраиваемые промпты для различных типов проверок:

#### Основной промпт для нормоконтроля:
```
Ты - эксперт по нормоконтролю строительной документации. 
Проанализируй представленный документ на соответствие нормативным требованиям.

Контекст нормативных документов:
{context}

Документ для проверки:
{document}

Найди нарушения и несоответствия, укажи:
1. Тип нарушения (критическое/предупреждение/информация)
2. Описание проблемы
3. Ссылку на нормативный документ
4. Рекомендации по устранению
5. Номер страницы
```

#### Промпт для анализа структуры:
```
Проанализируй структуру документа и определи:
1. Тип документа (чертеж, спецификация, расчет и т.д.)
2. Стадию проектирования
3. Комплект документации
4. Основные разделы и их содержание
```

### 2.2 Настройка параметров поиска

#### Параметры гибридного поиска:
- **Alpha (α)** - вес dense поиска (по умолчанию 0.6)
- **RRF K** - параметр Reciprocal Rank Fusion (по умолчанию 60)
- **Количество результатов** - количество релевантных документов (по умолчанию 8)

#### Настройка через API:
```bash
curl -k -X POST "https://localhost:8443/api/ntd-consultation" \
  -H "Authorization: Bearer disabled-auth" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Проверь документ на соответствие СП 22.13330.2016",
    "k": 10,
    "use_reranker": true,
    "use_mmr": true
  }'
```

## 🧪 Этап 3: Тестирование и валидация

### 3.1 Подготовка тестовых данных

#### Структура тестового набора:
```
test_data/
├── normative_documents/     # Нормативные документы
│   ├── gost/
│   ├── sp/
│   ├── snip/
│   └── corporate/
├── test_documents/          # Тестовые документы
│   ├── compliant/          # Соответствующие нормам
│   ├── non_compliant/      # Нарушающие нормы
│   └── edge_cases/         # Граничные случаи
└── expected_results/        # Ожидаемые результаты
    ├── findings.json
    └── compliance_report.json
```

### 3.2 Метрики качества

#### Основные метрики:
1. **Точность (Precision)** = TP / (TP + FP)
2. **Полнота (Recall)** = TP / (TP + FN)
3. **F1-мера** = 2 * (Precision * Recall) / (Precision + Recall)
4. **Время обработки** - среднее время анализа документа

Где:
- **TP** (True Positive) - правильно найденные нарушения
- **FP** (False Positive) - ложные срабатывания
- **FN** (False Negative) - пропущенные нарушения

### 3.3 Процедура тестирования

#### 1. Загрузка тестовых документов:
```bash
# Загрузка нормативных документов
for file in test_data/normative_documents/*/*.pdf; do
  curl -k -X POST "https://localhost:8443/api/upload" \
    -H "Authorization: Bearer disabled-auth" \
    -F "file=@$file" \
    -F "category=normative" \
    -F "document_type=$(basename $(dirname $file))"
done
```

#### 2. Проверка тестовых документов:
```bash
# Проверка каждого тестового документа
for file in test_data/test_documents/*/*.pdf; do
  curl -k -X POST "https://localhost:8443/api/check" \
    -H "Authorization: Bearer disabled-auth" \
    -F "file=@$file" \
    -F "check_type=norm_control"
done
```

#### 3. Анализ результатов:
```python
import json
import pandas as pd
from sklearn.metrics import precision_score, recall_score, f1_score

# Загрузка результатов
with open('test_results.json', 'r') as f:
    results = json.load(f)

# Расчет метрик
precision = precision_score(results['expected'], results['predicted'])
recall = recall_score(results['expected'], results['predicted'])
f1 = f1_score(results['expected'], results['predicted'])

print(f"Precision: {precision:.3f}")
print(f"Recall: {recall:.3f}")
print(f"F1-score: {f1:.3f}")
```

## 🔧 Этап 4: Оптимизация и настройка

### 4.1 Настройка промптов

#### Анализ качества результатов:
1. **Выявление проблем** - анализ ложных срабатываний и пропусков
2. **Корректировка промптов** - уточнение инструкций
3. **Тестирование изменений** - проверка улучшений

#### Пример оптимизации промпта:
```python
# Исходный промпт
original_prompt = """
Проанализируй документ на соответствие нормам.
Найди нарушения и укажи рекомендации.
"""

# Оптимизированный промпт
optimized_prompt = """
Ты - эксперт по нормоконтролю. Проанализируй документ по следующим критериям:

1. СООТВЕТСТВИЕ НОРМАТИВНЫМ ТРЕБОВАНИЯМ:
   - Проверь соответствие СП, ГОСТ, СНиП
   - Обрати внимание на обязательные требования
   - Учти стадию проектирования

2. КЛАССИФИКАЦИЯ НАРУШЕНИЙ:
   - КРИТИЧЕСКОЕ: нарушение обязательных требований
   - ПРЕДУПРЕЖДЕНИЕ: нарушение рекомендательных требований
   - ИНФОРМАЦИЯ: замечания по улучшению

3. ФОРМАТ ОТВЕТА:
   - Тип нарушения
   - Описание проблемы
   - Ссылка на нормативный документ
   - Рекомендации по устранению
   - Номер страницы

Контекст нормативных документов:
{context}

Документ для проверки:
{document}
"""
```

### 4.2 Настройка параметров поиска

#### Оптимизация параметров:
```python
# Тестирование различных параметров
test_params = [
    {"alpha": 0.5, "rrf_k": 60, "k": 8},
    {"alpha": 0.6, "rrf_k": 60, "k": 10},
    {"alpha": 0.7, "rrf_k": 80, "k": 12},
    {"alpha": 0.8, "rrf_k": 100, "k": 15}
]

best_params = None
best_f1 = 0

for params in test_params:
    # Тестирование с текущими параметрами
    f1_score = test_with_params(params)
    
    if f1_score > best_f1:
        best_f1 = f1_score
        best_params = params

print(f"Лучшие параметры: {best_params}")
print(f"Лучший F1-score: {best_f1:.3f}")
```

### 4.3 Настройка модели эмбеддингов

#### Выбор модели:
- **BGE-M3** - универсальная модель для многоязычных текстов
- **BGE-large-zh-v1.5** - специализированная для китайского языка
- **BGE-base-en-v1.5** - для английского языка

#### Настройка через конфигурацию:
```yaml
# config/embedding_config.yaml
embedding_model:
  name: "bge-m3"
  max_length: 8192
  batch_size: 32
  device: "cuda"  # или "cpu"
```

## 📊 Этап 5: Мониторинг и поддержка

### 5.1 Мониторинг качества

#### Ключевые метрики для отслеживания:
1. **Качество поиска** - релевантность найденных документов
2. **Точность анализа** - правильность выявленных нарушений
3. **Производительность** - время обработки документов
4. **Покрытие** - процент документов, успешно проанализированных

#### Дашборд мониторинга:
```python
import streamlit as st
import plotly.express as px

# Создание дашборда
st.title("AI-NK Quality Dashboard")

# Метрики качества
col1, col2, col3, col4 = st.columns(4)
with col1:
    st.metric("Precision", f"{precision:.3f}", "↑ 0.02")
with col2:
    st.metric("Recall", f"{recall:.3f}", "↑ 0.01")
with col3:
    st.metric("F1-score", f"{f1:.3f}", "↑ 0.015")
with col4:
    st.metric("Processing Time", f"{avg_time:.2f}s", "↓ 0.5s")

# График качества по времени
fig = px.line(quality_history, x='date', y='f1_score')
st.plotly_chart(fig)
```

### 5.2 Обратная связь и улучшения

#### Система обратной связи:
1. **Сбор отзывов** - оценка качества результатов пользователями
2. **Анализ ошибок** - выявление системных проблем
3. **Корректировка** - обновление промптов и параметров
4. **Валидация** - проверка улучшений на тестовых данных

#### Процедура обновления:
```bash
# 1. Сбор данных обратной связи
python scripts/collect_feedback.py

# 2. Анализ качества
python scripts/analyze_quality.py

# 3. Обновление промптов
python scripts/update_prompts.py

# 4. Тестирование изменений
python scripts/test_improvements.py

# 5. Развертывание обновлений
docker-compose restart rag-service
```

## 🚀 Этап 6: Развертывание в продакшене

### 6.1 Подготовка к продакшену

#### Конфигурация для продакшена:
```yaml
# docker-compose.prod.yaml
services:
  rag-service:
    environment:
      - OLLAMA_HOST=ollama-service
      - OLLAMA_PORT=11434
      - MAX_DOCUMENT_SIZE=104857600  # 100MB
      - ENABLE_LOGGING=true
      - LOG_LEVEL=INFO
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4.0'
        reservations:
          memory: 4G
          cpus: '2.0'
```

#### Мониторинг и логирование:
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'ai-nk-rag-service'
    static_configs:
      - targets: ['rag-service:8002']
    metrics_path: '/metrics'
    scrape_interval: 30s
```

### 6.2 Процедура развертывания

#### 1. Подготовка окружения:
```bash
# Создание резервной копии
docker exec ai-nk-norms-db-1 pg_dump -U norms_user norms_db > backup_$(date +%Y%m%d_%H%M%S).sql

# Остановка сервисов
docker-compose down
```

#### 2. Обновление системы:
```bash
# Обновление кода
git pull origin main

# Пересборка образов
docker-compose build

# Запуск обновленных сервисов
docker-compose up -d
```

#### 3. Проверка работоспособности:
```bash
# Проверка здоровья сервисов
curl http://localhost:8002/health
curl http://localhost:8001/health
curl http://localhost:8003/health

# Проверка качества
python scripts/validate_deployment.py
```

## 📈 Этап 7: Непрерывное улучшение

### 7.1 A/B тестирование

#### Сравнение версий:
```python
import numpy as np
from scipy import stats

def ab_test(version_a_results, version_b_results):
    """A/B тест для сравнения двух версий системы"""
    
    # Статистический тест
    t_stat, p_value = stats.ttest_ind(version_a_results, version_b_results)
    
    # Определение лучшей версии
    if p_value < 0.05:
        if np.mean(version_a_results) > np.mean(version_b_results):
            return "Version A is significantly better"
        else:
            return "Version B is significantly better"
    else:
        return "No significant difference"
```

### 7.2 Автоматическое обучение

#### Система автоматического улучшения:
```python
class AutoLearningSystem:
    def __init__(self):
        self.quality_threshold = 0.85
        self.improvement_threshold = 0.02
    
    def monitor_quality(self):
        """Мониторинг качества системы"""
        current_quality = self.get_current_quality()
        
        if current_quality < self.quality_threshold:
            self.trigger_improvement()
    
    def trigger_improvement(self):
        """Запуск процесса улучшения"""
        # Анализ проблем
        issues = self.analyze_issues()
        
        # Генерация улучшений
        improvements = self.generate_improvements(issues)
        
        # Тестирование улучшений
        for improvement in improvements:
            if self.test_improvement(improvement):
                self.deploy_improvement(improvement)
```

## 🔧 Практические рекомендации

### 1. Настройка под специфику организации

#### Корпоративные стандарты:
- Загрузите внутренние стандарты организации
- Настройте промпты под специфику документов
- Создайте специализированные шаблоны отчетов

#### Отраслевая специфика:
- Адаптируйте систему под отрасль (строительство, нефтехимия, энергетика)
- Настройте классификацию нарушений
- Добавьте отраслевые нормативные документы

### 2. Оптимизация производительности

#### Масштабирование:
- Используйте горизонтальное масштабирование для RAG сервиса
- Настройте кэширование для часто используемых запросов
- Оптимизируйте размер чанков для баланса качества и скорости

#### Мониторинг ресурсов:
```bash
# Мониторинг использования ресурсов
docker stats

# Мониторинг производительности
curl http://localhost:8002/metrics | grep -E "(processing_time|memory_usage|cpu_usage)"
```

### 3. Обеспечение качества

#### Регулярное тестирование:
- Еженедельное тестирование на новых документах
- Ежемесячный анализ качества
- Квартальное обновление нормативной базы

#### Контроль качества:
```python
def quality_check():
    """Регулярная проверка качества системы"""
    
    # Тестирование на эталонных документах
    test_results = run_quality_tests()
    
    # Анализ метрик
    if test_results['f1_score'] < 0.8:
        logger.warning("Quality below threshold, triggering improvement")
        trigger_improvement_process()
    
    return test_results
```

## 📚 Заключение

Система AI-NK представляет собой мощный инструмент для автоматизированного нормоконтроля, который требует правильной настройки и постоянного улучшения. Следуя данной инструкции, вы сможете:

1. **Настроить систему** под специфику вашей организации
2. **Обучить систему** на ваших нормативных документах
3. **Оптимизировать качество** проверки документов
4. **Обеспечить непрерывное улучшение** системы

### Ключевые принципы успешного обучения:

- **Постепенность** - начинайте с простых случаев и постепенно усложняйте
- **Итеративность** - постоянно анализируйте результаты и улучшайте систему
- **Документирование** - ведите учет всех изменений и их влияния на качество
- **Мониторинг** - отслеживайте ключевые метрики качества и производительности

### Поддержка и развитие:

- Регулярно обновляйте нормативную базу
- Анализируйте обратную связь пользователей
- Внедряйте новые технологии и подходы
- Обеспечивайте непрерывное обучение команды

---

**© 2024 AI-NK System. Все права защищены.**

*Данная инструкция является руководством по обучению и настройке системы AI-NK для автоматизированного нормоконтроля документации.*
