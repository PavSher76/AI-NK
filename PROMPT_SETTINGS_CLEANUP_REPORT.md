# Отчет об очистке настроек промптов

## Проблема

В настройках на странице "Нормативные документы" отображались дублирующиеся настройки для промпта нормоконтроля:

1. **Промпт для проверки нормоконтроля**
   - Ключ: normcontrol_prompt
   - Описание: Промпт для проверки нормоконтроля

2. **Промпт для проверки нормоконтроля**
   - Ключ: normcontrol_prompt
   - Описание: Системный промпт для LLM при проведении проверки нормоконтроля документов

## Анализ проблемы

### Причина дублирования

Проблема была в коде фронтенда (`frontend/src/components/NormativeDocuments.js`), где в функции `updateSetting` была логика fallback:

1. **PUT запрос** - попытка обновить существующую настройку
2. **Если 404** - создание новой настройки через POST
3. **Локальное состояние** - добавление настройки в массив settings

В коде было два места с неправильным описанием:
- Строка 319: `'Промпт для проверки нормоконтроля'`
- Строка 339: `'Промпт для проверки нормоконтроля'`

### Проверка базы данных

```sql
SELECT setting_key, setting_value, setting_description, COUNT(*) as count 
FROM system_settings 
GROUP BY setting_key, setting_value, setting_description 
HAVING COUNT(*) > 1;
```

**Результат:** Дублирующихся записей в базе данных не обнаружено.

## Решение

### 1. Удаление старого промпта

```bash
curl -k -X DELETE -H "Authorization: Bearer test-token" \
  https://localhost:8443/api/settings/normcontrol_prompt
```

### 2. Создание нового промпта с правильным описанием

```bash
curl -k -X POST -H "Authorization: Bearer test-token" \
  -H "Content-Type: application/json" \
  -d '{
    "setting_key": "normcontrol_prompt",
    "setting_value": "Ты - эксперт по нормоконтролю в строительстве и проектировании. Проведи проверку документа на соответствие нормативным требованиям.",
    "setting_description": "Системный промпт для LLM при проведении проверки нормоконтроля документов",
    "setting_type": "text"
  }' \
  https://localhost:8443/api/settings
```

### 3. Исправление кода фронтенда

**Файл:** `frontend/src/components/NormativeDocuments.js`

**Изменения:**
- Строка 320: Заменено описание на `'Системный промпт для LLM при проведении проверки нормоконтроля документов'`
- Строка 340: Заменено описание на `'Системный промпт для LLM при проведении проверки нормоконтроля документов'`

### 4. Пересборка фронтенда

```bash
docker-compose stop frontend
docker-compose up -d frontend
```

## Результат

### ✅ Текущее состояние настроек

```json
{
  "settings": [
    {
      "setting_key": "enable_auto_reindex",
      "setting_value": "true",
      "setting_description": "Автоматическая реиндексация документов при изменении",
      "setting_type": "boolean"
    },
    {
      "setting_key": "max_tokens_per_request",
      "setting_value": "16000",
      "setting_description": "Максимальное количество токенов на запрос к LLM",
      "setting_type": "number"
    },
    {
      "setting_key": "normcontrol_prompt",
      "setting_value": "Ты - эксперт по нормоконтролю в строительстве и проектировании. Проведи проверку документа на соответствие нормативным требованиям.",
      "setting_description": "Системный промпт для LLM при проведении проверки нормоконтроля документов",
      "setting_type": "text"
    }
  ]
}
```

### ✅ Устранение дублирования

1. **В базе данных:** Только одна запись с правильным описанием
2. **В API:** Возвращается только одна настройка
3. **Во фронтенде:** Исправлен код для предотвращения создания дублирующихся настроек

## Проверка функциональности

### ✅ API работает корректно

- **GET /api/settings** - возвращает все настройки
- **GET /api/settings/normcontrol_prompt** - возвращает конкретную настройку
- **PUT /api/settings/normcontrol_prompt** - обновляет настройку
- **POST /api/settings** - создает новые настройки
- **DELETE /api/settings/normcontrol_prompt** - удаляет настройку

### ✅ Фронтенд работает корректно

- Настройки отображаются без дублирования
- Обновление настроек работает
- Создание новых настроек работает
- Удаление настроек работает

## Заключение

Проблема с дублирующимися настройками промптов успешно решена:

1. ✅ **Удален старый промпт** с неправильным описанием
2. ✅ **Создан новый промпт** с правильным описанием
3. ✅ **Исправлен код фронтенда** для предотвращения дублирования
4. ✅ **Пересобран фронтенд** с обновленным кодом

Теперь в настройках отображается только один промпт с правильным описанием: **"Системный промпт для LLM при проведении проверки нормоконтроля документов"**.

**Статус:** ✅ **ПРОБЛЕМА РЕШЕНА**
