# Архитектура сервиса архива технической документации

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                        Gateway (8443)                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              /api/archive/* proxy                       │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                 Archive Service (8008)                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    FastAPI App                          │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │   │
│  │  │   Models    │ │   Config    │ │   Utils     │      │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Core Services                            │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │   │
│  │  │   Batch     │ │ Document    │ │  Vector     │      │   │
│  │  │  Upload     │ │ Processor   │ │ Indexer     │      │   │
│  │  │  Service    │ │             │ │             │      │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │   │
│  │  ┌─────────────┐ ┌─────────────┐                      │   │
│  │  │ Document    │ │ Database    │                      │   │
│  │  │ Merger      │ │ Manager     │                      │   │
│  │  └─────────────┘ └─────────────┘                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼───────┐ ┌───────▼───────┐ ┌───────▼───────┐
│  PostgreSQL   │ │    Qdrant     │ │  File System  │
│   Database    │ │  Vector DB    │ │   Storage     │
│               │ │               │ │               │
│ archive_      │ │ archive_      │ │ /uploads/     │
│ documents     │ │ documents     │ │ archive/      │
│ archive_      │ │ collection    │ │ /uploads/     │
│ sections      │ │               │ │ merged/       │
│ archive_      │ │               │ │               │
│ projects      │ │               │ │               │
└───────────────┘ └───────────────┘ └───────────────┘
```

## Компоненты системы

### 1. Gateway (Порт 8443)
- **Роль**: Единая точка входа для всех API запросов
- **Функции**:
  - Маршрутизация запросов к сервисам
  - Аутентификация и авторизация
  - Проксирование запросов к Archive Service
  - Логирование и мониторинг

### 2. Archive Service (Порт 8008)
- **Роль**: Основной сервис для работы с архивом документов
- **Компоненты**:
  - **FastAPI App**: Веб-приложение с REST API
  - **Models**: Модели данных (Pydantic)
  - **Config**: Конфигурация сервиса
  - **Utils**: Вспомогательные функции

### 3. Core Services

#### 3.1 Batch Upload Service
- **Функции**:
  - Пакетная загрузка документов
  - Валидация входных данных
  - Создание проектов
  - Управление прогрессом загрузки

#### 3.2 Document Processor
- **Функции**:
  - Извлечение текста из документов (PDF, DOCX, XLSX)
  - Определение типа документа
  - Извлечение ШИФР проекта
  - Разбиение на разделы
  - Создание чанков для индексации

#### 3.3 Vector Indexer
- **Функции**:
  - Генерация эмбеддингов
  - Индексация в Qdrant
  - Семантический поиск
  - Управление векторной коллекцией

#### 3.4 Document Merger
- **Функции**:
  - Объединение документов по проекту
  - Создание PDF/DOCX отчетов
  - Генерация оглавления
  - Сохранение метаданных

#### 3.5 Database Manager
- **Функции**:
  - Управление соединениями с PostgreSQL
  - CRUD операции с данными
  - Транзакции и пулы соединений
  - Оптимизация запросов

### 4. Хранилища данных

#### 4.1 PostgreSQL Database
- **Таблицы**:
  - `archive_documents` - Документы архива
  - `archive_document_sections` - Разделы документов
  - `archive_document_relations` - Связи между документами
  - `archive_projects` - Метаданные проектов
- **Индексы**: По ШИФР проекта, типу документа, статусу, дате
- **Триггеры**: Автоматическое обновление статистики

#### 4.2 Qdrant Vector Database
- **Коллекция**: `archive_documents`
- **Функции**:
  - Векторный поиск по содержимому
  - Семантическое сравнение документов
  - Фильтрация по метаданным

#### 4.3 File System Storage
- **Директории**:
  - `/uploads/archive/` - Загруженные документы
  - `/uploads/merged/` - Объединенные документы
- **Организация**: По ШИФР проекта

## Потоки данных

### 1. Загрузка документа

```
1. Client → Gateway → Archive Service
2. Document Processor: извлечение текста и метаданных
3. Database Manager: сохранение в PostgreSQL
4. Vector Indexer: создание эмбеддингов и индексация
5. Response: статус загрузки и ID документа
```

### 2. Поиск документов

```
1. Client → Gateway → Archive Service
2. Database Manager: поиск по метаданным в PostgreSQL
3. Vector Indexer: семантический поиск в Qdrant
4. Объединение результатов и ранжирование
5. Response: список найденных документов
```

### 3. Объединение документов

```
1. Client → Gateway → Archive Service
2. Database Manager: получение документов проекта
3. Document Processor: извлечение содержимого
4. Document Merger: создание объединенного файла
5. Database Manager: сохранение записи об объединении
6. Response: путь к объединенному файлу
```

## API Endpoints

### Основные маршруты

- `POST /api/archive/upload/single` - Загрузка одного документа
- `POST /api/archive/upload/batch` - Пакетная загрузка
- `GET /api/archive/projects/{code}/documents` - Документы проекта
- `GET /api/archive/projects/{code}/stats` - Статистика проекта
- `POST /api/archive/search` - Поиск документов
- `POST /api/archive/search/similar` - Поиск похожих разделов
- `POST /api/archive/projects/{code}/merge` - Объединение документов

### Служебные маршруты

- `GET /api/archive/health` - Проверка здоровья
- `GET /api/archive/config` - Конфигурация сервиса
- `GET /api/archive/vector/stats` - Статистика векторной БД

## Конфигурация

### Переменные окружения

```bash
# База данных
DATABASE_URL=postgresql://user:pass@localhost:5432/db

# Векторная база
QDRANT_URL=http://localhost:6333

# Файловое хранилище
ARCHIVE_UPLOAD_DIR=/app/uploads/archive
ARCHIVE_MAX_FILE_SIZE=104857600

# Обработка документов
CHUNK_SIZE=1000
CHUNK_OVERLAP=200
EMBEDDING_MODEL=BGE-M3

# Производительность
BATCH_SIZE=10
MAX_CONCURRENT_UPLOADS=5
```

## Масштабирование

### Горизонтальное масштабирование
- Несколько экземпляров Archive Service
- Load balancer для распределения нагрузки
- Общее хранилище файлов (NFS/S3)

### Вертикальное масштабирование
- Увеличение ресурсов контейнера
- Оптимизация запросов к БД
- Кэширование часто используемых данных

## Мониторинг

### Метрики
- Количество загруженных документов
- Время обработки документов
- Использование ресурсов
- Ошибки и исключения

### Логирование
- Структурированные логи в JSON
- Уровни: DEBUG, INFO, WARNING, ERROR
- Корреляция запросов по ID

### Health Checks
- Проверка подключения к БД
- Проверка доступности Qdrant
- Проверка файловой системы

## Безопасность

### Аутентификация
- Интеграция с Keycloak через Gateway
- JWT токены для API запросов
- Проверка прав доступа

### Валидация
- Проверка типов файлов
- Ограничение размера файлов
- Санитизация входных данных

### Изоляция
- Файлы изолированы по проектам
- Ограничения доступа к директориям
- Безопасное удаление временных файлов
