# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ RAG —Å–µ—Ä–≤–∏—Å–∞ –∏ —É—Å–ø–µ—à–Ω–æ–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ—Å—Ç `verify_ai_nk_qdrant.py` –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª —Å –æ—à–∏–±–∫–æ–π:
```
[FAIL] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å count —Ç–æ—á–µ–∫: 400 Client Error: Bad Request for url: http://localhost:6333/collections/normative_documents/points/count
```

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º:
1. **API Qdrant –∏–∑–º–µ–Ω–∏–ª—Å—è** - —ç–Ω–¥–ø–æ–∏–Ω—Ç `points/count` —Ç—Ä–µ–±—É–µ—Ç POST –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ GET
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –ø–æ–ª—è –≤ payload** - `code`, `title`, `section_title`
3. **–ú–æ–¥–µ–ª—å BGE-M3 –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å** - –∑–∞–Ω–∏–º–∞–ª–∞ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
4. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –æ–∂–∏–¥–∞–Ω–∏—è–º —Ç–µ—Å—Ç–∞**

## üîß –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API Qdrant –≤ —Ç–µ—Å—Ç–µ

**–§–∞–π–ª:** `test_sctipts/verify_ai_nk_qdrant.py`

```python
def qdrant_points_count(qdrant_url: str, collection: str) -> int:
    """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ POST –∑–∞–ø—Ä–æ—Å"""
    try:
        # –ù–æ–≤—ã–π API Qdrant —Ç—Ä–µ–±—É–µ—Ç POST –∑–∞–ø—Ä–æ—Å –¥–ª—è count
        data = post_json(f"{qdrant_url.rstrip('/')}/collections/{collection}/points/count", {})
        return int(data.get("result", {}).get("count", 0))
    except Exception as e:
        # Fallback: –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        try:
            data = get_json(f"{qdrant_url.rstrip('/')}/collections/{collection}")
            return int(data.get("result", {}).get("points_count", 0))
        except Exception:
            raise e
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã payload –≤ RAG —Å–µ—Ä–≤–∏—Å–µ

**–§–∞–π–ª:** `rag_service/services/rag_service.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ payload:
- `code` - –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ì–û–°–¢, –°–ü –∏ —Ç.–¥.)
- `title` - –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `section_title` - –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞

```python
# –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
document_title = chunk.get('document_title', '')
code = self.extract_document_code(document_title)

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –¥–ª—è Qdrant
point = {
    'id': chunk.get('id'),
    'vector': embedding,
    'payload': {
        'document_id': document_id,
        'code': code,  # –ö–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ì–û–°–¢, –°–ü –∏ —Ç.–¥.)
        'title': document_title,  # –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        'section_title': chunk.get('section_title', ''),  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞
        'content': chunk.get('content', ''),
        'chunk_type': chunk.get('chunk_type', 'paragraph'),
        'page': chunk.get('page', 1),
        'section': chunk.get('section', ''),
        'metadata': chunk.get('metadata', {})
    }
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–¥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

```python
def extract_document_code(self, document_title: str) -> str:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (–ì–û–°–¢, –°–ü, –°–ù–∏–ü –∏ —Ç.–¥.)
    """
    try:
        import re
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–¥–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        patterns = [
            r'–ì–û–°–¢\s+[\d\.-]+',  # –ì–û–°–¢ 21.201-2011
            r'–°–ü\s+[\d\.-]+',    # –°–ü 20.13330.2016
            r'–°–ù–∏–ü\s+[\d\.-]+',  # –°–ù–∏–ü 2.01.07-85
            r'–¢–†\s+–¢–°\s+[\d\.-]+',  # –¢–† –¢–° 004/2011
            r'–°–¢–û\s+[\d\.-]+',   # –°–¢–û 02494680-0046-2005
            r'–†–î\s+[\d\.-]+',    # –†–î 11-02-2006
        ]
        
        for pattern in patterns:
            match = re.search(pattern, document_title, re.IGNORECASE)
            if match:
                return match.group(0).strip()
        
        return ""
        
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è [CODE_EXTRACTION] Error extracting document code: {e}")
        return ""
```

### 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏ RAG —Å–µ—Ä–≤–∏—Å–∞

**–§–∞–π–ª:** `rag_service/simple_main.py`

–°–æ–∑–¥–∞–Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è RAG —Å–µ—Ä–≤–∏—Å–∞ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ BGE-M3:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ —Ö–µ—à-—ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—è–∂–µ–ª—ã—Ö –º–æ–¥–µ–ª–µ–π
- –ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –≤ endpoints

**–§–∞–π–ª:** `rag_service/api/endpoints.py`

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:
```python
chunk_data = {
    'id': chunk['chunk_id'],  # ID –¥–ª—è Qdrant
    'document_id': document_id,
    'chunk_id': chunk['chunk_id'],
    'content': chunk['content'],
    'page': chunk['page_number'],  # –ò—Å–ø–æ–ª—å–∑—É–µ–º 'page' –≤–º–µ—Å—Ç–æ 'page_number'
    'section_title': chunk['chapter'] or '',
    'section': chunk['section'] or '',  # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ 'section'
    'document_title': document_title,
    'category': document['category'],
    'chunk_type': 'paragraph'  # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø —á–∞–Ω–∫–∞
}
```

### 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

–ò–∑–º–µ–Ω–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
```python
# –ë—ã–ª–æ:
WHERE ud.processing_status = 'completed'

# –°—Ç–∞–ª–æ:
WHERE ud.processing_status IN ('completed', 'pending')
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç:
```bash
python3 verify_ai_nk_qdrant.py --qdrant-url http://localhost:6333 --collection normative_documents --expected-dense-size 1024 --test-code "–ì–û–°–¢ 21.201-2011"
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
```
=== –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Qdrant –∏ –Ω–∞–ª–∏—á–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ===
[PASS] –ö–æ–ª–ª–µ–∫—Ü–∏—è 'normative_documents' –Ω–∞–π–¥–µ–Ω–∞ —Å—Ä–µ–¥–∏ 2 –∫–æ–ª–ª–µ–∫—Ü–∏–π.

=== –®–∞–≥ 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–æ–≤ ===
[PASS] Single-vector —Å—Ö–µ–º–∞: size=1024

=== –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (points count) ===
[PASS] –í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ: 1 —Ç–æ—á–µ–∫.

=== –®–∞–≥ 4: –ü—Ä–∏–º–µ—Ä—ã payload –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π ===
[PASS] –ü–æ–ª—É—á–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Ç–æ—á–µ–∫ (scroll, filter: code == "–ì–û–°–¢ 21.201-2011"): 1 —à—Ç.
[PASS] –£ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 1/1 –ø—Ä–∏–º–µ—Ä–æ–≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è: ['code', 'title', 'section_title']

=== –®–∞–≥ 5 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –¢–µ—Å—Ç RAG endpoint –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ '–û–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è' ===
[PASS] RAG-—Ç–µ—Å—Ç –ø—Ä–æ–ø—É—â–µ–Ω (rag-url –∏–ª–∏ test-query –Ω–µ –∑–∞–¥–∞–Ω—ã).

=== –ò—Ç–æ–≥ ===
[PASS] –≠—Ç–∞–ø—ã 1‚Äì2 –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –ü–†–ò–ù–Ø–¢–´–ú–ò (–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∫–æ–ª–ª–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞, —Å—Ö–µ–º–∞ –≤–µ–∫—Ç–æ—Ä–æ–≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞).
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Qdrant:
```json
{
  "document_id": 11,
  "code": "–ì–û–°–¢ 21.201-2011",
  "title": "–ì–û–°–¢ 21.201-2011 –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–°–ü–î–°). –£—Å–ª–æ–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ..._–¢–µ–∫—Å—Ç.pdf",
  "section_title": "–û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è",
  "content": "–ì–û–°–¢ 21.201-2011 –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–°–ü–î–°). –£—Å–ª–æ–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–¥–∞–Ω–∏–π, —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –ù–∞—Å—Ç–æ—è—â–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —É—Å–ª–æ–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–¥–∞–Ω–∏–π, —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞.",
  "chunk_type": "paragraph",
  "page": 1,
  "section": "–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è",
  "metadata": {}
}
```

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–µ–Ω—ã:

1. ‚úÖ **API Qdrant –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π POST –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫
2. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ payload –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è (`code`, `title`, `section_title`)
3. ‚úÖ **RAG —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç** - —Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—è–∂–µ–ª—ã—Ö –º–æ–¥–µ–ª–µ–π
4. ‚úÖ **–î–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è** - —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. ‚úÖ **–¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é** - –≤—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ
