# Отчет о создании общего модуля утилит для извлечения текста из PDF

## Обзор

Создан универсальный модуль `utils` для извлечения текста из документов различных форматов, который объединяет и улучшает функциональность, ранее разбросанную по разным сервисам проекта AI-NK.

## Структура модуля

```
utils/
├── __init__.py              # Основные экспорты и информация о модуле
├── document_parser.py       # Универсальный парсер документов
├── pdf_utils.py            # Специализированные функции для PDF
├── docx_utils.py           # Специализированные функции для DOCX
├── text_processing.py      # Обработка и очистка текста
├── requirements.txt        # Зависимости модуля
├── README.md              # Документация модуля
└── example_usage.py       # Примеры использования
```

## Ключевые возможности

### 1. Универсальный парсер документов (`UniversalDocumentParser`)

- **Поддерживаемые форматы**: PDF, DOCX, DOC, TXT
- **Гибкие настройки**: выбор метода извлечения, извлечение таблиц и заголовков
- **Иерархическое разделение**: автоматическое создание чанков с сохранением структуры
- **Обработка ошибок**: fallback между различными методами извлечения

### 2. Улучшенное извлечение из PDF (`PDFTextExtractor`)

- **Два метода извлечения**: pdfminer (более точный) и PyPDF2 (быстрый)
- **Автоматический fallback**: при ошибке одного метода используется другой
- **Специальная очистка**: исправление разрывов слов, характерных для PDF
- **Детальная информация**: метаданные о страницах, символах, словах

### 3. Расширенное извлечение из DOCX (`DOCXTextExtractor`)

- **Структурированное извлечение**: отдельная обработка параграфов, заголовков, таблиц
- **Сохранение стилей**: информация о стилях параграфов
- **Обработка таблиц**: извлечение текста из таблиц с сохранением структуры
- **Типизация контента**: определение типов параграфов (заголовок, обычный текст, список)

### 4. Продвинутая обработка текста (`TextProcessor`)

- **Умная очистка**: исправление специфичных проблем PDF (разрывы слов)
- **Нормализация**: удаление лишних пробелов и символов
- **Определение языка**: автоматическое определение языка текста
- **Иерархическое разделение**: разделение на разделы → абзацы → предложения
- **Статистика**: подробная статистика по тексту

## Интеграция с существующими сервисами

### Обновленные сервисы:

1. **outgoing_control_service** - модуль "Выходной контроль корреспонденции"
2. **rag_service** - RAG сервис для работы с документами
3. **vllm_service** - сервис для работы с LLM и документами

### Изменения в коде:

- Заменены дублирующиеся функции извлечения текста
- Добавлены импорты общего модуля utils
- Сохранена обратная совместимость через функции-обертки
- Улучшена обработка ошибок и логирование

## Преимущества нового решения

### 1. Централизация функциональности
- Все функции извлечения текста в одном месте
- Единообразный API для всех форматов документов
- Упрощенное сопровождение и обновление

### 2. Улучшенное качество извлечения
- Использование pdfminer для более точного извлечения из PDF
- Специальная очистка текста для исправления проблем PDF
- Сохранение структуры документа (заголовки, таблицы, параграфы)

### 3. Гибкость и настраиваемость
- Возможность выбора метода извлечения
- Настройка параметров обработки
- Поддержка различных сценариев использования

### 4. Обратная совместимость
- Функции для легкой миграции существующего кода
- Сохранение существующих интерфейсов
- Постепенная замена старых функций

## Примеры использования

### Базовое использование:
```python
from utils import parse_document

result = parse_document("document.pdf")
if result["success"]:
    print(f"Текст: {result['text']}")
    print(f"Страниц: {result['total_pages']}")
```

### Продвинутое использование:
```python
from utils import UniversalDocumentParser

parser = UniversalDocumentParser(
    prefer_pdfminer=True,
    extract_tables=True,
    create_hierarchical_chunks=True
)

result = parser.parse_document("document.docx")
```

### Обработка текста:
```python
from utils import TextProcessor

processor = TextProcessor()
cleaned_text = processor.clean_text(messy_text)
chunks = processor.hierarchical_chunking(cleaned_text)
```

## Технические детали

### Зависимости:
- PyPDF2>=3.0.0 - для работы с PDF
- pdfminer.six>=20221105 - для улучшенного извлечения из PDF
- python-docx>=0.8.11 - для работы с DOCX

### Производительность:
- Автоматический выбор оптимального метода извлечения
- Fallback между методами при ошибках
- Эффективная обработка больших документов

### Обработка ошибок:
- Детальное логирование ошибок
- Graceful degradation при недоступности библиотек
- Информативные сообщения об ошибках

## Документация

Создана полная документация модуля:
- `README.md` - основная документация с примерами
- `example_usage.py` - практические примеры использования
- Docstrings во всех функциях и классах
- Типизация для лучшей поддержки IDE

## Миграция существующего кода

### Для разработчиков:

1. **Замена импортов**:
   ```python
   # Старый код
   from some_module import extract_text_from_pdf
   
   # Новый код
   from utils import parse_document
   ```

2. **Обновление вызовов функций**:
   ```python
   # Старый код
   text = extract_text_from_pdf(file_path)
   
   # Новый код
   result = parse_document(file_path)
   text = result["text"] if result["success"] else ""
   ```

3. **Использование новых возможностей**:
   ```python
   # Получение дополнительной информации
   result = parse_document(file_path)
   if result["success"]:
       text = result["text"]
       pages = result["pages"]
       chunks = result["chunks"]
       metadata = result["metadata"]
   ```

## Заключение

Созданный модуль `utils` значительно улучшает возможности проекта AI-NK по работе с документами:

- ✅ **Унификация**: все функции извлечения текста в одном месте
- ✅ **Улучшение качества**: более точное извлечение и очистка текста
- ✅ **Гибкость**: настраиваемые параметры для разных сценариев
- ✅ **Совместимость**: сохранение существующих интерфейсов
- ✅ **Документация**: полная документация и примеры использования

Модуль готов к использованию во всех сервисах проекта и может быть легко расширен для поддержки дополнительных форматов документов в будущем.
