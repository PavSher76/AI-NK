import asyncio
import httpx
from fastapi import FastAPI, Request, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
import logging
import json
import time
from typing import Dict, Any

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Keycloak middleware
try:
    from keycloak_middleware import keycloak_middleware
    KEYCLOAK_ENABLED = True
    print("üîë [DEBUG] Gateway: Keycloak middleware loaded successfully")
except ImportError:
    KEYCLOAK_ENABLED = False
    print("‚ö†Ô∏è [WARNING] Gateway: Keycloak middleware not available, using fallback authentication")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
def verify_token(authorization_header: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
    print(f"üîç [DEBUG] Gateway: verify_token called with: {authorization_header}")
    
    if not authorization_header:
        print(f"üîç [DEBUG] Gateway: No authorization header provided")
        return False
    
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "Bearer <token>"
        if authorization_header.startswith("Bearer "):
            token = authorization_header[7:]  # –£–±–∏—Ä–∞–µ–º "Bearer "
            print(f"üîç [DEBUG] Gateway: Extracted token: {token[:20]}..." if len(token) > 20 else f"üîç [DEBUG] Gateway: Extracted token: {token}")
            
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            if token == "disabled-auth":
                print(f"üîç [DEBUG] Gateway: Development token 'disabled-auth' accepted")
                return True
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º JWT —Ç–æ–∫–µ–Ω—ã –æ—Ç Keycloak
            if token.startswith("eyJ") and KEYCLOAK_ENABLED:
                try:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Keycloak middleware
                    payload = keycloak_middleware.verify_token(token)
                    if payload:
                        print(f"üîç [DEBUG] Gateway: Keycloak JWT token verified successfully for user: {payload.get('preferred_username')}")
                        return True
                    else:
                        print(f"üîç [DEBUG] Gateway: Keycloak JWT token verification failed")
                        return False
                except Exception as e:
                    print(f"üîç [DEBUG] Gateway: Keycloak JWT token verification error: {e}")
                    return False
            
            # Fallback –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ Keycloak
            if token.startswith("eyJ"):
                print(f"üîç [DEBUG] Gateway: JWT token detected and accepted (fallback): {token[:20]}...")
                return True
            
            print(f"üîç [DEBUG] Gateway: Token not valid JWT: {token}")
            return False
        else:
            print(f"üîç [DEBUG] Gateway: Authorization header doesn't start with 'Bearer ': {authorization_header}")
            return False
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: Token verification error: {e}")
        logger.error(f"Token verification error: {e}")
        return False

app = FastAPI(title="AI-Engineering Gateway", version="1.0.0")

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
SERVICES = {
    "document-parser": "http://document-parser:8001",
    "rag-service": "http://rag-service:8003",
    "rule-engine": "http://rule-engine:8004",
    "calculation-service": "http://calculation-service:8002",
    "outgoing-control-service": "http://outgoing-control-service:8006",
    "spellchecker-service": "http://spellchecker-service:8007",
    "archive-service": "http://archive-service:8008",
    "analog-objects-service": "http://analog-objects-service:8009",
    "normcontrol2-service": "http://normcontrol2-service:8010",
    "ollama": "http://host.docker.internal:11434",  # –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Ollama
    "vllm": "http://vllm:8005"  # VLLM —Å–µ—Ä–≤–∏—Å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
}

print("üîç [DEBUG] Gateway: Starting with services configuration:", SERVICES)

@app.middleware("http")
async def auth_middleware(request: Request, call_next):
    """Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
    print(f"üîç [DEBUG] Gateway: Auth middleware - {request.method} {request.url.path}")
    
    # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –ø—É—Ç–µ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    public_paths = [
        "/health", 
        "/metrics", 
        "/api/health",             # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è RAG-—Å–µ—Ä–≤–∏—Å–∞
        "/api/documents",          # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        "/api/documents/stats",    # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        "/api/documents/",         # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Å —Å–ª—ç—à–µ–º)
        "/api/upload",             # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        "/api/calculation/token",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞
        "/api/calculation/me",     # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        "/api/calculations",       # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        "/api/calculation/calculations",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ calculation prefix
        "/api/calculations/degasification",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–µ–≥–∞–∑–∞—Ü–∏–∏
        "/api/calculation/calculations/degasification",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–µ–≥–∞–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ calculation prefix
        "/api/calculations/degasification/types",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ç–∏–ø–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–µ–≥–∞–∑–∞—Ü–∏–∏
        "/api/calculations/degasification/execute",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–µ–≥–∞–∑–∞—Ü–∏–∏
        "/api/chat/tags",          # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ Ollama
        "/api/chat/health",        # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è Ollama
        "/api/chat",               # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —á–∞—Ç–∞ —Å –ò–ò
        "/api/generate",           # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
        "/api/ntd-consultation/chat",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ù–¢–î
        "/api/ntd-consultation/stats", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
        "/api/ntd-consultation/cache", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º
        "/api/ntd-consultation/cache/stats", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
        "/api/checkable-documents", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        "/api/settings",           # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        "/api/upload/checkable",   # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        "/api/rules",              # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª
        "/api/calculations",       # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
        "/api/rag",                # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è RAG —Å–µ—Ä–≤–∏—Å–∞
        "/api/rag/reasoning-modes", # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
        "/api/ollama",             # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è Ollama
        "/api/vllm",               # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è vLLM
        "/api/outgoing-control",   # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
        "/api/outgoing-control/",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å —Å–ª—ç—à–µ–º
        "/api/spellchecker",       # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏
        "/api/spellchecker/",      # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏ —Å —Å–ª—ç—à–µ–º
        "/api/reindex-documents",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        "/api/reindex-documents/async",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
        "/api/reindex-documents/status",  # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
        "/api/normcontrol2",       # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å - 2
        "/api/normcontrol2/"       # –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å - 2 —Å —Å–ª—ç—à–µ–º
    ]
    
    print(f"üîç [DEBUG] Gateway: Checking path '{request.url.path}' against public paths: {public_paths}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if request.url.path in public_paths:
        print(f"üîç [DEBUG] Gateway: Skipping auth for exact match {request.url.path}")
        return await call_next(request)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è API –ø—É—Ç–µ–π
    api_prefixes = [
        "/api/upload",
        "/api/documents",
        "/api/chat",
        "/api/generate", 
        "/api/ntd-consultation",
        "/api/checkable-documents",
        "/api/settings",
        "/api/rules",
        "/api/calculations",
        "/api/rag",
        "/api/ollama",
        "/api/vllm",
        "/api/outgoing-control",
        "/api/spellchecker",
        "/api/reindex-documents",
        "/api/normcontrol2"
    ]
    
    for prefix in api_prefixes:
        if request.url.path.startswith(prefix):
            print(f"üîç [DEBUG] Gateway: Skipping auth for prefix match {request.url.path} (prefix: {prefix})")
            return await call_next(request)
    
    print(f"üîç [DEBUG] Gateway: Path '{request.url.path}' not in public paths or prefixes")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    authorization_header = request.headers.get("authorization")
    print(f"üîç [DEBUG] Gateway: Authorization header: {authorization_header}")
    
    if not verify_token(authorization_header):
        print(f"üîç [DEBUG] Gateway: Authorization failed for {request.url.path}")
        return JSONResponse(
            content={"detail": "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –≤ Gateway"},
            status_code=401
        )
    
    print(f"üîç [DEBUG] Gateway: Authorization successful for {request.url.path}")
    return await call_next(request)

@app.middleware("http")
async def log_requests(request: Request, call_next):
    """Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    start_time = time.time()
    
    print(f"üîç [DEBUG] Gateway: Incoming request - {request.method} {request.url.path}")
    print(f"üîç [DEBUG] Gateway: Request headers: {dict(request.headers)}")
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if request.method in ["POST", "PUT", "PATCH"]:
        try:
            body = await request.body()
            print(f"üîç [DEBUG] Gateway: Request body length: {len(body)} bytes")
            if len(body) < 1000:  # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–±–æ–ª—å—à–∏–µ —Ç–µ–ª–∞
                print(f"üîç [DEBUG] Gateway: Request body preview: {body[:200]}...")
        except Exception as e:
            print(f"üîç [DEBUG] Gateway: Error reading request body: {e}")
    
    response = await call_next(request)
    
    process_time = time.time() - start_time
    print(f"üîç [DEBUG] Gateway: Request processed in {process_time:.3f}s - Status: {response.status_code}")
    
    return response

async def proxy_request(request: Request, service_url: str, path: str = "") -> JSONResponse:
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–∏—Å—É —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    print(f"üîç [DEBUG] Gateway: Proxying request to {service_url}{path}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
    method = request.method
    print(f"üîç [DEBUG] Gateway: Request method: {method}")
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    headers = dict(request.headers)
    print(f"üîç [DEBUG] Gateway: Original headers: {headers}")
    
    # –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
    headers_to_remove = ["host", "content-length"]
    for header in headers_to_remove:
        headers.pop(header.lower(), None)
    
    print(f"üîç [DEBUG] Gateway: Cleaned headers: {headers}")
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º URL —Å query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    target_url = f"{service_url}{path}"
    if request.url.query:
        target_url += f"?{request.url.query}"
    print(f"üîç [DEBUG] Gateway: Target URL: {target_url}")
    
    try:
        async with httpx.AsyncClient(timeout=600.0) as client:
            print(f"üîç [DEBUG] Gateway: Creating httpx client with timeout 600s")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ multipart/form-data
            if "multipart/form-data" in headers.get("content-type", ""):
                print(f"üîç [DEBUG] Gateway: Processing multipart/form-data request")
                print(f"üîç [DEBUG] Gateway: Content-Type: {headers.get('content-type', 'Not set')}")
                
                # –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
                body = await request.body()
                print(f"üîç [DEBUG] Gateway: Body length: {len(body)} bytes")
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–ª–æ–º
                response = await client.post(
                    target_url,
                    content=body,
                    headers=headers
                )
                print(f"üîç [DEBUG] Gateway: Response status: {response.status_code}")
                print(f"üîç [DEBUG] Gateway: Response headers: {dict(response.headers)}")
                
                # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                try:
                    response_text = response.text
                    print(f"üîç [DEBUG] Gateway: Response body length: {len(response_text)}")
                    if len(response_text) < 500:  # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–±–æ–ª—å—à–∏–µ –æ—Ç–≤–µ—Ç—ã
                        print(f"üîç [DEBUG] Gateway: Response body: {response_text}")
                    else:
                        print(f"üîç [DEBUG] Gateway: Response body preview: {response_text[:200]}...")
                except Exception as e:
                    print(f"üîç [DEBUG] Gateway: Error reading response body: {e}")
                
                return JSONResponse(
                    content=response.json() if response.headers.get("content-type", "").startswith("application/json") else {"detail": response.text},
                    status_code=response.status_code
                )
            else:
                # –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
                print(f"üîç [DEBUG] Gateway: Processing regular request")
                
                # –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
                body = await request.body()
                print(f"üîç [DEBUG] Gateway: Body length: {len(body)} bytes")
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                response = await client.request(
                    method,
                    target_url,
                    content=body,
                    headers=headers
                )
                print(f"üîç [DEBUG] Gateway: Response status: {response.status_code}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                content_type = response.headers.get("content-type", "")
                print(f"üîç [DEBUG] Gateway: Response content-type: {content_type}")
                
                # –î–ª—è PDF, DOCX –∏ –¥—Ä—É–≥–∏—Ö –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Response
                if (content_type.startswith("application/pdf") or 
                    content_type.startswith("application/octet-stream") or
                    content_type.startswith("application/vnd.openxmlformats-officedocument")):
                    print(f"üîç [DEBUG] Gateway: Returning binary response for content-type: {content_type}")
                    from fastapi.responses import Response
                    return Response(
                        content=response.content,
                        media_type=content_type,
                        headers=dict(response.headers)
                    )
                else:
                    # –î–ª—è JSON –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º JSONResponse
                    return JSONResponse(
                        content=response.json() if content_type.startswith("application/json") else {"detail": response.text},
                        status_code=response.status_code
                    )
                
    except httpx.ConnectError as e:
        print(f"üîç [DEBUG] Gateway: Connection error to {service_url}: {e}")
        return JSONResponse(
            content={"detail": f"Service unavailable: {str(e)}"},
            status_code=503
        )
    except httpx.TimeoutException as e:
        print(f"üîç [DEBUG] Gateway: Timeout error to {service_url}: {e}")
        return JSONResponse(
            content={"detail": f"Request timeout: {str(e)}"},
            status_code=504
        )
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: Unexpected error: {e}")
        return JSONResponse(
            content={"detail": f"Proxy error: {str(e)}"},
            status_code=500
        )

# Analog Objects Service endpoints (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥ /api/v1/{path:path})
@app.api_route("/api/analog-objects", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def analog_objects_root_proxy(request: Request):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∫–æ—Ä–Ω–µ–≤–æ–º—É –ø—É—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–æ–≤"""
    print(f"üîç [DEBUG] Gateway: Analog objects root proxy request")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º URL —Å–µ—Ä–≤–∏—Å–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–æ–≤
        service_url = SERVICES.get("analog-objects-service")
        if not service_url:
            raise HTTPException(status_code=503, detail="Analog objects service not available")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
        full_url = f"{service_url}/api/analog-objects"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        body = None
        if request.method in ["POST", "PUT", "PATCH"]:
            body = await request.body()
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        headers = dict(request.headers)
        
        # –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
        headers_to_remove = ["host", "content-length"]
        for header in headers_to_remove:
            headers.pop(header, None)
        
        print(f"üîç [DEBUG] Gateway: Forwarding to {full_url}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–æ–≤
        async with httpx.AsyncClient(timeout=300.0) as client:
            response = await client.request(
                method=request.method,
                url=full_url,
                headers=headers,
                content=body,
                params=request.query_params
            )
            
            print(f"üîç [DEBUG] Gateway: Analog objects service response: {response.status_code}")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.headers.get("content-type", "").startswith("application/json"):
                return JSONResponse(
                    content=response.json(),
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            else:
                from fastapi.responses import Response
                return Response(
                    content=response.content,
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            
    except httpx.TimeoutException:
        print(f"üîç [DEBUG] Gateway: Analog objects service timeout")
        raise HTTPException(status_code=504, detail="Analog objects service timeout")
    except httpx.ConnectError:
        print(f"üîç [DEBUG] Gateway: Analog objects service connection error")
        raise HTTPException(status_code=503, detail="Analog objects service unavailable")
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: Analog objects proxy exception: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.api_route("/api/analog-objects/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def analog_objects_proxy(path: str, request: Request):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–∏—Å—É –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–æ–≤"""
    print(f"üîç [DEBUG] Gateway: Analog objects proxy request to path: {path}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º URL —Å–µ—Ä–≤–∏—Å–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–æ–≤
        service_url = SERVICES.get("analog-objects-service")
        if not service_url:
            raise HTTPException(status_code=503, detail="Analog objects service not available")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
        full_url = f"{service_url}/api/analog-objects/{path}"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        body = None
        if request.method in ["POST", "PUT", "PATCH"]:
            body = await request.body()
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        headers = dict(request.headers)
        
        # –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
        headers_to_remove = ["host", "content-length"]
        for header in headers_to_remove:
            headers.pop(header, None)
        
        print(f"üîç [DEBUG] Gateway: Forwarding to {full_url}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–æ–≤
        async with httpx.AsyncClient(timeout=300.0) as client:
            response = await client.request(
                method=request.method,
                url=full_url,
                headers=headers,
                content=body,
                params=request.query_params
            )
            
            print(f"üîç [DEBUG] Gateway: Analog objects service response: {response.status_code}")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.headers.get("content-type", "").startswith("application/json"):
                return JSONResponse(
                    content=response.json(),
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            else:
                from fastapi.responses import Response
                return Response(
                    content=response.content,
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            
    except httpx.TimeoutException:
        print(f"üîç [DEBUG] Gateway: Analog objects service timeout")
        raise HTTPException(status_code=504, detail="Analog objects service timeout")
    except httpx.ConnectError:
        print(f"üîç [DEBUG] Gateway: Analog objects service connection error")
        raise HTTPException(status_code=503, detail="Analog objects service unavailable")
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: Analog objects proxy exception: {e}")
        raise HTTPException(status_code=500, detail=str(e))

# –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API v1 (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥ /api/{path:path})
@app.api_route("/api/v1/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def proxy_api_v1(request: Request, path: str):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API v1"""
    print(f"üîç [DEBUG] Gateway: API v1 route called with path: {path}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É—Ç–∏
    if path.startswith("documents"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing API v1 to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("checkable-documents"):
        service_url = SERVICES["document-parser"]
        print(f"üîç [DEBUG] Gateway: Routing API v1 to document-parser: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("calculations") or path.startswith("calculation"):
        service_url = SERVICES["calculation-service"]
        print(f"üîç [DEBUG] Gateway: Routing API v1 to calculation-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("rag"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing API v1 to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    else:
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ document-parser
        service_url = SERVICES["document-parser"]
        print(f"üîç [DEBUG] Gateway: Routing API v1 to document-parser (default): {service_url}")
        return await proxy_request(request, service_url, f"/{path}")


# API Health check endpoint (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥ –æ–±—â–∏–º /api/{path:path})
@app.get("/api/health")
async def api_health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è API —á–µ—Ä–µ–∑ RAG service"""
    print("üîç [DEBUG] Gateway: API Health check requested")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º RAG service
        rag_service_url = SERVICES["rag-service"]
        async with httpx.AsyncClient(timeout=10.0) as client:
            response = await client.get(f"{rag_service_url}/health")
            if response.status_code == 200:
                rag_health = response.json()
                health_status = {
                    "status": "healthy",
                    "service": "gateway",
                    "rag_service": rag_health,
                    "timestamp": time.time()
                }
            else:
                health_status = {
                    "status": "unhealthy",
                    "service": "gateway",
                    "rag_service": {"status": "unhealthy", "error": f"HTTP {response.status_code}"},
                    "timestamp": time.time()
                }
    except Exception as e:
        health_status = {
            "status": "unhealthy",
            "service": "gateway",
            "rag_service": {"status": "unhealthy", "error": str(e)},
            "timestamp": time.time()
        }
    
    print(f"üîç [DEBUG] Gateway: API Health check response: {health_status}")
    return health_status

# –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ document-parser
@app.api_route("/api/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def proxy_api(request: Request, path: str):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ document-parser"""
    print(f"üîç [DEBUG] Gateway: API route called with path: {path}")
    print(f"üîç [DEBUG] Gateway: Full URL: {request.url}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É—Ç–∏
    print(f"üîç [DEBUG] Gateway: Checking path: '{path}'")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ endpoints –æ—Ç–¥–µ–ª—å–Ω–æ
    if path.startswith("outgoing-control"):
        print(f"üîç [DEBUG] Gateway: Routing outgoing-control to outgoing-control-service")
        service_url = SERVICES["outgoing-control-service"]
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å outgoing-control –∏–∑ –ø—É—Ç–∏
        clean_path = path.replace("outgoing-control/", "")
        return await proxy_request(request, service_url, f"/{clean_path}")
    
    if path.startswith("spellchecker"):
        print(f"üîç [DEBUG] Gateway: Routing spellchecker to spellchecker-service")
        service_url = SERVICES["spellchecker-service"]
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å spellchecker –∏–∑ –ø—É—Ç–∏
        clean_path = path.replace("spellchecker/", "")
        return await proxy_request(request, service_url, f"/{clean_path}")
    
    if path.startswith("ollama/"):
        print(f"üîç [DEBUG] Gateway: Routing ollama endpoint to document-parser with /api prefix")
        service_url = SERVICES["document-parser"]
        return await proxy_request(request, service_url, f"/api/{path}")
    
    if path.startswith("normcontrol/"):
        print(f"üîç [DEBUG] Gateway: Routing normcontrol endpoint to document-parser with /api prefix")
        service_url = SERVICES["document-parser"]
        return await proxy_request(request, service_url, f"/api/{path}")
    
    if path.startswith("checkable-documents") or path.startswith("settings"):
        service_url = SERVICES["document-parser"]
        print(f"üîç [DEBUG] Gateway: Routing to document-parser: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("upload/checkable"):
        service_url = SERVICES["document-parser"]
        print(f"üîç [DEBUG] Gateway: Routing upload/checkable to document-parser: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("upload"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing upload to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("documents"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("reindex-documents") or path.startswith("reindex"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing reindex to rag-service: {service_url}")
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç—å –¥–ª—è RAG —Å–µ—Ä–≤–∏—Å–∞
        if path == "reindex-documents":
            clean_path = "reindex"
        elif path == "reindex-documents/async":
            clean_path = "reindex/async"
        elif path.startswith("reindex-documents/status/"):
            task_id = path.replace("reindex-documents/status/", "")
            clean_path = f"reindex/status/{task_id}"
        else:
            clean_path = path.replace("reindex-documents", "reindex")
        print(f"üîç [DEBUG] Gateway: Cleaned path for RAG service: {clean_path}")
        return await proxy_request(request, service_url, f"/{clean_path}")
    elif path.startswith("ntd-consultation"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing NTD consultation to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("rag/"):
        service_url = SERVICES["rag-service"]
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "rag/" –∏–∑ –ø—É—Ç–∏
        path = path[4:]  # –£–±–∏—Ä–∞–µ–º "rag/"
        print(f"üîç [DEBUG] Gateway: Routing to rag-service: {service_url} with path: {path}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("rules"):
        service_url = SERVICES["rule-engine"]
        print(f"üîç [DEBUG] Gateway: Routing to rule-engine: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("calculations") or path.startswith("calculation"):
        service_url = SERVICES["calculation-service"]
        print(f"üîç [DEBUG] Gateway: Routing to calculation-service: {service_url}")
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "calculation/" –∏–∑ –ø—É—Ç–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if path.startswith("calculation/"):
            path = path[12:]  # –£–±–∏—Ä–∞–µ–º "calculation/"
        print(f"üîç [DEBUG] Gateway: Proxying request to {service_url}/{path}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("chat/health"):
        service_url = SERVICES["vllm"]
        print(f"üîç [DEBUG] Gateway: Routing chat/health to vllm service: {service_url}")
        return await proxy_request(request, service_url, "/health")
    elif path.startswith("chat/tags"):
        service_url = SERVICES["vllm"]
        print(f"üîç [DEBUG] Gateway: Routing chat/tags to vllm service: {service_url}")
        return await proxy_request(request, service_url, "/models")
    elif path.startswith("chat") or path.startswith("generate"):
        service_url = SERVICES["vllm"]
        print(f"üîç [DEBUG] Gateway: Routing to vllm service: {service_url} with path: {path}")
        # –î–ª—è —á–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞–µ–º –ø—É—Ç—å –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ api/
        clean_path = path.replace("api/", "") if path.startswith("api/") else path
        return await proxy_request(request, service_url, f"/{clean_path}")
    elif path.startswith("normcontrol2"):
        service_url = SERVICES["normcontrol2-service"]
        print(f"üîç [DEBUG] Gateway: Routing normcontrol2 to service: {service_url}")
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å api/ –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º normcontrol2
        clean_path = path.replace("api/", "") if path.startswith("api/") else path
        return await proxy_request(request, service_url, f"/{clean_path}")
    else:
        print(f"üîç [DEBUG] Gateway: Unknown path, defaulting to document-parser")
        service_url = SERVICES["document-parser"]
        return await proxy_request(request, service_url, f"/{path}")

# –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ VLLM
@app.api_route("/v1/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def proxy_vllm(request: Request, path: str):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ VLLM"""
    print(f"üîç [DEBUG] Gateway: VLLM route called with path: {path}")
    
    service_url = SERVICES["vllm"]
    return await proxy_request(request, service_url, f"/api/{path}")

# –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Ollama API
@app.api_route("/ollama/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def proxy_ollama_api(request: Request, path: str):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Ollama API"""
    print(f"üîç [DEBUG] Gateway: Ollama API route called with path: {path}")
    
    service_url = SERVICES["ollama"]
    return await proxy_request(request, service_url, f"/{path}")

# –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Calculation Service
@app.api_route("/calculation/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def proxy_calculation_api(request: Request, path: str):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Calculation Service"""
    print(f"üîç [DEBUG] Gateway: Calculation API route called with path: {path}")
    
    service_url = SERVICES["calculation-service"]
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "calculation/" –∏–∑ –ø—É—Ç–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if path.startswith("calculation/"):
        path = path[12:]  # –£–±–∏—Ä–∞–µ–º "calculation/"
    print(f"üîç [DEBUG] Gateway: Proxying request to {service_url}/{path}")
    return await proxy_request(request, service_url, f"/{path}")

# –û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
@app.api_route("/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def proxy_main(request: Request, path: str):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π"""
    print(f"üîç [DEBUG] Gateway: Main route called with path: {path}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏ –¥–ª—è outgoing-control
    if path.startswith("api/outgoing-control") or path.startswith("outgoing-control"):
        print(f"üîç [DEBUG] Gateway: Detected outgoing-control path: {path}")
        service_url = SERVICES["outgoing-control-service"]
        print(f"üîç [DEBUG] Gateway: Routing outgoing-control to service: {service_url}")
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å api/ –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º outgoing-control
        clean_path = path.replace("api/", "") if path.startswith("api/") else path
        return await proxy_request(request, service_url, f"/{clean_path}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É—Ç–∏
    if path == "metrics":
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç metrics
        return await metrics()
    elif path.startswith("checkable-documents") or path.startswith("settings"):
        service_url = SERVICES["document-parser"]
        print(f"üîç [DEBUG] Gateway: Routing to document-parser: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("upload/checkable"):
        service_url = SERVICES["document-parser"]
        print(f"üîç [DEBUG] Gateway: Routing upload/checkable to document-parser: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("upload"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing upload to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("documents"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("reindex"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing reindex to rag-service: {service_url}")
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç—å –¥–ª—è RAG —Å–µ—Ä–≤–∏—Å–∞
        if path == "reindex-documents":
            clean_path = "reindex"
        elif path == "reindex-documents/async":
            clean_path = "reindex/async"
        elif path.startswith("reindex-documents/status/"):
            task_id = path.replace("reindex-documents/status/", "")
            clean_path = f"reindex/status/{task_id}"
        else:
            clean_path = path.replace("reindex-documents", "reindex")
        print(f"üîç [DEBUG] Gateway: Cleaned path for RAG service: {clean_path}")
        return await proxy_request(request, service_url, f"/{clean_path}")
    elif path.startswith("ntd-consultation"):
        service_url = SERVICES["rag-service"]
        print(f"üîç [DEBUG] Gateway: Routing NTD consultation to rag-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("rag/"):
        service_url = SERVICES["rag-service"]
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "rag/" –∏–∑ –ø—É—Ç–∏
        path = path[4:]  # –£–±–∏—Ä–∞–µ–º "rag/"
        print(f"üîç [DEBUG] Gateway: Routing to rag-service: {service_url} with path: {path}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("rules"):
        service_url = SERVICES["rule-engine"]
        print(f"üîç [DEBUG] Gateway: Routing to rule-engine: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("calculations") or path.startswith("calculation"):
        service_url = SERVICES["calculation-service"]
        print(f"üîç [DEBUG] Gateway: Routing to calculation-service: {service_url}")
        return await proxy_request(request, service_url, f"/{path}")
    elif path.startswith("chat/health"):
        service_url = SERVICES["vllm"]
        print(f"üîç [DEBUG] Gateway: Routing chat/health to vllm service: {service_url}")
        return await proxy_request(request, service_url, "/health")
    elif path.startswith("chat/tags"):
        service_url = SERVICES["vllm"]
        print(f"üîç [DEBUG] Gateway: Routing chat/tags to vllm service: {service_url}")
        return await proxy_request(request, service_url, "/models")
    elif path.startswith("chat") or path.startswith("generate"):
        service_url = SERVICES["vllm"]
        print(f"üîç [DEBUG] Gateway: Routing to vllm service: {service_url} with path: {path}")
        # –î–ª—è —á–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞–µ–º –ø—É—Ç—å –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ api/
        clean_path = path.replace("api/", "") if path.startswith("api/") else path
        return await proxy_request(request, service_url, f"/{clean_path}")
    elif path.startswith("outgoing-control") or path.startswith("api/outgoing-control"):
        service_url = SERVICES["outgoing-control-service"]
        print(f"üîç [DEBUG] Gateway: Routing outgoing-control to service: {service_url}")
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å api/ –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º outgoing-control
        clean_path = path.replace("api/", "") if path.startswith("api/") else path
        return await proxy_request(request, service_url, f"/{clean_path}")
    else:
        print(f"üîç [DEBUG] Gateway: Unknown path, defaulting to document-parser")
        service_url = SERVICES["document-parser"]
        return await proxy_request(request, service_url, f"/{path}")

# Health check endpoint
@app.get("/health")
async def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è gateway"""
    print("üîç [DEBUG] Gateway: Health check requested")
    
    health_status = {
        "status": "healthy",
        "service": "gateway",
        "timestamp": time.time()
    }
    
    print(f"üîç [DEBUG] Gateway: Health check response: {health_status}")
    return health_status


# Metrics endpoint
@app.get("/metrics")
async def metrics():
    """–ú–µ—Ç—Ä–∏–∫–∏ gateway –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus"""
    print("üîç [DEBUG] Gateway: Metrics requested")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus
    metrics_lines = []
    
    # –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ gateway
    metrics_lines.append(f"# HELP gateway_up Gateway service is up")
    metrics_lines.append(f"# TYPE gateway_up gauge")
    metrics_lines.append(f"gateway_up 1")
    
    metrics_lines.append(f"# HELP gateway_uptime_seconds Gateway uptime in seconds")
    metrics_lines.append(f"# TYPE gateway_uptime_seconds gauge")
    metrics_lines.append(f"gateway_uptime_seconds {time.time()}")
    
    metrics_lines.append(f"# HELP gateway_requests_processed_total Total requests processed")
    metrics_lines.append(f"# TYPE gateway_requests_processed_total counter")
    metrics_lines.append(f"gateway_requests_processed_total 0")
    
    print(f"üîç [DEBUG] Gateway: Metrics response generated")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus
    from fastapi.responses import Response
    return Response(
        content="\n".join(metrics_lines),
        media_type="text/plain; version=0.0.4; charset=utf-8"
    )

# VLLM Models endpoint
@app.get("/api/vllm/models")
async def get_vllm_models():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π –æ—Ç VLLM —Å–µ—Ä–≤–∏—Å–∞"""
    print("üîç [DEBUG] Gateway: VLLM models requested")
    
    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            response = await client.get(f"{SERVICES['vllm']}/models")
            if response.status_code == 200:
                models_data = response.json()
                print(f"üîç [DEBUG] Gateway: VLLM models response: {models_data}")
                return models_data
            else:
                print(f"üîç [DEBUG] Gateway: VLLM models error: {response.status_code}")
                return {"error": "VLLM service unavailable", "status": "error"}
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: VLLM models exception: {e}")
        return {"error": str(e), "status": "error"}

# Archive Service endpoints
@app.api_route("/api/archive/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def archive_proxy(path: str, request: Request):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–∏—Å—É –∞—Ä—Ö–∏–≤–∞"""
    print(f"üîç [DEBUG] Gateway: Archive proxy request to path: {path}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º URL —Å–µ—Ä–≤–∏—Å–∞ –∞—Ä—Ö–∏–≤–∞
        service_url = SERVICES.get("archive-service")
        if not service_url:
            raise HTTPException(status_code=503, detail="Archive service not available")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
        full_url = f"{service_url}/archive/{path}"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        body = None
        if request.method in ["POST", "PUT", "PATCH"]:
            body = await request.body()
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        headers = dict(request.headers)
        
        # –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
        headers_to_remove = ["host", "content-length"]
        for header in headers_to_remove:
            headers.pop(header, None)
        
        print(f"üîç [DEBUG] Gateway: Forwarding to {full_url}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É –∞—Ä—Ö–∏–≤–∞
        async with httpx.AsyncClient(timeout=300.0) as client:
            response = await client.request(
                method=request.method,
                url=full_url,
                headers=headers,
                content=body,
                params=request.query_params
            )
            
            print(f"üîç [DEBUG] Gateway: Archive service response: {response.status_code}")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.headers.get("content-type", "").startswith("application/json"):
                return JSONResponse(
                    content=response.json(),
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            else:
                from fastapi.responses import Response
                return Response(
                    content=response.content,
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            
    except httpx.TimeoutException:
        print(f"üîç [DEBUG] Gateway: Archive service timeout")
        raise HTTPException(status_code=504, detail="Archive service timeout")
    except httpx.ConnectError:
        print(f"üîç [DEBUG] Gateway: Archive service connection error")
        raise HTTPException(status_code=503, detail="Archive service unavailable")
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: Archive proxy exception: {e}")
        raise HTTPException(status_code=500, detail=str(e))

# NormControl2 Service endpoints
@app.api_route("/api/normcontrol2/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH"])
async def normcontrol2_proxy(path: str, request: Request):
    """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–∏—Å—É –ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å - 2"""
    print(f"üîç [DEBUG] Gateway: NormControl2 proxy request to path: {path}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º URL —Å–µ—Ä–≤–∏—Å–∞ normcontrol2
        service_url = SERVICES.get("normcontrol2-service")
        if not service_url:
            raise HTTPException(status_code=503, detail="NormControl2 service not available")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
        full_url = f"{service_url}/normcontrol2/{path}"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        body = None
        if request.method in ["POST", "PUT", "PATCH"]:
            body = await request.body()
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        headers = dict(request.headers)
        
        # –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
        headers_to_remove = ["host", "content-length"]
        for header in headers_to_remove:
            headers.pop(header, None)
        
        print(f"üîç [DEBUG] Gateway: Forwarding to {full_url}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É normcontrol2
        async with httpx.AsyncClient(timeout=300.0) as client:
            response = await client.request(
                method=request.method,
                url=full_url,
                headers=headers,
                content=body,
                params=request.query_params
            )
            
            print(f"üîç [DEBUG] Gateway: NormControl2 service response: {response.status_code}")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.headers.get("content-type", "").startswith("application/json"):
                return JSONResponse(
                    content=response.json(),
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            else:
                from fastapi.responses import Response
                return Response(
                    content=response.content,
                    status_code=response.status_code,
                    headers=dict(response.headers)
                )
            
    except httpx.TimeoutException:
        print(f"üîç [DEBUG] Gateway: NormControl2 service timeout")
        raise HTTPException(status_code=504, detail="NormControl2 service timeout")
    except httpx.ConnectError:
        print(f"üîç [DEBUG] Gateway: NormControl2 service connection error")
        raise HTTPException(status_code=503, detail="NormControl2 service unavailable")
    except Exception as e:
        print(f"üîç [DEBUG] Gateway: NormControl2 proxy exception: {e}")
        raise HTTPException(status_code=500, detail=str(e))


if __name__ == "__main__":
    print("üîç [DEBUG] Gateway: Starting FastAPI application")
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8443)