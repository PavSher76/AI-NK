@startuml NTD Consultation Process

!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title Схема консультации НТД от ИИ

actor "Пользователь" as User
participant "API Gateway" as Gateway
participant "RAG Service" as RAG
participant "NTDConsultationService" as Service
participant "Qdrant" as Qdrant
participant "PostgreSQL" as DB
participant "VLLM Adapter" as VLLM
participant "LLM (Llama 3.1:8B)" as LLM

== Получение запроса ==
User -> Gateway: POST /ntd-consultation/chat
Gateway -> RAG: Передача запроса
RAG -> Service: get_consultation(message, history)
Service -> Service: Валидация входных данных

== Поиск релевантных документов ==
Service -> Service: _search_relevant_documents()
Service -> Service: _get_query_vector() [ЗАГЛУШКА]
Service -> Qdrant: Поиск по вектору
Qdrant -> Service: Топ-5 документов
Service -> DB: Получение метаданных
DB -> Service: Информация о документах

== Формирование контекста ==
Service -> Service: _build_context()
Service -> Service: Структурирование информации
Service -> Service: Ограничение длины контекста

== Генерация ответа ИИ ==
Service -> Service: _build_prompt()
Service -> VLLM: POST /v1/chat/completions
VLLM -> LLM: Генерация ответа
LLM -> VLLM: Ответ ИИ
VLLM -> Service: Структурированный ответ

== Подготовка ответа ==
Service -> Service: _prepare_sources()
Service -> Service: _calculate_confidence()
Service -> RAG: Формирование ответа
RAG -> Gateway: Структурированный ответ
Gateway -> User: Ответ с источниками

== Обработка ошибок ==
alt Ошибка поиска
    Service -> Service: Логирование ошибки
    Service -> RAG: Ответ об ошибке
    RAG -> Gateway: Сообщение об ошибке
    Gateway -> User: Уведомление об ошибке
end

alt Ошибка генерации
    VLLM -> Service: Ошибка LLM
    Service -> RAG: Fallback ответ
    RAG -> Gateway: Альтернативный ответ
    Gateway -> User: Сообщение о проблеме
end

@enduml
