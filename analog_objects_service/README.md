# Сервис объектов аналогов

Сервис для управления базой данных объектов аналогов в системе AI-NK.

## Описание

Сервис предоставляет API для:
- Создания, чтения, обновления и удаления объектов аналогов
- Пакетной загрузки объектов из файлов (CSV, Excel)
- Поиска и фильтрации объектов
- Загрузки файлов (изображения, документы) для объектов
- Аналитики и статистики по объектам

## Функциональность

### Основные возможности
- **Управление объектами**: CRUD операции для объектов аналогов
- **Пакетная загрузка**: Импорт объектов из CSV/Excel файлов
- **Поиск и фильтрация**: Поиск по названию, описанию, застройщику с фильтрами
- **Файловые вложения**: Загрузка изображений и документов
- **Аналитика**: Статистика по типам, регионам, годам
- **Связи между объектами**: Создание связей между похожими объектами

### Типы объектов
- Жилые (многоквартирные дома, жилые комплексы)
- Коммерческие (офисные здания, торговые центры)
- Промышленные (заводы, склады, технопарки)
- Социальные (школы, больницы, детские сады)

## API Эндпоинты

### Основные операции
- `GET /api/analog-objects` - Список объектов с фильтрацией и пагинацией
- `GET /api/analog-objects/{id}` - Детальная информация об объекте
- `POST /api/analog-objects` - Создание нового объекта
- `PUT /api/analog-objects/{id}` - Обновление объекта
- `DELETE /api/analog-objects/{id}` - Удаление объекта

### Файлы
- `POST /api/analog-objects/upload` - Загрузка файлов для объекта

### Аналитика
- `GET /api/analog-objects/analytics/summary` - Сводная аналитика

### Импорт
- `POST /api/analog-objects/import` - Импорт объектов из файла

## Структура базы данных

### Основные таблицы
- `analog_objects` - Основная информация об объектах
- `analog_object_characteristics` - Дополнительные характеристики
- `analog_object_files` - Прикрепленные файлы
- `analog_object_relations` - Связи между объектами
- `analog_search_queries` - История поисковых запросов
- `analog_analytics` - Аналитические данные
- `analog_imports` - История импортов
- `analog_activity_log` - Лог действий пользователей

## Установка и запуск

### Локальная разработка
```bash
# Установка зависимостей
pip install -r requirements.txt

# Настройка переменных окружения
export DATABASE_URL="postgresql://user:password@localhost:5432/database"
export UPLOAD_DIR="/path/to/uploads"
export MAX_FILE_SIZE=104857600

# Запуск сервиса
python main.py
```

### Docker
```bash
# Сборка образа
docker build -t analog-objects-service .

# Запуск контейнера
docker run -p 8009:8009 \
  -e DATABASE_URL="postgresql://user:password@host:5432/database" \
  -e UPLOAD_DIR="/app/uploads" \
  analog-objects-service
```

### Docker Compose
Сервис автоматически запускается через docker-compose.yaml:
```bash
docker-compose up analog-objects-service
```

## Конфигурация

### Переменные окружения
- `DATABASE_URL` - URL подключения к PostgreSQL
- `UPLOAD_DIR` - Директория для загрузки файлов
- `MAX_FILE_SIZE` - Максимальный размер файла (по умолчанию 100MB)

### Настройка базы данных
Выполните SQL скрипт для создания таблиц:
```bash
psql -d your_database -f ../sql/create_analog_objects_tables.sql
```

## Использование

### Создание объекта
```bash
curl -X POST "http://localhost:8009/api/analog-objects" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "name=Жилой комплекс Северный&type=Жилой&region=Московская область&city=Химки&year=2023&area=45000&floors=25&apartments=320&developer=ООО Северстрой"
```

### Поиск объектов
```bash
curl "http://localhost:8009/api/analog-objects?search=северный&type=Жилой&region=Московская область&page=1&limit=10"
```

### Загрузка файлов
```bash
curl -X POST "http://localhost:8009/api/analog-objects/upload" \
  -F "object_id=1" \
  -F "files=@image1.jpg" \
  -F "files=@document.pdf"
```

### Получение аналитики
```bash
curl "http://localhost:8009/api/analog-objects/analytics/summary"
```

## Интеграция с фронтендом

Сервис интегрирован с фронтендом через API Gateway:
- Основная страница: `/analog-objects`
- Пакетная загрузка: `/analog-objects-upload`
- Поиск аналогов: `/analog-objects-search`
- Аналитика: `/analog-objects-analytics`

## Мониторинг и логирование

Сервис предоставляет:
- Health check endpoint: `GET /health`
- Подробное логирование всех операций
- Метрики производительности
- Обработка ошибок с детальными сообщениями

## Безопасность

- Проверка авторизации через API Gateway
- Валидация входных данных
- Ограничение размера загружаемых файлов
- Санитизация SQL запросов
- Логирование всех действий пользователей

## Производительность

- Connection pooling для PostgreSQL
- Индексы для оптимизации поиска
- Пагинация для больших наборов данных
- Кэширование часто запрашиваемых данных
- Асинхронная обработка файлов

## Разработка

### Структура проекта
```
analog_objects_service/
├── main.py              # Основной файл приложения
├── requirements.txt     # Python зависимости
├── Dockerfile          # Docker конфигурация
└── README.md           # Документация
```

### Добавление новых функций
1. Добавьте новые эндпоинты в `main.py`
2. Обновите схему базы данных при необходимости
3. Добавьте тесты для новых функций
4. Обновите документацию

## Поддержка

Для получения поддержки:
1. Проверьте логи сервиса
2. Убедитесь в корректности конфигурации
3. Проверьте состояние базы данных
4. Обратитесь к команде разработки
