# Сравнительный анализ маршрутов обработки документов

## Основные различия

| Аспект | Нормативный документ | Проверяемый документ |
|--------|---------------------|---------------------|
| **Назначение** | База знаний для поиска | Объект проверки |
| **Обработка** | Асинхронная | Синхронная |
| **Индексация** | Полная (RAG) | Отсутствует |
| **Автоматическая проверка** | Нет | Да |
| **Хранение контента** | Чанки + метаданные | Полный контент |
| **Поиск** | Гибридный (векторный + BM25) | Не применимо |

## Детальное сравнение

### 1. Цель и назначение

**Нормативный документ:**
- Служит как база знаний для системы
- Используется для поиска релевантной информации
- Индексируется для быстрого поиска
- Хранится в виде чанков с эмбеддингами

**Проверяемый документ:**
- Является объектом анализа
- Проходит автоматическую проверку на соответствие нормам
- Результаты проверки сохраняются для анализа
- Не индексируется для поиска

### 2. Процесс обработки

**Нормативный документ:**
```
1. Загрузка файла
2. Проверка дубликатов
3. Сохранение метаданных
4. Фоновая обработка:
   - Парсинг документа
   - Чанкинг текста
   - Создание эмбеддингов
   - Индексация в Qdrant и PostgreSQL
5. Готовность к поиску
```

**Проверяемый документ:**
```
1. Загрузка файла
2. Проверка дубликатов
3. Парсинг документа
4. Сохранение полного контента
5. Автоматическая проверка нормоконтроля:
   - Разбиение на страницы
   - Анализ каждой страницы LLM
   - Сохранение результатов
6. Создание отчета
```

### 3. Хранение данных

**Нормативный документ:**
- **uploaded_documents**: метаданные документа
- **extracted_elements**: элементы документа
- **normative_chunks**: чанки для поиска
- **Qdrant**: векторные эмбеддинги

**Проверяемый документ:**
- **checkable_documents**: метаданные документа
- **checkable_elements**: элементы документа
- **norm_control_results**: результаты проверки
- **review_reports**: отчеты по проверке

### 4. Использование LLM

**Нормативный документ:**
- LLM не используется при обработке
- Эмбеддинги создаются моделью BGE-M3

**Проверяемый документ:**
- LLM (llama3.1:8b) используется для анализа
- Постраничная проверка нормоконтроля
- Анализ соответствия нормативным требованиям

### 5. API endpoints

**Нормативный документ:**
- `POST /api/upload` - загрузка
- `GET /api/documents` - список документов
- `DELETE /api/documents/{id}` - удаление
- `POST /api/rag/search` - поиск

**Проверяемый документ:**
- `POST /api/upload/checkable` - загрузка
- `GET /api/checkable-documents` - список документов
- `DELETE /api/checkable-documents/{id}` - удаление
- `GET /api/checkable-documents/{id}/report` - отчет

### 6. Производительность

**Нормативный документ:**
- Асинхронная обработка не блокирует пользователя
- Требует времени для индексации
- Быстрый поиск после индексации

**Проверяемый документ:**
- Синхронная обработка (пользователь ждет)
- Время обработки зависит от размера документа
- LLM анализ может занять значительное время

### 7. Масштабируемость

**Нормативный документ:**
- Эффективное хранение в виде чанков
- Векторная индексация для быстрого поиска
- Возможность обработки больших документов

**Проверяемый документ:**
- Хранение полного контента
- Постраничный анализ ограничивает размер
- Зависимость от производительности LLM

## Ключевые особенности архитектуры

### 1. Разделение ответственности
- **Document Parser**: парсинг и извлечение контента
- **RAG Service**: индексация и поиск нормативных документов
- **Rule Engine**: логика нормоконтроля
- **LLM**: анализ и генерация текста

### 2. Гибридный поиск
- Векторный поиск (семантический) в Qdrant
- BM25 поиск (ключевые слова) в PostgreSQL
- Взвешенное объединение результатов

### 3. Автоматизация
- Автоматическая проверка проверяемых документов
- Фоновая обработка нормативных документов
- Автоматическое определение категорий

### 4. Надежность
- Проверка дубликатов
- Обработка ошибок
- Транзакционность операций с БД
- Fallback механизмы (например, хеш-эмбеддинги)

## Рекомендации по использованию

### Для нормативных документов:
1. Загружайте документы заранее
2. Используйте реиндексацию при необходимости
3. Мониторьте статистику индексации
4. Используйте фильтры при поиске

### Для проверяемых документов:
1. Разбивайте большие документы на части
2. Мониторьте время обработки
3. Проверяйте качество LLM анализа
4. Используйте настройки промптов для улучшения результатов
