# –û—Ç—á–µ—Ç –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–∏–º–∏—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –º–æ–¥–µ–ª–∏

## üéØ **–¶–µ–ª—å**

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç –Ω–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ 2 –º–∏–Ω—É—Ç—ã (120 —Å–µ–∫—É–Ω–¥) –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç LLM.

## ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

### üîß **1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Modelfile.optimized**

**–§–∞–π–ª:** `Modelfile.optimized`

**–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä:**
```modelfile
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è (2 –º–∏–Ω—É—Ç—ã)
PARAMETER num_predict 2048
```

**–ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```modelfile
FROM llama3.1:8b

# –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
PARAMETER num_ctx 16384

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞
PARAMETER num_batch 1024

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è (–Ω–∏–∑–∫–∞—è –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
PARAMETER temperature 0.1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ top_p –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
PARAMETER top_p 0.9

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ top_k –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
PARAMETER top_k 40

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è (2 –º–∏–Ω—É—Ç—ã)
PARAMETER num_predict 2048

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è
SYSTEM """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.
–û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.
"""
```

### üîß **2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.yaml**

**–§–∞–π–ª:** `docker-compose.yaml`

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```yaml
ollama:
  environment:
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è (2 –º–∏–Ω—É—Ç—ã)
    - OLLAMA_TIMEOUT=120
```

### üîß **3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ document-parser**

**–§–∞–π–ª:** `document_parser/main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ LLM –∑–∞–ø—Ä–æ—Å–∞—Ö:**
```python
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç 2 –º–∏–Ω—É—Ç—ã –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤
timeout = httpx.Timeout(120.0, connect=30.0)
async with httpx.AsyncClient(verify=False, timeout=timeout) as client:
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ endpoint –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
```python
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
timeout = httpx.Timeout(120.0, connect=30.0)
async with httpx.AsyncClient(timeout=timeout) as client:
```

### üîß **4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ gateway**

**–§–∞–π–ª:** `gateway/app.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞:**
```python
async with httpx.AsyncClient(timeout=120.0) as client:
    print(f"üîç [DEBUG] Gateway: Creating httpx client with timeout 120s")
```

### üîß **5. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏**

**–î–µ–π—Å—Ç–≤–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å `llama3.1-optimized-v2:latest`

**–ö–æ–º–∞–Ω–¥–∞:**
```bash
docker exec ai-nk-ollama-1 ollama create llama3.1-optimized-v2 -f /Modelfile.optimized
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ

### üîß **6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ document-parser –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏**

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `llama3.1-optimized-v2:latest` –≤–º–µ—Å—Ç–æ `llama3.1-optimized:latest`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ fallback –º–æ–¥–µ–ª–∏ –≤ API endpoints

## üìä **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏**

### ‚úÖ **–¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å**
```bash
curl -X POST "http://localhost:11434/api/generate" \
  -H "Content-Type: application/json" \
  -d '{"model": "llama3.1-optimized-v2:latest", "prompt": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?", "stream": false}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **48 —Å–µ–∫—É–Ω–¥** - –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç

### ‚úÖ **–¢–µ—Å—Ç 2: –°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–ø—Ä–µ—Ä–≤–∞–Ω)**
```bash
curl -X POST "http://localhost:11434/api/generate" \
  -H "Content-Type: application/json" \
  -d '{"model": "llama3.1-optimized-v2:latest", "prompt": "–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –†–∞—Å—Å–º–æ—Ç—Ä–∏ –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.", "stream": false}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **–ü—Ä–µ—Ä–≤–∞–Ω —á–µ—Ä–µ–∑ 4+ –º–∏–Ω—É—Ç—ã** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üéØ **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏**

### ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞:**

1. **Ollama:** 120 —Å–µ–∫—É–Ω–¥ (2 –º–∏–Ω—É—Ç—ã)
2. **Document-parser:** 120 —Å–µ–∫—É–Ω–¥ –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤
3. **Gateway:** 120 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **Connect timeout:** 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### ‚úÖ **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏:**

- **num_predict:** 2048 —Ç–æ–∫–µ–Ω–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞)
- **temperature:** 0.1 (–Ω–∏–∑–∫–∞—è –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
- **top_p:** 0.9 (–∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤)
- **top_k:** 40 (—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ)

## üìà **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏**

### ‚úÖ **1. –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ **2. –£–ª—É—á—à–µ–Ω–∏–µ UX:**
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ **3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU/GPU
- ‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –Ω–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–∞–º

## üîß **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

### ‚úÖ **–õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
```bash
# –õ–æ–≥–∏ Ollama
docker-compose logs ollama

# –õ–æ–≥–∏ document-parser
docker-compose logs document-parser

# –õ–æ–≥–∏ gateway
docker-compose logs gateway
```

### ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

## üéØ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–±–æ—Ç–µ**

### ‚úÖ **–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã:**

1. **‚úÖ Modelfile.optimized** - –¥–æ–±–∞–≤–ª–µ–Ω num_predict
2. **‚úÖ docker-compose.yaml** - –¥–æ–±–∞–≤–ª–µ–Ω OLLAMA_TIMEOUT
3. **‚úÖ document-parser** - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã
4. **‚úÖ gateway** - –æ–±–Ω–æ–≤–ª–µ–Ω —Ç–∞–π–º–∞—É—Ç
5. **‚úÖ –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å** - llama3.1-optimized-v2:latest
6. **‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### ‚úÖ **–°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã:**
- ‚úÖ document-parser –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω
- ‚úÖ gateway –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω
- ‚úÖ ollama —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤–æ–π –º–æ–¥–µ–ª—å—é

## üéâ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

### ‚úÖ **–õ–ò–ú–ò–¢ –í–†–ï–ú–ï–ù–ò –†–ê–°–°–£–ñ–î–ï–ù–ò–Ø –£–°–¢–ê–ù–û–í–õ–ï–ù –£–°–ü–ï–®–ù–û**

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** 2 –º–∏–Ω—É—Ç—ã (120 —Å–µ–∫—É–Ω–¥)
- ‚úÖ **–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å:** llama3.1-optimized-v2:latest
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞

### üéØ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã** –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
4. **–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞** –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### üìä **–°—Ç–∞—Ç—É—Å:**
**‚úÖ –õ–ò–ú–ò–¢ –í–†–ï–ú–ï–ù–ò –†–ê–°–°–£–ñ–î–ï–ù–ò–Ø –£–°–¢–ê–ù–û–í–õ–ï–ù - –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï**
