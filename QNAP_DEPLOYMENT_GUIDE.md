# Руководство по развертыванию AI-NK на QNAP

## Обзор

Этот документ содержит инструкции по развертыванию системы AI-NK на QNAP NAS с использованием Container Station.

## Требования

- QNAP NAS с установленным Container Station
- Минимум 8GB RAM (рекомендуется 16GB+)
- Минимум 50GB свободного места на диске
- Подключение к интернету для загрузки образов

## Подготовка

### 1. Установка Container Station

1. Откройте App Center на QNAP
2. Найдите и установите "Container Station"
3. Запустите Container Station

### 2. Подготовка файлов

1. Загрузите все файлы проекта в папку на QNAP (например, `/share/Container/ai-nk/`)
2. Убедитесь, что файлы `docker-compose.qnap.yaml` и `env.qnap` находятся в корневой папке проекта

## Развертывание

### 1. Создание проекта в Container Station

1. Откройте Container Station
2. Перейдите в раздел "Создать" → "Создать приложение"
3. Выберите "Создать из docker-compose"
4. Укажите путь к файлу `docker-compose.qnap.yaml`
5. Нажмите "Создать"

### 2. Настройка переменных окружения

1. В настройках приложения перейдите в "Переменные среды"
2. Импортируйте переменные из файла `env.qnap` или настройте вручную:

```bash
# Основные настройки
REDIS_PASSWORD=redispass
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=admin
POSTGRES_DB=norms_db
POSTGRES_USER=norms_user
POSTGRES_PASSWORD=norms_password

# Порты (если нужно изменить)
KEYCLOAK_PORT=8081
GATEWAY_PORT=8443
FRONTEND_PORT=443
POSTGRES_PORT=5432
QDANT_PORT=6333
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000
```

### 3. Настройка томов

Убедитесь, что все тома настроены правильно:

- `redis_data` - данные Redis
- `keycloak_db_data` - база данных Keycloak
- `norms_db_data` - база данных нормативных документов
- `qdrant_data` - векторная база данных
- `rag_models` - модели для RAG сервиса
- `prometheus_data` - данные мониторинга
- `grafana_data` - данные Grafana
- `spellchecker_logs` - логи проверки орфографии
- `spellchecker_cache` - кэш проверки орфографии
- `outgoing_control_uploads` - загруженные документы
- `outgoing_control_reports` - отчеты

### 4. Настройка сети

1. В настройках приложения перейдите в "Сеть"
2. Убедитесь, что выбрана сеть "bridge"
3. Настройте порты согласно вашим требованиям

## Запуск системы

### 1. Запуск приложения

1. В Container Station найдите созданное приложение
2. Нажмите "Запустить"
3. Дождитесь полной инициализации всех сервисов (может занять 5-10 минут)

### 2. Проверка статуса

1. Перейдите в раздел "Контейнеры"
2. Убедитесь, что все контейнеры запущены и работают
3. Проверьте логи контейнеров на наличие ошибок

## Доступ к сервисам

После успешного запуска система будет доступна по следующим адресам:

- **Frontend**: `https://[QNAP_IP]:443`
- **API Gateway**: `https://[QNAP_IP]:8443`
- **Keycloak**: `http://[QNAP_IP]:8081`
- **Document Parser**: `http://[QNAP_IP]:8001`
- **Rule Engine**: `http://[QNAP_IP]:8002`
- **RAG Service**: `http://[QNAP_IP]:8003`
- **Calculation Service**: `http://[QNAP_IP]:8004`
- **VLLM Service**: `http://[QNAP_IP]:8005`
- **Outgoing Control**: `http://[QNAP_IP]:8006`
- **Spellchecker**: `http://[QNAP_IP]:8007`
- **Prometheus**: `http://[QNAP_IP]:9090`
- **Grafana**: `http://[QNAP_IP]:3000`

## Настройка SSL

### 1. Подготовка сертификатов

1. Поместите SSL сертификаты в папку `./ssl/`:
   - `frontend.crt` - сертификат для frontend
   - `frontend.key` - приватный ключ для frontend
   - `keycloak.keystore` - keystore для Keycloak

### 2. Настройка HTTPS

1. Убедитесь, что сертификаты правильно подключены в docker-compose
2. Перезапустите приложение после добавления сертификатов

## Мониторинг

### 1. Prometheus

- URL: `http://[QNAP_IP]:9090`
- Собирает метрики со всех сервисов

### 2. Grafana

- URL: `http://[QNAP_IP]:3000`
- Логин: `admin`
- Пароль: настраивается в переменной `GRAFANA_ADMIN_PASSWORD`

## Устранение неполадок

### 1. Проблемы с ресурсами

Если возникают проблемы с нехваткой памяти:
1. Увеличьте объем RAM на QNAP
2. Остановите ненужные приложения
3. Настройте swap файл

### 2. Проблемы с портами

Если порты заняты:
1. Измените порты в файле `env.qnap`
2. Перезапустите приложение

### 3. Проблемы с томами

Если возникают проблемы с томами:
1. Проверьте права доступа к папкам
2. Убедитесь, что папки существуют
3. Проверьте свободное место на диске

### 4. Логи

Для диагностики проблем:
1. Откройте Container Station
2. Перейдите в раздел "Контейнеры"
3. Выберите проблемный контейнер
4. Просмотрите логи

## Обновление

### 1. Обновление приложения

1. Остановите приложение
2. Обновите файлы проекта
3. Пересоздайте приложение из обновленного docker-compose
4. Запустите приложение

### 2. Резервное копирование

Рекомендуется регулярно создавать резервные копии:
- Данных баз данных
- Загруженных документов
- Конфигурационных файлов

## Безопасность

### 1. Смена паролей по умолчанию

Обязательно смените пароли по умолчанию:
- `KEYCLOAK_ADMIN_PASSWORD`
- `POSTGRES_PASSWORD`
- `REDIS_PASSWORD`
- `GRAFANA_ADMIN_PASSWORD`

### 2. Настройка файрвола

Настройте файрвол QNAP для ограничения доступа к портам системы.

### 3. Регулярные обновления

Регулярно обновляйте:
- QNAP firmware
- Container Station
- Docker образы

## Поддержка

При возникновении проблем:
1. Проверьте логи контейнеров
2. Убедитесь в соответствии системным требованиям
3. Обратитесь к документации QNAP Container Station
