# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ RAG —Å–µ—Ä–≤–∏—Å–µ

## –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
**–î–∞—Ç–∞:** 4 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~3 —á–∞—Å–∞  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - –ø—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
- **–ù–µ—Ç –º–µ—Ç–∞-—Å–≤–æ–¥–∫–∏** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏** - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã

### –ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
```python
# –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è
for result in search_results[:3]:
    response_parts.append(f"üìÑ **{result['code']}** - {result.get('title', '')}")
    response_parts.append(f"–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: {result.get('content', '')[:300]}...")
```

## –†–µ—à–µ–Ω–∏–µ

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

#### 1. **JSON-–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**
```json
[
  {
    "doc": "–ì–û–°–¢ 21.201‚Äì2011",
    "section": "1.1", 
    "page": 5,
    "snippet": "‚Ä¶",
    "why": "scope match",
    "score": 0.83,
    "document_title": "–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
    "section_title": "–û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è",
    "chunk_type": "text",
    "metadata": {...},
    "summary": {
      "topic": "–û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
      "norm_type": "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è",
      "key_points": ["–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é", "–°–æ—Å—Ç–∞–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"],
      "relevance_reason": "–ü—Ä—è–º–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–æ—Å—É –æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö"
    }
  }
]
```

#### 2. **–ú–µ—Ç–∞-—Å–≤–æ–¥–∫–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è**
```json
{
  "meta_summary": {
    "query_type": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
    "documents_found": 3,
    "sections_covered": 5,
    "avg_relevance": 0.75,
    "coverage_quality": "–≤—ã—Å–æ–∫–∞—è",
    "key_documents": ["–ì–û–°–¢ 21.201‚Äì2011", "–°–ü 118.13330.2012"],
    "key_sections": ["1.1", "3.2", "4.1"]
  }
}
```

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **ContextBuilderService** (`context_builder_service.py`)

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã:
- **`ContextCandidate`** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **`ContextSummary`** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å–≤–æ–¥–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **`ContextBuilderService`** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

#### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
- **`build_structured_context()`** - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **`_convert_to_candidates()`** - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- **`_deduplicate_and_merge()`** - –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ —Å–ª–∏—è–Ω–∏–µ —á–∞–Ω–∫–æ–≤
- **`_generate_summaries()`** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è auto-summary
- **`_build_final_context()`** - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π OllamaRAGService**

#### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
- **`get_structured_context()`** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **`_format_consultation_response_with_context()`** - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å –Ω–æ–≤—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- –î–æ–±–∞–≤–ª–µ–Ω `ContextBuilderService` –≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
- –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `get_ntd_consultation()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### 3. **API Endpoints**

#### –ù–æ–≤—ã–π endpoint:
- **`get_structured_context()`** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ API

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ —Å–ª–∏—è–Ω–∏–µ**
```python
def _deduplicate_and_merge(self, candidates: List[ContextCandidate]) -> List[ContextCandidate]:
    """–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ doc+section –∏ —Å–ª–∏—è–Ω–∏–µ —Å–æ—Å–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤"""
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ doc+section
    grouped = {}
    for candidate in candidates:
        key = f"{candidate.doc}_{candidate.section}"
        if key not in grouped:
            grouped[key] = []
        grouped[key].append(candidate)
    
    # –°–ª–∏–≤–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ
    merged_candidates = []
    for key, group in grouped.items():
        if len(group) == 1:
            merged_candidates.append(group[0])
        else:
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ page –∏ —Å–ª–∏–≤–∞–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ
            group.sort(key=lambda x: x.page)
            merged = self._merge_adjacent_chunks(group)
            merged_candidates.extend(merged)
```

### 2. **Auto-summary —Å –ø–æ–º–æ—â—å—é LLM**
```python
def _generate_candidate_summary(self, candidate: ContextCandidate, query: str) -> Optional[ContextSummary]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞"""
    prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Å–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É (5-7 —Å—Ç—Ä–æ–∫):

–î–æ–∫—É–º–µ–Ω—Ç: {candidate.doc} - {candidate.document_title}
–†–∞–∑–¥–µ–ª: {candidate.section} - {candidate.section_title}
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {query}

–°–æ–∑–¥–∞–π —Å–≤–æ–¥–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–¢–ï–ú–ê: [–æ —á–µ–º —Ä–∞–∑–¥–µ–ª –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö]
–¢–ò–ü_–ù–û–†–ú–´: [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è]
–ö–õ–Æ–ß–ï–í–´–ï_–ú–û–ú–ï–ù–¢–´: [3-4 –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π]
–ü–†–ò–ß–ò–ù–ê_–†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–ò: [–ø–æ—á–µ–º—É —ç—Ç–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∑–∞–ø—Ä–æ—Å—É]
"""
```

### 3. **–ú–µ—Ç–∞-—Å–≤–æ–¥–∫–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è**
```python
def _generate_meta_summary(self, context_array: List[Dict], query: str) -> Dict[str, Any]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–∞-—Å–≤–æ–¥–∫–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è"""
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–¥–∫–∏
    docs = list(set(c["doc"] for c in context_array if c["doc"]))
    sections = list(set(c["section"] for c in context_array if c["section"]))
    avg_score = sum(c["score"] for c in context_array) / len(context_array) if context_array else 0
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
    query_lower = query.lower()
    if any(word in query_lower for word in ['—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è', '–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', '–¥–æ–ª–∂–µ–Ω', '–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ']):
        query_type = "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è"
    elif any(word in query_lower for word in ['—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è', '–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ']):
        query_type = "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"
    elif any(word in query_lower for word in ['–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '—á—Ç–æ —Ç–∞–∫–æ–µ', '–æ–∑–Ω–∞—á–∞–µ—Ç']):
        query_type = "–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"
    else:
        query_type = "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### ContextCandidate
```python
@dataclass
class ContextCandidate:
    doc: str  # –ö–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ì–û–°–¢, –°–ü –∏ —Ç.–¥.)
    section: str  # –†–∞–∑–¥–µ–ª/–≥–ª–∞–≤–∞
    page: int  # –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    snippet: str  # –§—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞
    why: str  # –ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (scope match, terms, etc.)
    score: float  # –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    content: str  # –ü–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–∞–Ω–∫–∞
    chunk_id: str  # ID —á–∞–Ω–∫–∞
    document_title: str  # –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    section_title: str  # –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
    chunk_type: str  # –¢–∏–ø —á–∞–Ω–∫–∞
    metadata: Dict[str, Any]  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
```

### ContextSummary
```python
@dataclass
class ContextSummary:
    topic: str  # –û —á–µ–º —Ä–∞–∑–¥–µ–ª
    norm_type: str  # –¢–∏–ø –Ω–æ—Ä–º—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è)
    key_points: List[str]  # –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
    relevance_reason: str  # –ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
```

## API –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
```bash
POST /api/structured-context
{
  "message": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
  "k": 8,
  "document_filter": "–ì–û–°–¢",
  "use_reranker": true,
  "fast_mode": false
}
```

### –û—Ç–≤–µ—Ç:
```json
{
  "query": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
  "timestamp": "2025-09-04T23:45:00.000Z",
  "context": [
    {
      "doc": "–ì–û–°–¢ 21.201‚Äì2011",
      "section": "1.1",
      "page": 5,
      "snippet": "–û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...",
      "why": "semantic_match",
      "score": 0.83,
      "document_title": "–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
      "section_title": "–û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è",
      "chunk_type": "text",
      "metadata": {...},
      "summary": {
        "topic": "–û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
        "norm_type": "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è",
        "key_points": ["–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é", "–°–æ—Å—Ç–∞–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"],
        "relevance_reason": "–ü—Ä—è–º–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–æ—Å—É –æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö"
      }
    }
  ],
  "meta_summary": {
    "query_type": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
    "documents_found": 3,
    "sections_covered": 5,
    "avg_relevance": 0.75,
    "coverage_quality": "–≤—ã—Å–æ–∫–∞—è",
    "key_documents": ["–ì–û–°–¢ 21.201‚Äì2011", "–°–ü 118.13330.2012"],
    "key_sections": ["1.1", "3.2", "4.1"]
  },
  "total_candidates": 3,
  "avg_score": 0.75
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**
- ‚úÖ –ß–µ—Ç–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ JSON-–º–∞—Å—Å–∏–≤
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- ‚úÖ –ü—Ä–∏—á–∏–Ω—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

### 2. **–ú–µ—Ç–∞-–∞–Ω–∞–ª–∏–∑**
- ‚úÖ Auto-summary –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- ‚úÖ –ú–µ—Ç–∞-—Å–≤–æ–¥–∫–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

### 3. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ doc+section
- ‚úÖ –°–ª–∏—è–Ω–∏–µ —Å–æ—Å–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤ –æ–¥–Ω–æ–π —Å–µ–∫—Ü–∏–∏
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 4. **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å**
- ‚úÖ LLM-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–æ–∫ —Å temperature=0
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –Ω–æ—Ä–º—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è)
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

### 5. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
- ‚úÖ Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ RAG —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ API
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** LLM –º–æ–¥–µ–ª–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- **–ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
- **–¢–∞–π–º–∞—É—Ç—ã** –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤ (30 —Å–µ–∫)

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (k, —Ñ–∏–ª—å—Ç—Ä—ã)
- **–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º** (fast_mode) –±–µ–∑ LLM
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

#### 1. **–¢–µ—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
```bash
curl -X POST "http://localhost:8002/api/structured-context" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
    "k": 5,
    "use_reranker": true
  }'
```

#### 2. **–¢–µ—Å—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –Ω–æ–≤—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:**
```bash
curl -X POST "http://localhost:8002/api/ntd-consultation/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "–∫–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏?",
    "user_id": "test_user"
  }'
```

#### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞-—Å–≤–æ–¥–∫–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ meta_summary –≤ –æ—Ç–≤–µ—Ç–µ
curl -s "http://localhost:8002/api/structured-context" | jq '.meta_summary'
```

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. **–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ RAG —Å–µ—Ä–≤–∏—Å–∞:**
```bash
cd rag_service
docker-compose build --no-cache rag-service
docker-compose restart rag-service
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞
curl "http://localhost:8002/health"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ endpoint
curl -X POST "http://localhost:8002/api/structured-context" \
  -H "Content-Type: application/json" \
  -d '{"message": "—Ç–µ—Å—Ç", "k": 3}'
```

### 3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
```bash
docker logs ai-nk-rag-service-1 --tail 50
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–í—Å–µ –∑–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- üèóÔ∏è **ContextBuilderService** - —Å–µ—Ä–≤–∏—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- üìä **–ú–µ—Ç–∞-—Å–≤–æ–¥–∫–∞** - –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ä–∞–∑–¥–µ–ª–æ–≤
- üîÑ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ —Å–ª–∏—è–Ω–∏–µ —á–∞–Ω–∫–æ–≤
- ü§ñ **Auto-summary** - LLM-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- üîó **API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –Ω–æ–≤—ã–µ endpoints –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- üìù **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è—Ö

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏
- **–ú–µ—Ç–∞-–∞–Ω–∞–ª–∏–∑** –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–≤–æ–¥–∫–∏** —Å –ø–æ–º–æ—â—å—é LLM
- **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- üöÄ **–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞** –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- üìà **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ** –æ—Ç–≤–µ—Ç–æ–≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
- üîß **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞
- üìä **–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ RAG —Å–∏—Å—Ç–µ–º—ã!** üéØ

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π AI-NK*  
*–í–µ—Ä—Å–∏—è: 1.0*  
*–î–∞—Ç–∞: 04.09.2025*
