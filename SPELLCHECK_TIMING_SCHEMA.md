# Схема проверки орфографии и тайминг процесса обработки документа

## Общая схема процесса

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ПРОЦЕСС ОБРАБОТКИ ДОКУМЕНТА                           │
└─────────────────────────────────────────────────────────────────────────────────┘

1. ЗАГРУЗКА ДОКУМЕНТА
   ├─ upload_start_time (начало загрузки)
   ├─ Сохранение файла на диск
   └─ upload_end_time (завершение загрузки)
      ⏱️ upload_duration = upload_end_time - upload_start_time

2. ИЗВЛЕЧЕНИЕ ТЕКСТА
   ├─ text_extraction_start_time (начало извлечения)
   ├─ Парсинг PDF/DOCX через UniversalDocumentParser
   ├─ Создание чанков (hierarchical_chunking)
   └─ text_extraction_end_time (завершение извлечения)
      ⏱️ text_extraction_duration = text_extraction_end_time - text_extraction_start_time

3. ПРОВЕРКА ОРФОГРАФИИ (SpellChecker Service)
   ├─ Отправка запроса в spellchecker-service
   ├─ Обработка через LanguageTool + Hunspell
   └─ Получение результатов проверки

4. ДВОЙНАЯ ПРОВЕРКА ЧЕРЕЗ LLM
   ├─ Формирование промпта с найденными ошибками
   ├─ Отправка в VLLM Service
   ├─ Анализ ошибок LLM (исключение ложных срабатываний)
   └─ Фильтрация реальных ошибок

5. ЭКСПЕРТНЫЙ АНАЛИЗ
   ├─ Формирование промпта с результатами spellchecker
   ├─ Отправка в VLLM Service для экспертной проверки
   └─ Генерация детального отчета

6. КОНСОЛИДАЦИЯ РЕЗУЛЬТАТОВ
   ├─ Объединение всех результатов
   ├─ Генерация финального отчета
   └─ Сохранение в базу данных
```

## Детальная схема проверки орфографии

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ПРОВЕРКА ОРФОГРАФИИ И ГРАММАТИКИ                         │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   ИСХОДНЫЙ      │───▶│  SPELLCHECKER    │───▶│   РЕЗУЛЬТАТЫ    │
│     ТЕКСТ       │    │    SERVICE       │    │   ПРОВЕРКИ      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   LANGUAGETOOL   │
                    │   (порт 8082)    │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │     HUNSPELL     │
                    │  (локальный)     │
                    └──────────────────┘

┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   НАЙДЕННЫЕ     │───▶│   VLLM SERVICE   │───▶│  ОТФИЛЬТРОВАННЫЕ│
│    ОШИБКИ       │    │  (двойная        │    │     ОШИБКИ      │
│                 │    │   проверка)      │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Тайминги процесса

### 1. Загрузка документа
```python
upload_start_time = datetime.now()
# Сохранение файла
upload_end_time = datetime.now()
upload_duration = (upload_end_time - upload_start_time).total_seconds()
```

### 2. Извлечение текста
```python
text_extraction_start_time = datetime.now()
# Парсинг документа
text_extraction_end_time = datetime.now()
text_extraction_duration = (text_extraction_end_time - text_extraction_start_time).total_seconds()
```

### 3. Проверка орфографии
```python
# Отправка запроса в spellchecker-service
request_time = datetime.now().isoformat()
response = requests.post(url, json=data, timeout=30)
response_time = datetime.now().isoformat()
```

### 4. Двойная проверка через LLM
```python
# Формирование промпта и отправка в VLLM
# Анализ ошибок и фильтрация ложных срабатываний
```

## Структура данных таймингов

```json
{
  "timing_metrics": {
    "upload_duration_seconds": 0.123,
    "text_extraction_duration_seconds": 1.456,
    "total_processing_duration_seconds": 1.579,
    "upload_start_time": "2025-09-14T22:30:00.123456",
    "upload_end_time": "2025-09-14T22:30:00.246456",
    "text_extraction_start_time": "2025-09-14T22:30:00.246456",
    "text_extraction_end_time": "2025-09-14T22:30:01.702456"
  }
}
```

## Отладочная информация

### SpellChecker Service
```json
{
  "spellchecker_debug": {
    "spellchecker_request_time": "2025-09-14T22:30:01.702456",
    "spellchecker_request_log": "POST http://spellchecker:8007/comprehensive-check | Data: 5000 chars | Check type: comprehensive",
    "spellchecker_response_time": "2025-09-14T22:30:02.123456",
    "spellchecker_response_log": "Status: success | Response size: 2500 chars"
  }
}
```

### VLLM Service
```json
{
  "vllm_debug": {
    "vllm_request_time": "2025-09-14T22:30:02.123456",
    "vllm_request_log": "POST http://vllm:8005/generate | Data: 8000 chars",
    "vllm_response_time": "2025-09-14T22:30:05.456789",
    "vllm_response_log": "Status: success | Response size: 3000 chars"
  }
}
```

## Процесс двойной проверки ошибок

```
1. ПОЛУЧЕНИЕ ОШИБОК ОТ SPELLCHECKER
   ├─ Список найденных ошибок
   ├─ Контекст каждой ошибки
   └─ Тип ошибки (орфография/грамматика)

2. ФОРМИРОВАНИЕ ПРОМПТА ДЛЯ LLM
   ├─ Исходный текст документа
   ├─ Список найденных ошибок
   └─ Инструкции по анализу

3. ОТПРАВКА В VLLM SERVICE
   ├─ POST /generate
   ├─ Анализ каждой ошибки
   └─ Определение реальности ошибки

4. ФИЛЬТРАЦИЯ РЕЗУЛЬТАТОВ
   ├─ Исключение ложных срабатываний
   ├─ Сохранение реальных ошибок
   └─ Добавление метаданных LLM

5. ОБНОВЛЕНИЕ РЕЗУЛЬТАТОВ
   ├─ Обновление списка ошибок
   ├─ Пересчет количества ошибок
   └─ Сохранение в базу данных
```

## Типичные времена выполнения

| Этап | Время | Описание |
|------|-------|----------|
| Загрузка файла | 0.1-0.5 сек | Зависит от размера файла |
| Извлечение текста | 1-5 сек | PDF: 2-5 сек, DOCX: 1-3 сек |
| Проверка орфографии | 2-10 сек | LanguageTool + Hunspell |
| Двойная проверка LLM | 3-15 сек | Зависит от количества ошибок |
| Экспертный анализ | 10-30 сек | Полный анализ документа |
| **Общее время** | **15-60 сек** | **Полный цикл обработки** |

## Мониторинг производительности

### Ключевые метрики:
- `upload_duration_seconds` - время загрузки файла
- `text_extraction_duration_seconds` - время извлечения текста
- `total_processing_duration_seconds` - общее время обработки
- Время ответа SpellChecker Service
- Время ответа VLLM Service
- Количество найденных ошибок
- Количество отфильтрованных ложных срабатываний

### Логирование:
- Время отправки запросов
- Время получения ответов
- Размеры данных
- Статусы ответов
- Детальная отладочная информация

## Оптимизация производительности

1. **Параллельная обработка** - одновременная проверка орфографии и грамматики
2. **Кэширование** - сохранение результатов для повторного использования
3. **Батчинг** - группировка запросов к внешним сервисам
4. **Таймауты** - ограничение времени ожидания ответов
5. **Мониторинг** - отслеживание производительности каждого этапа
