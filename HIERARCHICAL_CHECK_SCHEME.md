# 🔍 Схема выполнения иерархической проверки документов AI-NK

## 📋 Обзор системы иерархической проверки

Иерархическая проверка в системе AI-NK представляет собой многоуровневый процесс анализа документов, который включает:

1. **Анализ первой страницы** - определение типа проекта и стадии
2. **Проверка соответствия нормам** - анализ всего документа
3. **Анализ разделов** - структурирование документа по разделам
4. **Генерация отчета** - создание итогового отчета с чек-листом

## 🏗️ Схема выполнения иерархической проверки

### Этап 1: Анализ первой страницы (Quick First Page Analysis)

```
┌─────────────────────────────────────────────────────────────┐
│                    ЭТАП 1: АНАЛИЗ ПЕРВОЙ СТРАНИЦЫ           │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 1.1 Получение содержимого первой страницы                   │
│     - Извлечение текста из PDF/DOCX                        │
│     - Определение структуры документа                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 1.2 Извлечение информации о проекте                         │
│     - Шифр проекта (паттерн: Е110-0038-УКК.24.848-РД-01)   │
│     - Название проекта (по ключевым словам)                 │
│     - Стадия проектирования (РД/ПД/ЭД)                     │
│     - Марка комплекта (АР/КР/ОВ/ВК/ЭС/СС/ПОС/ПТ)           │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 1.3 Извлечение метаданных документа                         │
│     - Тип документа (чертеж/спецификация/расчет)            │
│     - Марка документа (КР-01, АР-02 и т.д.)                │
│     - Масштаб (1:100, 1:200 и т.д.)                        │
│     - Номер листа и общее количество листов                 │
└─────────────────────────────────────────────────────────────┘
```

### Этап 2: Проверка соответствия нормам (Norm Compliance Check)

```
┌─────────────────────────────────────────────────────────────┐
│                ЭТАП 2: ПРОВЕРКА СООТВЕТСТВИЯ НОРМАМ         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 2.1 Определение перечня НТД для проверки                    │
│     - Загрузка документа "Перечень НТД для руководства      │
│       внутри ОНК по маркам"                                │
│     - Определение релевантных нормативных документов        │
│       на основе марки комплекта                             │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 2.2 Поиск релевантных нормативных документов                │
│     - Гибридный поиск (Dense + BM25 + RRF)                 │
│     - Поиск по стадии проектирования                        │
│     - Поиск по марке комплекта                              │
│     - Контекстный поиск по содержанию                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 2.3 Проверка каждой страницы документа                      │
│     - Анализ содержания страницы                            │
│     - Сопоставление с требованиями НТД                      │
│     - Выявление нарушений и несоответствий                  │
│     - Классификация по степени критичности                  │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 2.4 Агрегация результатов проверки                          │
│     - Подсчет общего количества нарушений                   │
│     - Группировка по типам нарушений                        │
│     - Расчет процента соответствия                          │
│     - Определение критических нарушений                     │
└─────────────────────────────────────────────────────────────┘
```

### Этап 3: Анализ разделов документа (Document Sections Analysis)

```
┌─────────────────────────────────────────────────────────────┐
│              ЭТАП 3: АНАЛИЗ РАЗДЕЛОВ ДОКУМЕНТА              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 3.1 Идентификация разделов документа                        │
│     - "Общие данные" - высокий приоритет проверки           │
│     - "Спецификация" - средний приоритет                   │
│     - "Узлы и детали" - средний приоритет                  │
│     - "Основное содержание" - нормальный приоритет          │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 3.2 Организация проверки по разделам                        │
│     - Определение границ разделов                           │
│     - Установка приоритетов проверки                        │
│     - Планирование последовательности проверки              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 3.3 Специализированная проверка разделов                    │
│     - Проверка "Общих данных" на полноту                    │
│     - Проверка "Спецификации" на соответствие               │
│     - Проверка "Узлов и деталей" на детализацию             │
└─────────────────────────────────────────────────────────────┘
```

### Этап 4: Генерация отчета с чек-листом

```
┌─────────────────────────────────────────────────────────────┐
│              ЭТАП 4: ГЕНЕРАЦИЯ ОТЧЕТА С ЧЕК-ЛИСТОМ         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 4.1 Загрузка чек-листа "Чек-лист перед НК ПТИ"             │
│     - Получение перечня пунктов для проверки                │
│     - Определение обязательных и рекомендуемых пунктов      │
│     - Установка критериев оценки                            │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 4.2 Сопоставление результатов с чек-листом                  │
│     - Проверка каждого пункта чек-листа                     │
│     - Определение статуса (Пройден/Не пройден/Частично)     │
│     - Выявление пропущенных пунктов                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 4.3 Создание итоговой таблицы - Чек-лист                    │
│     - Формирование таблицы с результатами                   │
│     - Цветовая индикация статуса                            │
│     - Подсчет статистики по разделам                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 4.4 Генерация итогового отчета                              │
│     - Создание PDF отчета                                   │
│     - Включение всех разделов проверки                      │
│     - Добавление рекомендаций по устранению                 │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 Предложения по повышению качества проверки

### 1. Интеграция с документом "А9.2.МТН.03 Методика по оформлению ТД (ПИР)"

#### 1.1 Создание специализированных промптов

```python
# Промпт для проверки по методике А9.2.МТН.03
A9_2_MTN_03_PROMPT = """
Ты - эксперт по нормоконтролю технической документации согласно А9.2.МТН.03.

Проверь документ на соответствие требованиям методики А9.2.МТН.03:

ОБЯЗАТЕЛЬНЫЕ ТРЕБОВАНИЯ:
1. Наличие всех обязательных разделов
2. Правильность оформления титульного листа
3. Соответствие масштабов требованиям
4. Полнота спецификаций
5. Корректность условных обозначений

РЕКОМЕНДАТЕЛЬНЫЕ ТРЕБОВАНИЯ:
1. Детализация узлов и деталей
2. Наличие пояснительных записей
3. Соответствие форматов листов
4. Качество графического исполнения

Контекст нормативных документов:
{context}

Документ для проверки:
{document}

Найди нарушения и укажи:
1. Тип нарушения (критическое/предупреждение/информация)
2. Описание проблемы
3. Ссылку на пункт А9.2.МТН.03
4. Рекомендации по устранению
5. Номер страницы
"""
```

#### 1.2 Создание специализированных правил проверки

```python
class A9_2_MTN_03_Checker:
    """Специализированный проверяющий по методике А9.2.МТН.03"""
    
    def __init__(self):
        self.required_sections = [
            "титульный_лист",
            "общие_данные", 
            "основные_чертежи",
            "спецификация",
            "узлы_и_детали"
        ]
        
        self.mandatory_elements = {
            "титульный_лист": [
                "название_проекта",
                "шифр_проекта", 
                "стадия_проектирования",
                "марка_комплекта",
                "масштаб",
                "номер_листа"
            ],
            "общие_данные": [
                "масштаб",
                "система_координат",
                "условные_обозначения",
                "спецификация_материалов"
            ]
        }
    
    def check_document_compliance(self, document_content: str) -> List[Dict]:
        """Проверка документа на соответствие А9.2.МТН.03"""
        findings = []
        
        # Проверка наличия обязательных разделов
        for section in self.required_sections:
            if not self._check_section_exists(document_content, section):
                findings.append({
                    "type": "critical",
                    "title": f"Отсутствует раздел: {section}",
                    "description": f"Согласно А9.2.МТН.03 раздел '{section}' является обязательным",
                    "recommendation": f"Добавить раздел '{section}' в документ",
                    "reference": "А9.2.МТН.03, п. 3.1"
                })
        
        # Проверка обязательных элементов в разделах
        for section, elements in self.mandatory_elements.items():
            for element in elements:
                if not self._check_element_exists(document_content, section, element):
                    findings.append({
                        "type": "critical",
                        "title": f"Отсутствует элемент: {element}",
                        "description": f"В разделе '{section}' отсутствует обязательный элемент '{element}'",
                        "recommendation": f"Добавить элемент '{element}' в раздел '{section}'",
                        "reference": "А9.2.МТН.03, п. 3.2"
                    })
        
        return findings
```

### 2. Интеграция с документом "Перечень НТД для руководства внутри ОНК по маркам"

#### 2.1 Создание системы определения релевантных НТД

```python
class NTD_List_Manager:
    """Менеджер для работы с перечнем НТД по маркам"""
    
    def __init__(self):
        self.ntd_by_mark = {
            "АР": [  # Архитектурные решения
                "СП 22.13330.2016",
                "СП 16.13330.2017", 
                "ГОСТ 21.501-2018",
                "ГОСТ 21.101-97"
            ],
            "КР": [  # Конструктивные решения
                "СП 63.13330.2018",
                "СП 20.13330.2016",
                "ГОСТ 21.501-2018",
                "ГОСТ 21.101-97"
            ],
            "ОВ": [  # Отопление и вентиляция
                "СП 60.13330.2020",
                "СП 7.13130.2013",
                "ГОСТ 21.602-2016"
            ],
            "ВК": [  # Водоснабжение и канализация
                "СП 30.13330.2020",
                "СП 32.13330.2018",
                "ГОСТ 21.601-2011"
            ],
            "ЭС": [  # Электроснабжение
                "СП 31.110-2003",
                "ПУЭ 7",
                "ГОСТ 21.608-2014"
            ]
        }
    
    def get_relevant_ntd(self, document_mark: str, project_stage: str) -> List[str]:
        """Получение релевантных НТД для марки и стадии"""
        base_ntd = self.ntd_by_mark.get(document_mark, [])
        
        # Добавляем НТД в зависимости от стадии
        if project_stage == "Рабочая документация":
            base_ntd.extend([
                "ГОСТ 21.101-97",  # Общие требования к рабочей документации
                "ГОСТ 21.501-2018"  # Правила выполнения рабочей документации
            ])
        elif project_stage == "Проектная документация":
            base_ntd.extend([
                "ГОСТ 21.101-97",  # Общие требования к проектной документации
                "ПП РФ 87"  # Положение о составе разделов проектной документации
            ])
        
        return list(set(base_ntd))  # Убираем дубликаты
```

### 3. Интеграция с документом "Чек-лист перед НК ПТИ"

#### 3.1 Создание системы чек-листа

```python
class Checklist_Manager:
    """Менеджер для работы с чек-листом перед НК ПТИ"""
    
    def __init__(self):
        self.checklist_items = {
            "general_requirements": [
                {
                    "id": "GR001",
                    "description": "Наличие титульного листа",
                    "mandatory": True,
                    "category": "Общие требования"
                },
                {
                    "id": "GR002", 
                    "description": "Правильность оформления шифра проекта",
                    "mandatory": True,
                    "category": "Общие требования"
                },
                {
                    "id": "GR003",
                    "description": "Указание стадии проектирования",
                    "mandatory": True,
                    "category": "Общие требования"
                }
            ],
            "technical_requirements": [
                {
                    "id": "TR001",
                    "description": "Соответствие масштабов требованиям",
                    "mandatory": True,
                    "category": "Технические требования"
                },
                {
                    "id": "TR002",
                    "description": "Наличие условных обозначений",
                    "mandatory": True,
                    "category": "Технические требования"
                },
                {
                    "id": "TR003",
                    "description": "Полнота спецификаций",
                    "mandatory": True,
                    "category": "Технические требования"
                }
            ],
            "quality_requirements": [
                {
                    "id": "QR001",
                    "description": "Качество графического исполнения",
                    "mandatory": False,
                    "category": "Требования к качеству"
                },
                {
                    "id": "QR002",
                    "description": "Читаемость текста и размеров",
                    "mandatory": False,
                    "category": "Требования к качеству"
                }
            ]
        }
    
    def check_document_against_checklist(self, document_content: str, 
                                       document_metadata: Dict) -> Dict:
        """Проверка документа по чек-листу"""
        results = {
            "passed": 0,
            "failed": 0,
            "partial": 0,
            "not_applicable": 0,
            "items": []
        }
        
        for category, items in self.checklist_items.items():
            for item in items:
                status = self._check_item(document_content, document_metadata, item)
                
                results["items"].append({
                    "id": item["id"],
                    "description": item["description"],
                    "category": item["category"],
                    "mandatory": item["mandatory"],
                    "status": status,
                    "details": self._get_item_details(status, item)
                })
                
                if status == "passed":
                    results["passed"] += 1
                elif status == "failed":
                    results["failed"] += 1
                elif status == "partial":
                    results["partial"] += 1
                else:
                    results["not_applicable"] += 1
        
        return results
    
    def _check_item(self, content: str, metadata: Dict, item: Dict) -> str:
        """Проверка отдельного пункта чек-листа"""
        item_id = item["id"]
        
        if item_id == "GR001":  # Наличие титульного листа
            return "passed" if "титульный" in content.lower() else "failed"
        elif item_id == "GR002":  # Правильность оформления шифра проекта
            project_code = metadata.get("project_code", "")
            return "passed" if len(project_code) > 10 else "failed"
        elif item_id == "TR001":  # Соответствие масштабов
            scale = metadata.get("scale", "")
            return "passed" if "1:" in scale else "failed"
        # ... другие проверки
        
        return "not_applicable"
```

### 4. Создание итоговой таблицы - Чек-лист

#### 4.1 Генерация таблицы результатов

```python
def generate_checklist_table(checklist_results: Dict) -> str:
    """Генерация итоговой таблицы - Чек-лист"""
    
    table_html = """
    <table class="checklist-table">
        <thead>
            <tr>
                <th>№</th>
                <th>Пункт чек-листа</th>
                <th>Категория</th>
                <th>Обязательность</th>
                <th>Статус</th>
                <th>Примечания</th>
            </tr>
        </thead>
        <tbody>
    """
    
    for i, item in enumerate(checklist_results["items"], 1):
        status_class = {
            "passed": "status-passed",
            "failed": "status-failed", 
            "partial": "status-partial",
            "not_applicable": "status-na"
        }.get(item["status"], "status-unknown")
        
        status_text = {
            "passed": "✅ Пройден",
            "failed": "❌ Не пройден",
            "partial": "⚠️ Частично",
            "not_applicable": "➖ Н/П"
        }.get(item["status"], "❓ Неизвестно")
        
        mandatory_text = "Обязательный" if item["mandatory"] else "Рекомендуемый"
        
        table_html += f"""
            <tr class="{status_class}">
                <td>{i}</td>
                <td>{item['description']}</td>
                <td>{item['category']}</td>
                <td>{mandatory_text}</td>
                <td>{status_text}</td>
                <td>{item.get('details', '')}</td>
            </tr>
        """
    
    table_html += """
        </tbody>
    </table>
    """
    
    return table_html
```

### 5. Улучшенная схема иерархической проверки

#### 5.1 Обновленный алгоритм проверки

```python
class EnhancedHierarchicalCheckService:
    """Улучшенный сервис иерархической проверки"""
    
    def __init__(self):
        self.ntd_manager = NTD_List_Manager()
        self.checklist_manager = Checklist_Manager()
        self.a9_2_mtn_03_checker = A9_2_MTN_03_Checker()
    
    async def perform_enhanced_hierarchical_check(self, document_id: int) -> Dict[str, Any]:
        """Выполнение улучшенной иерархической проверки"""
        
        # Этап 1: Анализ первой страницы
        first_page_info = await self.analyze_first_page(document_id)
        
        # Этап 2: Определение релевантных НТД
        document_mark = first_page_info.get("document_metadata", {}).get("document_mark", "")
        project_stage = first_page_info.get("project_info", {}).get("project_stage", "")
        relevant_ntd = self.ntd_manager.get_relevant_ntd(document_mark, project_stage)
        
        # Этап 3: Проверка по методике А9.2.МТН.03
        a9_2_mtn_03_results = self.a9_2_mtn_03_checker.check_document_compliance(
            self.get_document_content(document_id)
        )
        
        # Этап 4: Проверка по чек-листу
        checklist_results = self.checklist_manager.check_document_against_checklist(
            self.get_document_content(document_id),
            first_page_info.get("document_metadata", {})
        )
        
        # Этап 5: Генерация итогового отчета
        final_report = self.generate_enhanced_report(
            first_page_info,
            relevant_ntd,
            a9_2_mtn_03_results,
            checklist_results
        )
        
        return final_report
```

## 📊 Метрики качества иерархической проверки

### 1. Ключевые показатели эффективности (KPI)

```python
class HierarchicalCheckMetrics:
    """Метрики качества иерархической проверки"""
    
    def calculate_metrics(self, results: Dict) -> Dict:
        """Расчет метрик качества проверки"""
        
        checklist_results = results.get("checklist_results", {})
        total_items = len(checklist_results.get("items", []))
        passed_items = checklist_results.get("passed", 0)
        failed_items = checklist_results.get("failed", 0)
        mandatory_failed = sum(1 for item in checklist_results.get("items", []) 
                              if item["mandatory"] and item["status"] == "failed")
        
        return {
            "compliance_percentage": (passed_items / total_items * 100) if total_items > 0 else 0,
            "mandatory_compliance": (mandatory_failed == 0),
            "critical_issues_count": failed_items,
            "overall_quality_score": self._calculate_quality_score(results),
            "processing_time": results.get("execution_time", 0),
            "ntd_coverage": len(results.get("relevant_ntd", [])),
            "checklist_completeness": total_items
        }
    
    def _calculate_quality_score(self, results: Dict) -> float:
        """Расчет общего балла качества"""
        checklist_results = results.get("checklist_results", {})
        
        # Веса для разных типов проверок
        weights = {
            "mandatory": 0.6,  # 60% - обязательные требования
            "recommended": 0.3,  # 30% - рекомендуемые требования
            "quality": 0.1  # 10% - требования к качеству
        }
        
        score = 0.0
        for item in checklist_results.get("items", []):
            if item["status"] == "passed":
                weight = weights.get("mandatory" if item["mandatory"] else "recommended", 0.1)
                score += weight
            elif item["status"] == "partial":
                weight = weights.get("mandatory" if item["mandatory"] else "recommended", 0.1)
                score += weight * 0.5
        
        return min(score * 100, 100.0)  # Нормализуем до 100
```

## 🚀 Рекомендации по внедрению

### 1. Поэтапное внедрение

1. **Этап 1**: Интеграция документа "А9.2.МТН.03" в систему проверки
2. **Этап 2**: Загрузка и индексация "Перечня НТД по маркам"
3. **Этап 3**: Создание системы чек-листа "Чек-лист перед НК ПТИ"
4. **Этап 4**: Разработка генератора итоговых таблиц
5. **Этап 5**: Тестирование и оптимизация

### 2. Технические требования

- **Производительность**: Время проверки не более 5 минут на документ
- **Точность**: Не менее 90% правильных определений нарушений
- **Полнота**: Покрытие всех пунктов чек-листа
- **Масштабируемость**: Поддержка до 1000 документов в день

### 3. Мониторинг и улучшение

- **Еженедельный анализ** качества проверки
- **Ежемесячное обновление** нормативной базы
- **Квартальная оптимизация** алгоритмов проверки
- **Годовая оценка** эффективности системы

---

**© 2024 AI-NK System. Все права защищены.**

*Данная схема представляет собой детальное описание процесса иерархической проверки документов с учетом требований А9.2.МТН.03 и интеграции с перечнем НТД и чек-листом.*
