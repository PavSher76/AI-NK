# 🎓 Инструкция по обучению системы AI-NK для проверки документации

## 📋 Обзор

Система AI-NK использует **гибридный подход** к обучению, сочетающий:
- **RAG (Retrieval-Augmented Generation)** - поиск по нормативным документам
- **Fine-tuning промптов** - настройка инструкций для LLM
- **Контекстное обучение** - адаптация под специфику документов

## 🎯 Цели обучения

1. **Повышение точности проверки** - минимизация ложных срабатываний
2. **Адаптация под специфику** - настройка под конкретные типы документов
3. **Улучшение качества отчетов** - более структурированные и полезные выводы
4. **Оптимизация производительности** - быстрая и эффективная обработка

## 🏗️ Архитектура обучения

### 1. Компоненты системы обучения

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Нормативные   │    │   Проверяемые   │    │   Обратная      │
│   документы     │    │   документы     │    │   связь         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   RAG Service   │    │  Document       │    │   Feedback      │
│   (Индексация)  │    │  Parser         │    │   Loop          │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Qdrant        │    │   LLM           │    │   Промпт        │
│   (Векторы)     │    │   (Анализ)      │    │   Fine-tuning   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2. Поток обучения

1. **Загрузка нормативных документов** → Индексация в RAG
2. **Проверка тестовых документов** → Получение результатов
3. **Анализ качества** → Выявление проблем
4. **Корректировка промптов** → Улучшение инструкций
5. **Повторная проверка** → Валидация улучшений

## 📚 Этап 1: Подготовка нормативной базы

### 1.1 Структура нормативных документов

**Рекомендуемая структура папки `TestDocs/Norms/`:**

```
TestDocs/Norms/
├── ГОСТ/
│   ├── ГОСТ 21.501-2018 - Правила выполнения архитектурно-строительных чертежей.pdf
│   ├── ГОСТ 21.502-2016 - Правила выполнения конструкторских чертежей.pdf
│   └── ГОСТ 2.306-68 - Обозначения графические материалов.pdf
├── СП/
│   ├── СП 48.13330.2019 - Организация строительства.pdf
│   └── СП 70.13330.2012 - Несущие и ограждающие конструкции.pdf
├── СНиП/
│   ├── СНиП 2.01.07-85 - Нагрузки и воздействия.pdf
│   └── СНиП 3.03.01-87 - Несущие и ограждающие конструкции.pdf
└── Ведомственные/
    ├── РД 11-02-2006 - Требования к составу и порядку ведения исполнительной документации.pdf
    └── СП 48.13330.2019 - Организация строительства.pdf
```

### 1.2 Загрузка нормативных документов

```bash
# 1. Подготовка документов
# Убедитесь, что документы имеют четкие названия с указанием типа и года

# 2. Загрузка через интерфейс
# Откройте страницу "Нормативные документы"
# Выберите категорию: ГОСТ, СП, СНиП, Ведомственные
# Загрузите документы по одному или пакетно

# 3. Проверка индексации
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/rag/stats" | jq .
```

### 1.3 Валидация индексации

```bash
# Проверка количества загруженных документов
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/documents/stats" | jq .

# Проверка количества проиндексированных элементов
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/rag/stats" | jq '.vector_indexed'
```

## 🧪 Этап 2: Подготовка тестовых данных

### 2.1 Структура тестовых документов

**Рекомендуемая структура папки `TestDocs/for_check/`:**

```
TestDocs/for_check/
├── Правильные/
│   ├── Чертеж_соответствующий_нормам.pdf
│   ├── Спецификация_корректная.pdf
│   └── ПЗ_правильное.pdf
├── С_ошибками/
│   ├── Чертеж_с_нарушениями.pdf
│   ├── Спецификация_с_ошибками.pdf
│   └── ПЗ_с_проблемами.pdf
└── Пограничные/
    ├── Документ_с_незначительными_нарушениями.pdf
    └── Документ_требующий_уточнений.pdf
```

### 2.2 Создание эталонных ответов

**Для каждого тестового документа создайте файл с эталонным ответом:**

```json
{
  "document_name": "Чертеж_с_нарушениями.pdf",
  "expected_violations": [
    {
      "type": "critical",
      "description": "Отсутствует масштаб на чертеже",
      "norm_reference": "ГОСТ 21.501-2018 п.5.1",
      "location": "Основная надпись"
    },
    {
      "type": "warning", 
      "description": "Не указана марка материала",
      "norm_reference": "ГОСТ 2.306-68 п.3.1",
      "location": "Спецификация"
    }
  ],
  "expected_status": "не соответствует",
  "expected_recommendations": [
    "Добавить масштаб в основную надпись",
    "Указать марки материалов в спецификации"
  ]
}
```

## 🔧 Этап 3: Настройка промптов

### 3.1 Текущий промпт системы

Система использует промпт из базы данных (`system_settings.normcontrol_prompt`):

```sql
-- Просмотр текущего промпта
SELECT setting_value FROM system_settings WHERE setting_key = 'normcontrol_prompt';
```

### 3.2 Структура промпта

**Оптимальная структура промпта:**

```text
1. РОЛЬ И КОНТЕКСТ
   - Определение роли эксперта
   - Указание области знаний

2. ИНСТРУКЦИИ ПО АНАЛИЗУ
   - Алгоритм проверки документа
   - Критерии оценки

3. СТРУКТУРА ОТЧЕТА
   - Формат вывода результатов
   - Обязательные разделы

4. КРИТЕРИИ КЛАССИФИКАЦИИ
   - Определение типов нарушений
   - Пороги для критических/некритических

5. ТРЕБОВАНИЯ К КАЧЕСТВУ
   - Конкретность и точность
   - Ссылки на нормативные документы
```

### 3.3 Методика улучшения промпта

#### Шаг 1: Анализ текущих результатов

```bash
# Загрузка тестового документа
curl -k -H "Authorization: Bearer test-token" \
  -F "file=@TestDocs/for_check/Чертеж_с_нарушениями.pdf" \
  "https://localhost/api/upload/checkable"

# Получение результата проверки
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/checkable-documents/21/report" | jq .
```

#### Шаг 2: Выявление проблем

**Типичные проблемы:**
- ❌ **Ложные срабатывания** - система находит нарушения там, где их нет
- ❌ **Пропуск нарушений** - система не видит реальные проблемы
- ❌ **Неточные описания** - неконкретные формулировки
- ❌ **Отсутствие ссылок** - нет указаний на нормативные документы

#### Шаг 3: Корректировка промпта

```sql
-- Обновление промпта через базу данных
UPDATE system_settings 
SET setting_value = 'НОВЫЙ_ПРОМПТ_С_УЛУЧШЕНИЯМИ'
WHERE setting_key = 'normcontrol_prompt';
```

#### Шаг 4: Валидация улучшений

```bash
# Повторная проверка того же документа
curl -k -H "Authorization: Bearer test-token" \
  -F "file=@TestDocs/for_check/Чертеж_с_нарушениями.pdf" \
  "https://localhost/api/upload/checkable"

# Сравнение результатов
```

## 📊 Этап 4: Метрики качества

### 4.1 Ключевые метрики

```python
# Метрики для оценки качества системы

def calculate_metrics(expected, actual):
    """
    Расчет метрик качества проверки
    
    Args:
        expected: Ожидаемые нарушения (эталон)
        actual: Фактические нарушения (результат системы)
    """
    
    # Точность (Precision)
    true_positives = len(set(expected) & set(actual))
    precision = true_positives / len(actual) if actual else 0
    
    # Полнота (Recall)
    recall = true_positives / len(expected) if expected else 0
    
    # F1-мера
    f1 = 2 * (precision * recall) / (precision + recall) if (precision + recall) > 0 else 0
    
    return {
        "precision": precision,
        "recall": recall, 
        "f1_score": f1,
        "true_positives": true_positives,
        "false_positives": len(actual) - true_positives,
        "false_negatives": len(expected) - true_positives
    }
```

### 4.2 Целевые показатели

| Метрика | Целевое значение | Описание |
|---------|------------------|----------|
| **Precision** | > 0.85 | Минимум ложных срабатываний |
| **Recall** | > 0.90 | Максимум найденных нарушений |
| **F1-Score** | > 0.87 | Общий баланс качества |
| **Время ответа** | < 30 сек | Производительность |

## 🔄 Этап 5: Итеративное улучшение

### 5.1 Цикл улучшения

```
┌─────────────────┐
│   Тестирование  │
│   документов    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   Анализ        │
│   результатов   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   Выявление     │
│   проблем       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   Корректировка │
│   промптов      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   Валидация     │
│   улучшений     │
└─────────┬───────┘
          │
          └───────┐
                  ▼
```

### 5.2 Автоматизация процесса

**Скрипт для автоматического тестирования:**

```bash
#!/bin/bash
# test_system_quality.sh

echo "🧪 Тестирование качества системы AI-NK"

# 1. Загрузка тестовых документов
for file in TestDocs/for_check/Правильные/*.pdf; do
    echo "Загрузка правильного документа: $file"
    curl -k -H "Authorization: Bearer test-token" \
      -F "file=@$file" "https://localhost/api/upload/checkable"
done

for file in TestDocs/for_check/С_ошибками/*.pdf; do
    echo "Загрузка документа с ошибками: $file"
    curl -k -H "Authorization: Bearer test-token" \
      -F "file=@$file" "https://localhost/api/upload/checkable"
done

# 2. Ожидание обработки
sleep 30

# 3. Анализ результатов
echo "📊 Анализ результатов..."
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/checkable-documents" | jq '.documents[] | {id, original_filename, processing_status}'

echo "✅ Тестирование завершено"
```

## 🎯 Этап 6: Специализация под типы документов

### 6.1 Категории документов

**Основные категории:**
- **Архитектурно-строительные чертежи** (АС)
- **Конструкторские чертежи** (КЖ, КМ, КД)
- **Спецификации** (СП)
- **Пояснительные записки** (ПЗ)
- **Схемы** (ЭС, ВК, ОВ, АСУТП)

### 6.2 Специализированные промпты

```sql
-- Создание специализированных промптов
INSERT INTO system_settings (setting_key, setting_value, setting_description) VALUES
('normcontrol_prompt_architectural', 
 'Специализированный промпт для архитектурных чертежей...',
 'Промпт для проверки архитектурных чертежей'),
('normcontrol_prompt_structural',
 'Специализированный промпт для конструкторских чертежей...', 
 'Промпт для проверки конструкторских чертежей'),
('normcontrol_prompt_specifications',
 'Специализированный промпт для спецификаций...',
 'Промпт для проверки спецификаций');
```

### 6.3 Автоматический выбор промпта

```python
def select_prompt_by_category(document_category: str) -> str:
    """Выбор промпта в зависимости от категории документа"""
    
    prompt_mapping = {
        'architectural': 'normcontrol_prompt_architectural',
        'structural': 'normcontrol_prompt_structural', 
        'specifications': 'normcontrol_prompt_specifications',
        'default': 'normcontrol_prompt'
    }
    
    prompt_key = prompt_mapping.get(document_category, 'default')
    
    # Получение промпта из базы данных
    return get_setting(prompt_key)
```

## 📈 Этап 7: Мониторинг и поддержка

### 7.1 Мониторинг качества

**Grafana дашборд для отслеживания метрик:**

```sql
-- Создание таблицы для метрик качества
CREATE TABLE IF NOT EXISTS quality_metrics (
    id SERIAL PRIMARY KEY,
    test_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    document_category VARCHAR(50),
    precision FLOAT,
    recall FLOAT,
    f1_score FLOAT,
    processing_time_seconds INTEGER,
    model_version VARCHAR(20),
    prompt_version VARCHAR(20)
);
```

### 7.2 Автоматические уведомления

```python
def check_quality_thresholds():
    """Проверка пороговых значений качества"""
    
    # Получение последних метрик
    recent_metrics = get_recent_quality_metrics()
    
    for metric in recent_metrics:
        if metric['f1_score'] < 0.85:
            send_alert(f"Качество системы ниже порога: {metric['f1_score']}")
        
        if metric['processing_time_seconds'] > 60:
            send_alert(f"Время обработки превышено: {metric['processing_time_seconds']} сек")
```

### 7.3 Плановое обслуживание

**Еженедельные задачи:**
1. **Анализ новых документов** - выявление новых типов нарушений
2. **Обновление нормативной базы** - добавление новых ГОСТ/СП
3. **Корректировка промптов** - улучшение на основе обратной связи
4. **Тестирование производительности** - проверка времени ответа

**Ежемесячные задачи:**
1. **Полное тестирование** - проверка всех типов документов
2. **Анализ трендов** - выявление изменений в качестве
3. **Обновление метрик** - корректировка целевых показателей
4. **Документирование изменений** - ведение журнала улучшений

## 🚀 Быстрый старт обучения

### Шаг 1: Подготовка окружения

```bash
# 1. Проверка системы
docker-compose ps

# 2. Проверка доступности сервисов
curl -k "https://localhost/api/health"

# 3. Проверка текущих настроек
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/settings" | jq .
```

### Шаг 2: Загрузка нормативных документов

```bash
# Создание структуры папок
mkdir -p TestDocs/Norms/{ГОСТ,СП,СНиП,Ведомственные}
mkdir -p TestDocs/for_check/{Правильные,С_ошибками,Пограничные}

# Загрузка через интерфейс или API
# Откройте https://localhost и перейдите на страницу "Нормативные документы"
```

### Шаг 3: Первое тестирование

```bash
# Загрузка тестового документа
curl -k -H "Authorization: Bearer test-token" \
  -F "file=@TestDocs/for_check/тестовый_документ.pdf" \
  "https://localhost/api/upload/checkable"

# Анализ результата
curl -k -H "Authorization: Bearer test-token" \
  "https://localhost/api/checkable-documents" | jq .
```

### Шаг 4: Настройка промпта

```sql
-- Подключение к базе данных
docker exec -it ai-nk-norms-db-1 psql -U norms_user -d norms_db

-- Просмотр текущего промпта
SELECT setting_key, LEFT(setting_value, 100) FROM system_settings 
WHERE setting_key = 'normcontrol_prompt';

-- Обновление промпта (при необходимости)
UPDATE system_settings 
SET setting_value = 'УЛУЧШЕННЫЙ_ПРОМПТ'
WHERE setting_key = 'normcontrol_prompt';
```

## 📋 Чек-лист обучения

### ✅ Подготовка
- [ ] Нормативные документы загружены и проиндексированы
- [ ] Тестовые документы подготовлены
- [ ] Эталонные ответы созданы
- [ ] Метрики качества определены

### ✅ Настройка
- [ ] Базовый промпт настроен
- [ ] Специализированные промпты созданы
- [ ] Автоматический выбор промптов настроен
- [ ] Система мониторинга запущена

### ✅ Тестирование
- [ ] Первичное тестирование проведено
- [ ] Метрики качества рассчитаны
- [ ] Проблемы выявлены и задокументированы
- [ ] Корректировки внесены

### ✅ Валидация
- [ ] Повторное тестирование проведено
- [ ] Улучшения подтверждены
- [ ] Целевые показатели достигнуты
- [ ] Система готова к продакшену

## 🎯 Заключение

Обучение системы AI-NK - это **итеративный процесс**, требующий:

1. **Систематического подхода** - четкий план и метрики
2. **Качественных данных** - репрезентативные документы
3. **Постоянного мониторинга** - отслеживание качества
4. **Регулярных улучшений** - адаптация под новые требования

**Результат:** Система, способная точно и эффективно проверять документы на соответствие нормативным требованиям с минимальным количеством ложных срабатываний.

---

*📞 Поддержка: При возникновении вопросов обращайтесь к документации или создавайте issue в репозитории проекта.*
