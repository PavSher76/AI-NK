# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å multipart/form-data –≤ Gateway

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ frontend –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
Unexpected token '<', "<html> <h"... is not valid JSON
```

–ü–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ `multipart/form-data` –≤ Gateway.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

**–õ–æ–≥–∏ frontend –ø–æ–∫–∞–∑–∞–ª–∏:**
```
upstream prematurely closed connection while reading response header from upstream
```

**–õ–æ–≥–∏ gateway –ø–æ–∫–∞–∑–∞–ª–∏:**
```
"POST /api/upload/checkable HTTP/1.1" 500 Internal Server Error
```

**–ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ gateway –ø–æ–∫–∞–∑–∞–ª–æ:**
```bash
curl -s -k -X POST -H "Authorization: Bearer test-token" -F "file=@test.txt" https://localhost:8443/api/upload/checkable
# –†–µ–∑—É–ª—å—Ç–∞—Ç: {"detail":"Proxy error: The `python-multipart` library must be installed to use form parsing."}
```

### 2. –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏** - `python-multipart` –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ gateway
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ multipart** - –ø–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ multipart –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –æ—à–∏–±–∫–∞–º
3. **–ü—Ä–æ–±–ª–µ–º—ã —Å Content-Length** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è multipart –∑–∞–ø—Ä–æ—Å–æ–≤

## üîß –†–µ—à–µ–Ω–∏–µ

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ python-multipart

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `gateway/requirements.txt`:**
```
fastapi
uvicorn[standard]
httpx
python-jose[cryptography]
redis
prometheus-client
python-multipart
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ multipart/form-data

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `proxy_to_service` –≤ `gateway/app.py`:**

```python
elif method == "POST":
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è multipart/form-data
    content_type = request.headers.get("content-type", "")
    if content_type.startswith("multipart/form-data"):
        # –î–ª—è —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –ø—Ä–æ–∫—Å–∏ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞
        # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å Content-Length
        body = await request.body()
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π content-type —Å boundary
        # –ù–µ —É–¥–∞–ª—è–µ–º content-type –¥–ª—è multipart/form-data
        response = await client.post(url, headers=headers, content=body)
    else:
        # –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è JSON –∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
        body = await request.body()
        response = await client.post(url, headers=headers, content=body)
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

**–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è multipart –∑–∞–ø—Ä–æ—Å–æ–≤:**

```python
headers = dict(request.headers)
# –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
headers.pop("host", None)
# –ù–µ —É–¥–∞–ª—è–µ–º content-length –¥–ª—è multipart/form-data
if not request.headers.get("content-type", "").startswith("multipart/form-data"):
    headers.pop("content-length", None)
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**

```python
print(f"DEBUG: Proxying {method} request to {service_url}{path}")
print(f"DEBUG: Content-Type: {request.headers.get('content-type', 'Not set')}")
print("DEBUG: Processing multipart/form-data request")
print(f"DEBUG: Body length: {len(body)} bytes")
print(f"DEBUG: Response status: {response.status_code}")
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 1. –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```bash
# –û—à–∏–±–∫–∞: Proxy error: The `python-multipart` library must be installed
{"detail":"Proxy error: The `python-multipart` library must be installed to use form parsing."}
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```bash
# –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
{"document_id":7,"filename":"test.txt","file_type":"txt","file_size":13,"pages_count":1,"category":"other","status":"completed","review_deadline":"2025-08-22T06:14:37.058679","document_stats":{...}}
```

### 2. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫

- ‚úÖ **Unexpected token '<'** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ **502 Bad Gateway** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ **upstream prematurely closed connection** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ **Proxy error: The `python-multipart` library must be installed** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ **Too little data for declared Content-Length** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 3. –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ multipart/form-data
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ boundary –≤ content-type
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- ‚úÖ –ü—Ä—è–º–æ–π –ø—Ä–æ–∫—Å–∏ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ multipart/form-data:

```
Frontend ‚Üí Nginx ‚Üí Gateway ‚Üí Document Parser
    ‚Üì         ‚Üì        ‚Üì           ‚Üì
Multipart ‚Üí Proxy ‚Üí Direct ‚Üí Process
```

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ python-multipart** - –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ multipart –≤ FastAPI
2. **–ü—Ä—è–º–æ–π –ø—Ä–æ–∫—Å–∏** - –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ content-type —Å boundary
4. **–û—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ API:

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
echo "Test content" > test.txt

# –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ API —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
curl -s -k -X POST -H "Authorization: Bearer test-token" \
  -F "file=@test.txt" https://localhost/api/upload/checkable

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "document_id": 7,
  "filename": "test.txt",
  "file_type": "txt",
  "file_size": 13,
  "pages_count": 1,
  "category": "other",
  "status": "completed",
  "review_deadline": "2025-08-22T06:14:37.058679",
  "document_stats": {...}
}
```

### 2. –¢–µ—Å—Ç —á–µ—Ä–µ–∑ frontend:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ frontend
docker logs ai-nk-frontend-1 --tail 10

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
"POST /api/upload/checkable HTTP/1.1" 200 303
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ gateway:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ gateway
docker logs ai-nk-gateway-1 --tail 10

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
DEBUG: Proxying POST request to http://document-parser:8001/upload/checkable
DEBUG: Content-Type: multipart/form-data; boundary=------------------------...
DEBUG: Processing multipart/form-data request
DEBUG: Body length: 211 bytes
DEBUG: Response status: 200
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ multipart/form-data
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ü—Ä—è–º–æ–π –ø—Ä–æ–∫—Å–∏ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö

### 3. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å document-parser

### 4. –û—Ç–ª–∞–¥–∫–∞
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –õ–µ–≥–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

- [ ] Gateway –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å python-multipart
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ API
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ frontend
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ "Unexpected token '<'"
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ 502 Bad Gateway
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ "python-multipart library must be installed"
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É multipart
- [ ] –í—Å–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:

1. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ multipart** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏

### –î–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤
2. **–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏** - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

- **–í—Ä–µ–º—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:** 15 –º–∏–Ω—É—Ç
- **–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 25 –º–∏–Ω—É—Ç
- **–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** 10 –º–∏–Ω—É—Ç
- **–û–±—â–µ–µ –≤—Ä–µ–º—è:** 50 –º–∏–Ω—É—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ multipart/form-data –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ frontend –∏ API.
